-- Workspace: SQLServer
-- Item: INDIGO036 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: SP_INV_GESTION_MIPRES_FACTURADOS
-- Extracted by Fabric SQL Extractor SPN v3.9.0














CREATE PROCEDURE [Report].[SP_INV_GESTION_MIPRES_FACTURADOS]
AS
/*
WITH 
CTE_NOPBS
----CTE PARA IDENTIFICAR LOS MEDICAMENTOS NO PBS Y UNIRS
AS
(
SELECT CODPRODUC,DESPRODUC,NOPOSPROD ,ATC.UNIRS  FROM IHLISTPRO IHL
LEFT JOIN Inventory .ATC AS ATC ON ATC.Code =IHL.CODPRODUC 
WHERE NOPOSPROD='1' OR ATC.UNIRS ='1' --AND CODPRODUC='2601040003'
),
CTE_INGRESOS_UNICOS
AS
---- CTE PARA IDENTIFICAR LOS INGRESOS UNICOS HOSPITALARIOS ACTIVOS
(
SELECT DISTINCT ING.NUMINGRES ,ING.IPCODPACI,ING.IESTADOIN
    FROM dbo.ADINGRESO ing
	WHERE ING.TIPOINGRE=2 AND  ING.IESTADOIN IN ('F')
),
CTE_SOLICITUDES
AS
(
   SELECT PRES.IPCODPACI,PRES.NUMINGRES,PRES.CODPRODUC, SUM(PRES.CANPEDPRO) CANTIDAD,LIS.DESPRODUC
   FROM HCPRESCRA PRES
   INNER JOIN CTE_INGRESOS_UNICOS AS ING ON ING.NUMINGRES =PRES.NUMINGRES AND ING.IPCODPACI =PRES.IPCODPACI  
   INNER JOIN IHLISTPRO LIS ON LIS.CODPRODUC=PRES.CODPRODUC
   INNER JOIN CTE_NOPBS NOP ON NOP.CODPRODUC=PRES.CODPRODUC
   --WHERE IPCODPACI='1010961013' AND  PRES.CODPRODUC = '2602020026'
   GROUP BY PRES.NUMINGRES,PRES.CODPRODUC, PRES.IPCODPACI,LIS.DESPRODUC
),
CTE_ENTREGAS
AS
(
SELECT DIS.AdmissionNumber,ING.IPCODPACI,PRO.Code,PRO.Name, sum(DET.Quantity)-sum(det.ReturnedQuantity ) 'CANTIDAD ENTREGADA'

FROM Inventory.PharmaceuticalDispensing DIS
INNER JOIN CTE_INGRESOS_UNICOS AS ING ON ING.NUMINGRES =DIS.AdmissionNumber 
INNER JOIN Inventory.PharmaceuticalDispensingDetail DET ON DET.PharmaceuticalDispensingId=DIS.Id
INNER JOIN Inventory.InventoryProduct PRO ON PRO.Id=DET.ProductId
INNER JOIN Inventory .ATC as atc on ATC.Id =PRO.ATCId 
INNER JOIN CTE_NOPBS NOPBS ON NOPBS.CODPRODUC =ATC.Code 
--INNER JOIN ADINGRESO ING ON ING.NUMINGRES=DIS.AdmissionNumber
--WHERE DIS.AdmissionNumber='13301' AND DET.ProductId='7243'

GROUP BY DIS.AdmissionNumber,ING.IPCODPACI,PRO.Name, PRO.Code
),
CTE_NO_POS
AS
(
  SELECT T.NUMINGRES,T.CODPRODUC ,  STUFF(
   (SELECT ', ' + NOPOS.CODMINSALUD
    FROM dbo.HCJUNOPOM NOPOS
	where NOPOS.NUMINGRES =T.NUMINGRES AND NOPOS.CODPRODUC =T.CODPRODUC 
    FOR XML PATH ('')),
	1,2, '') CODMINSALUD, SUM(T.CANPEDPRO ) CANTIDAD
   FROM dbo.HCJUNOPOM T
  --where NUMINGRES = '13301     ' and CODPRODUC = '2602020026'
  GROUP BY T.NUMINGRES ,T.CODPRODUC 
),
CTE_AUTORIZADOS
AS
(
  SELECT A.IPCODPACI 'IDENTIFICACION' ,A.NUMINGRES 'INGRESO' ,D.CODSERIPS AS 'Codigo CUPS', RTRIM(PRO.DESPRODUC) AS Servicio,CASE ESTATUSER WHEN '1' THEN 'Autorizado' 
  WHEN '2' THEN 'No Autorizado' WHEN '3' THEN 'Pendiente de Autorizacion' END AS Estado,
  SUM(D.CANSERAUT) AS 'Cantidad Autorizada'
  FROM dbo.ADAUTSERC A
  INNER JOIN dbo.SEGusuaru B ON A.CODUSUARI = B.CODUSUARI
  --INNER JOIN CTE_INGRESOS_UNICOS AS UNI ON A.NUMINGRES =UNI.NUMINGRES 
  INNER JOIN dbo.ADAUTSERD D ON D.CODCONCEC =A.CODCONCEC AND D.NUMINGRES =A.NUMINGRES 
  INNER JOIN dbo.IHLISTPRO PRO On D.CODSERIPS = PRO.CODPRODUC
  --WHERE A.IPCODPACI ='1031186635'
  WHERE ESTATUSER = '1' --AND D.NUMINGRES='13301' AND D.CODSERIPS ='2602020026'
  GROUP BY A.IPCODPACI,A.NUMINGRES,D.CODSERIPS,PRO.DESPRODUC,ESTATUSER
),
CTE_CAMAS_OCUPADA
--CTE PARA IDENTIFICAR LAS CAMAS ACTIVAS EN HOSPITALIZACION
AS
(
     SELECT DISTINCT FUN.UFUDESCRI 'UNIDAD FUNCIONAL' ,C.IPCODPACI 'IDENTIFICACION' ,C.NUMINGRES 'INGRESO',A.NUMCAMHOS 'CAMA',G.DESTIPEST 'TIPO ESTANCIA'  ,C.ID  'ID_ESTANCIA', 
	 A.CODICAMAS 'ID_CAMAS', CEN.NOMCENATE 'CENTRO DE ATENCION',A.CODCLAHAB ,A.CODCLACAM 
	 FROM dbo.CHCAMASHO A with (nolock)
	 INNER JOIN DBO.INUNIFUNC AS FUN with (nolock) ON A.UFUCODIGO =FUN.UFUCODIGO 
     INNER JOIN dbo.CHREGESTA C with (nolock) ON A.CODICAMAS=C.CODICAMAS AND C.REGESTADO = 1 
     INNER JOIN dbo.CHTIPESTA G with (nolock) ON G.CODTIPEST=C.CODTIPEST 
	 INNER JOIN DBO.ADCENATEN AS CEN with (nolock) ON CEN.CODCENATE =A.CODCENATE 
	 INNER JOIN CTE_INGRESOS_UNICOS AS ING with (nolock) ON ING.NUMINGRES =C.NUMINGRES 
)

--SELECT * FROM CTE_AUTORIZADOS 
SELECT DISTINCT HA.NAME 'ENTIDAD', 
CASE PAC.IPTIPODOC 	WHEN '1' THEN 'CC' WHEN '2' THEN 'CE' WHEN '3' THEN 'TI' WHEN '4' THEN 'RC'	WHEN '5' THEN 'PA'	WHEN '6' THEN 'AS'WHEN '7' THEN 'MS'	
WHEN '8' THEN 'NU'	WHEN '9' THEN 'CN'	WHEN '10' THEN 'CD'	WHEN '11' THEN 'SC' WHEN '12' THEN 'PE' WHEN '13' THEN 'PT'WHEN '14' THEN 'DE'WHEN '15' THEN 'SI'
ELSE 'N/A'END 'TIPO DOCUMENTO',SOL.IPCODPACI 'IDENTIFICACION',PAC.IPNOMCOMP 'NOMBRE PACIENTE' ,SOL.NUMINGRES 'INGRESO' ,SOL.CODPRODUC 'CODIGO MEDICAMENTO SOLICITADO',
SOL.DESPRODUC 'MEDICAMENTO SOLICITADO',SOL.CANTIDAD 'CANTIDAD HC',NPBS1.CANTIDAD  [CANTIDAD NO PBS] ,NPBS1.CODMINSALUD 'CODIGO MIPRES',AUT.[Cantidad Autorizada] 'CANTIDAD AUTORIZADA',
AUT.Estado 'ESTADO' ,ENT.[CANTIDAD ENTREGADA],ING.IESTADOIN 'ESTADO INGRESO',
ISNULL(AUT.[Cantidad Autorizada],0)-ISNULL(ENT.[CANTIDAD ENTREGADA],0) 'AUTORIZADA-ENTREGADA',ISNULL(CAM.CAMA,' ') 'CAMA HOSPITALIZACION',
ISNULL(CAM.[UNIDAD FUNCIONAL],'')  'UNIDAD FUNCIONAL',CAST(ING.IFECHAING AS DATE) 'FECHA INGRESO',CAST(ing.FECHEGRESO AS DATE) 'FECHA EGRESO'
FROM CTE_SOLICITUDES SOL
INNER JOIN INPACIENT PAC ON PAC.IPCODPACI=SOL.IPCODPACI
INNER JOIN DBO.ADINGRESO AS ING ON ING.NUMINGRES =SOL.NUMINGRES 
INNER JOIN Contract .HealthAdministrator AS HA ON HA.Id =ING.GENCONENTITY 
LEFT JOIN CTE_ENTREGAS ENT ON SOL.NUMINGRES=ENT.AdmissionNumber AND ENT.Code=SOL.CODPRODUC 
LEFT JOIN CTE_NO_POS NPBS1 ON NPBS1.NUMINGRES=SOL.NUMINGRES AND NPBS1.CODPRODUC=SOL.CODPRODUC 
LEFT JOIN CTE_AUTORIZADOS AUT ON AUT.INGRESO =SOL.NUMINGRES AND AUT.[Codigo CUPS] =SOL.CODPRODUC 
LEFT JOIN CTE_CAMAS_OCUPADA AS CAM ON CAM.INGRESO =SOL.NUMINGRES 
--WHERE SOL.IPCODPACI IN ('1031186635','1116879358')
ORDER BY SOL.NUMINGRES 

*/

WITH 
CTE_MEDICAMENTOS
----CTE PARA IDENTIFICAR LOS MEDICAMENTOS
AS
(
SELECT 
IHL.CODPRODUC,
IHL.DESPRODUC,
CASE IHL.NOPOSPROD WHEN 0 THEN 'SI' ELSE 'NO' END AS PBS,
CASE ATC.UNIRS WHEN 1 THEN 'SI' ELSE 'NO' END AS UNIRS
FROM IHLISTPRO IHL
INNER JOIN Inventory.ATC AS ATC ON ATC.Code =IHL.CODPRODUC 
WHERE IHL.CODPRODUC IN ('1102010018','1103060008','1103230010','1103230014','1103230017','1103230018','1103230022','1103230024','1103230025',
'1103230027','1103230028','1103230029','1103230030','1103230031','1103230032','1103230033','1103230034','1103240020','1103240030','1103250010',
'1105030002','1105030003','1105030004','1105030006','1105030007','1105120012','1105120013','1105120030','1105120031','1105120032','1105120033',
'1105120036','1105120038','1105120053','1105120055','1105120056','1105120066','1105120071','1105120073','1105120075','1105120077','1105120082',
'1105120083','1105120090','1105120107','1105120111','1109020007','1112010105','1112010135','1112010168','1112010170','1115010019','1115020002',
'1115020004','1115020007','1115020010','1115020012','1115040007','1117010003','1118040020','1118080088','1118080095','1118080112','1118090003',
'1118090014','1119010024','1120020010','1120020017','1120020018','1120020023','1120020024','1120020037','1120030002','1120030005','1120030007',
'1120050011','1120050021','1120050023','1120050025','1121140050','1121140051','1121140057','2601020007','2601040002','2601040003','2602010006',
'2602010010','2602010013','2602010014','2602010015','2602010017','2602010019','2602020005','2602020007','2602020009','2602020013','2602020014',
'2602020018','2602020019','2602020022','2602020025','2602020026','2602020031','2602020028-1','2602020035','1119010014','1119060023','1118040009',
'1105120056','1105120027','1120020038','1120020005-1','1120050014','1120050029','1120020005', '2602020034','2602020037','1105120064','1105120045',
'2602020039','1105120075','2602010021','2602010020','1105120012','1105120013','1105120024','1105120025','1105120026','1105120030','1105120031',   
'1105120032','1105120036','1105120038','1105120045','1105120049','1105120065','1105120066','1105120089','1105120093','1105120094','1105120106',   
'1105120045-1','1120030011','1105120064','1105120125','1105120004','1105120011','1105120019','1105120021','1105120095','1105120034','1105120050',
'1105120118','1118080117','260103003')
),
CTE_INGRESOS_UNICOS
AS
---- CTE PARA IDENTIFICAR LOS INGRESOS UNICOS HOSPITALARIOS ACTIVOS
(
SELECT
ING.IPCODPACI,
ING.NUMINGRES ,
ING.GENCONENTITY,
ING.IESTADOIN,
ING.IFECHAING,
ING.FECHEGRESO
FROM dbo.ADINGRESO ing
WHERE ING.TIPOINGRE=2 AND ING.IESTADOIN='F'
),

CTE_AUTORIZACIONES AS
(
SELECT
AU.NUMINGRES,
AU.CODSERIPS,
SUM(AU.CANSERAUT) AS CANSERAUT
FROM
dbo.ADAUTSERD AU
INNER JOIN CTE_MEDICAMENTOS MED ON AU.CODSERIPS=MED.CODPRODUC
WHERE ESTATUSER=1 
GROUP BY AU.NUMINGRES,AU.CODSERIPS
),
CTE_DISPENSACION AS
(
SELECT
D.CODPRODUC,
D.NUMINGRES,
SUM(DISD.Quantity) AS CANTIDAD
FROM
dbo.HCFARMEPD D
INNER JOIN Inventory.PharmaceuticalDispensingDetail DISD ON D.ID=DISD.EntityId AND EntityName='HCFARMEPD'
INNER JOIN CTE_MEDICAMENTOS MED ON D.CODPRODUC=MED.CODPRODUC
WHERE SourceTable='HCPRESCRA'
GROUP BY D.CODPRODUC,D.NUMINGRES
),
CTE_ORDENAMIENTO AS
(
SELECT 
PRES.NUMINGRES,
PRES.CODPRODUC,
MED.PBS,
MED.UNIRS,
MED.DESPRODUC,
MAX(PRES.NUMEFOLIO) AS NUMEFOLIO,
SUM(PRES.CANPEDPRO) AS CANPEDPRO
FROM
dbo.HCPRESCRA PRES
INNER JOIN CTE_MEDICAMENTOS MED ON PRES.CODPRODUC=MED.CODPRODUC
GROUP BY PRES.NUMINGRES,PRES.CODPRODUC,MED.PBS,MED.UNIRS,MED.DESPRODUC
),

CTE_JUSTIFICACION AS
(
SELECT
PB.NUMINGRES,
PB.CODPRODUC,
JUS.CODMINSALUD,
SUM(PB.CANPEDPRO) AS CANPEDPRO
FROM
CTE_MEDICAMENTOS MED
INNER JOIN dbo.HCJUNOPOM PB ON MED.CODPRODUC=PB.CODPRODUC
INNER JOIN CTE_INGRESOS_UNICOS ING ON PB.NUMINGRES=ING.NUMINGRES
LEFT JOIN (SELECT MAX(B.NUMEFOLIO) AS NUMEFOLIO,B.NUMINGRES,B.CODPRODUC,B.CODMINSALUD 
		   FROM dbo.HCJUNOPOM B
		   INNER JOIN (SELECT A.NUMINGRES,A.CODPRODUC,MAX(CODCONCEC) AS CODCONCEC 
					   FROM dbo.HCJUNOPOM A
					   GROUP BY A.NUMINGRES,A.CODPRODUC) C ON B.CODCONCEC=C.CODCONCEC
		   GROUP BY B.NUMINGRES,B.CODPRODUC,B.CODMINSALUD) JUS ON PB.NUMINGRES=JUS.NUMINGRES AND PB.CODPRODUC=JUS.CODPRODUC
GROUP BY PB.NUMINGRES,PB.CODPRODUC,JUS.CODMINSALUD
)


SELECT 
HA.[NAME] AS [ENTIDAD],
TDOC.SIGLA,
PAC.IPCODPACI AS [IDENTIFICACION],
PAC.IPNOMCOMP AS [NOMBRE PACIENTE],
PRES.NUMINGRES AS INGRESO,
PRES.NUMEFOLIO AS [FOLIO ORDEN],
HC.FECHISPAC AS [FECHA ORDEN],
PRES.CODPRODUC AS [CODIGO MEDICAMENTO SOLICITADO],
PRES.DESPRODUC AS [MEDICAMENTO SOLICITADO],
PRES.CANPEDPRO AS [CANTIDAD SOLICITADO],
PB.CANPEDPRO AS [CANTIDAD NO PBS],
PB.CODMINSALUD AS [CODIGO MIPRES],
AU.CANSERAUT AS [CANTIDAD AUTORIZADO],
CASE WHEN AU.CANSERAUT IS NULL THEN NULL ELSE 'AUTORIZADO' END AS [ESTADO AUTORIZADO],
ISNULL(DIS.CANTIDAD,0) AS [CANTIDAD DISPENSADA],
ING.IESTADOIN AS [ESTADO INGRESO],
ISNULL(AU.CANSERAUT,0)-ISNULL(DIS.CANTIDAD,0) AS [CANTIDAD AUTORIZADA VS DISPENSADA],
ISNULL(PRES.CANPEDPRO,0)-ISNULL(DIS.CANTIDAD,0) AS [CANTIDAD SOICITADA VS DISPENSADA],
PRES.PBS,
PRES.UNIRS,
FUN.UFUDESCRI AS [UNIDAD FUNCIONAL],
ING.IFECHAING AS [FECHA INGRESO],
ING.FECHEGRESO AS [FECHA EGRESO]
FROM
CTE_ORDENAMIENTO PRES
INNER JOIN CTE_INGRESOS_UNICOS ING ON PRES.NUMINGRES=ING.NUMINGRES
INNER JOIN Contract.HealthAdministrator HA ON ING.GENCONENTITY=HA.ID
INNER JOIN dbo.INPACIENT PAC ON ING.IPCODPACI=PAC.IPCODPACI
INNER JOIN dbo.ADTIPOIDENTIFICA TDOC ON PAC.IPTIPODOC=TDOC.CODIGO
INNER JOIN dbo.HCHISPACA HC ON PRES.NUMINGRES=HC.NUMINGRES AND PRES.NUMEFOLIO=HC.NUMEFOLIO
INNER JOIN dbo.INUNIFUNC FUN ON HC.UFUCODIGO=FUN.UFUCODIGO
LEFT JOIN CTE_AUTORIZACIONES AU ON PRES.NUMINGRES=AU.NUMINGRES AND PRES.CODPRODUC=AU.CODSERIPS
LEFT JOIN CTE_JUSTIFICACION PB ON PRES.NUMINGRES=PB.NUMINGRES AND PRES.CODPRODUC=PB.CODPRODUC
LEFT JOIN CTE_DISPENSACION DIS ON PRES.NUMINGRES=DIS.NUMINGRES AND DIS.CODPRODUC=PRES.CODPRODUC

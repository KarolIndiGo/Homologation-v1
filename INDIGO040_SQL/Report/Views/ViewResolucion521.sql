-- Workspace: SQLServer
-- Item: INDIGO040 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: ViewResolucion521
-- Extracted by Fabric SQL Extractor SPN v3.9.0






CREATE VIEW [Report].[ViewResolucion521] as

/*
INDIGO006
INDIGO007
INDIGO008
INDIGO009
INDIGO010
INDIGO01
INDIGO013
INDIGO014
INDIGO015
*/

WITH CTE_PACIENTES AS (
 SELECT 
  HIS.IPCODPACI, 
  max(HIS.NUMINGRES) NUMINGRES,
  ING.CODCENATE,
  MAX(ING.GENCONENTITY) as GENCONENTITY,
  max(CODDIAGNO) as CODDIAGNO, 
  MONTH(CAST(HIS.FECHISPAC as DATE)) as M_FECHISPAC, 
  YEAR(CAST(HIS.FECHISPAC as DATE)) as A_FECHISPAC, 
  MAX(CAST(HIS.FECHISPAC as DATE)) as FECHISPAC
 FROM 
  ADINGRESO AS ING 
  LEFT JOIN HCHISPACA HIS ON HIS.NUMINGRES =ING.NUMINGRES -- INFORMACION DEL INGRESO
  LEFT JOIN INUNIFUNC UNI ON HIS.UFUCODIGO =UNI.UFUCODIGO ---INFORMACION UNIDAD FUNCIONAL SOLO CONSULTA EXTERNA
 WHERE 
  HIS.GENCONEXT = 1 AND 
  HIS.TIPHISPAC = 'I' AND 
  CAST(HIS.FECHISPAC AS DATE) BETWEEN CAST(DATEADD(m,-90,GETDATE()) AS DATE) AND CAST(GETDATE() AS DATE)
 GROUP BY 
  HIS.IPCODPACI,
  ING.CODCENATE,  
  MONTH(CAST(HIS.FECHISPAC as DATE)), 
  YEAR(CAST(HIS.FECHISPAC as DATE)) 
 ),

CTE_HTA AS
 (
  SELECT 
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('I10X','I150','I151','I152','I158','I159','I270','I272','K766','O100','O104','O13X','O16X','P292')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
),

CTE_DM AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('E100','E101','E102','E103','E104','E105','E106','E107','E108','E109','E110','E111','E112','E113','E114','E115','E116','E117','E118','E119','E120',
                 'E121','E122','E123','E124','E125','E126','E127','E128','E129','E130','E131','E132','E133','E134','E135','E136','E137','E138','E139','E140','E141',
				 'E142','E143','E144','E145','E146','E147','E148','E149')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
 ),

CTE_RENAL AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('N181','N182','N183','N184','N185','N188','N189')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
 ),

CTE_CANCER AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('C000','C001','C002','C003','C004','C005','C006','C008','C010','C01X','C020','C021','C022','C023','C024','C028','C029','C030','C031','C039','C040',
                 'C041','C048','C049','C050','C051','C052','C058','C059','C060','C061','C062','C068','C069','C07X','C080','C081','C088','C089','C090','C091','C098',
				 'C099','C100','C101','C102','C103','C104','C108','C109','C110','C111','C112','C113','C118','C119','C12X','C130','C131','C132','C138','C139','C140',
				 'C142','C148','C150','C151','C152','C153','C154','C155','C158','C159','C160','C161','C162','C163','C164','C165','C166','C168','C169','C170','C171',
				 'C172','C173','C178','C179','C180','C181','C182','C183','C184','C185','C186','C187','C188','C189','C19X','C20X','C210','C211','C212','C218','C220',
				 'C221','C222','C223','C224','C227','C229','C23X','C240','C241','C248','C249','C250','C251','C252','C253','C254','C257','C258','C259','C260','C261',
				 'C268','C269','C300','C301','C310','C311','C312','C313','C318','C319','C320','C321','C322','C323','C328','C329','C33X','C340','C341','C342','C343',
				 'C348','C349','C37X','C380','C381','C382','C383','C384','C388','C390','C398','C399','C400','C401','C403','C408','C409','C410','C411','C412','C413',
				 'C414','C418','C419','C430','C431','C432','C433','C434','C435','C436','C437','C438','C439','C440','C441','C442','C443','C444','C445','C446','C447',
				 'C448','C449','C450','C451','C452','C457','C459','C460','C461','C462','C463','C467','C468','C469','C470','C471','C472','C473','C474','C475','C476',
				 'C478','C479','C480','C481','C482','C488','C490','C491','C492','C493','C494','C495','C496','C498','C499','C500','C501','C502','C503','C504','C505',
				 'C506','C508','C509','C510','C511','C512','C518','C519','C52X','C530','C531','C538','C539','C540','C541','C542','C543','C548','C549','C55X','C56X',
				 'C570','C571','C572','C573','C574','C577','C578','C579','C58X','C600','C601','C602','C608','C609','C61X','C620','C621','C629','C630','C631','C632',
				 'C637','C638','C639','C64X','C65X','C66X','C670','C671','C672','C673','C674','C675','C676','C677','C678','C679','C680','C681','C688','C689','C690',
				 'C691','C692','C693','C694','C695','C696','C698','C699','C700','C701','C709','C710','C711','C712','C713','C714','C715','C716','C717','C718','C719',
				 'C720','C721','C722','C723','C724','C725','C728','C729','C73X','C740','C741','C749','C750','C751','C752','C753','C754','C755','C758','C759','C760',
				 'C761','C762','C763','C764','C765','C767','C768','C770','C771','C772','C773','C774','C775','C778','C779','C780','C781','C782','C783','C784','C785',
				 'C786','C787','C788','C790','C791','C792','C793','C794','C795','C796','C797','C798','C799','C800','C809','C80X','C810','C811','C812','C813','C814',
				 'C817','C819','C820','C821','C822','C823','C824','C825','C826','C827','C829','C830','C831','C832','C833','C834','C835','C836','C837','C838','C839',
				 'C840','C841','C842','C843','C844','C845','C846','C847','C848','C849','C850','C851','C852','C857','C859','C860','C861','C862','C863','C864','C865',
				 'C866','C880','C881','C882','C883','C884','C887','C889','C900','C901','C902','C903','C910','C911','C912','C913','C914','C915','C916','C917','C918',
				 'C919','C920','C921','C922','C923','C924','C925','C926','C927','C928','C929','C930','C931','C932','C933','C937','C939','C940','C941','C942','C943',
				 'C944','C945','C946','C947','C950','C951','C952','C957','C959','C960','C961','C962','C963','C964','C965','C966','C967','C968','C969','C97X','D000',
				 'D001','D002','D010','D011','D012','D013','D014','D015','D017','D019','D020','D021','D022','D023','D024','D030','D031','D032','D033','D034','D035',
				 'D036','D037','D038','D039','D040','D041','D042','D043','D044','D045','D046','D047','D048','D049','D050','D051','D057','D059','D060','D061','D067',
				 'D069','D070','D071','D072','D073','D074','D075','D076','D090','D091','D092','D093','D097','D099','D100','D101','D102','D103','D104','D105','D106',
				 'D107','D109','D110','D117','D119','D120','D121','D122','D123','D124','D125','D126','D127','D128','D129','D130','D131','D132','D133','D134','D135',
				 'D136','D137','D139','D140','D141','D142','D143','D144','D150','D151','D152','D157','D159','D160','D161','D162','D163','D164','D165','D166','D167',
				 'D168','D169','D170','D171','D172','D173','D174','D175','D176','D177','D179','D181','D190','D191','D197','D199','D200','D201','D210','D211','D212',
				 'D213','D214','D215','D216','D219','D220','D221','D222','D223','D224','D225','D226','D227','D229','D230','D231','D232','D233','D234','D235','D236',
				 'D237','D239','D24X','D250','D251','D252','D259','D260','D261','D267','D269','D27X','D280','D281','D282','D287','D289','D290','D291','D292','D293',
				 'D294','D297','D299','D300','D301','D302','D303','D304','D307','D309','D310','D311','D312','D313','D314','D315','D316','D319','D320','D321','D329',
				 'D330','D331','D332','D333','D334','D337','D339','D34X','D350','D351','D352','D353','D354','D355','D356','D357','D358','D359','D360','D361','D367',
				 'D369','D370','D371','D372','D373','D374','D375','D376','D377','D379','D380','D381','D382','D383','D384','D385','D386','D390','D391','D392','D397',
				 'D399','D400','D401','D407','D409','D410','D411','D412','D413','D414','D417','D419','D420','D421','D429','D430','D431','D432','D433','D434','D437',
				 'D439','D440','D441','D442','D443','D444','D445','D446','D447','D448','D449','D45X','D460','D461','D462','D463','D464','D465','D466','D467','D469',
				 'D470','D471','D472','D473','D474','D475','D477','D480','D481','D482','D483','D484','D485','D486','D487','D489','D500','D501','D509','D512','D520',
				 'D521','D528','D529','D531','D532','D538','D539','D550','D558','D559','D562','D563','D564','D568','D569','D570','D571','D572','D573','D578','D580',
				 'D581','D588','D591','D593','D594','D595','D596','D598','D599','D600','D601','D608','D609','D611','D612','D613','D618','D619','D62X','D630','D638',
				 'D641','D642','D643','D648','D649','D65X','D66X','D67X','D680','D681','D682','D683','D684','D685','D686','D688','D689','D691','D694','D695','D696',
				 'D698','D699','D70X','D71X','D720','D721','D728','D729','D730','D731','D732','D733','D734','D735','D738','D739','D740','D748','D749','D750','D751',
				 'D752','D758','D759','D760','D761','D762','D763','D77X','D801','D802','D803','D804','D805','D806','D807','D808','D809','D810','D812','D813','D814',
				 'D815','D816','D817','D818','D819','D820','D821','D823','D828','D829','D830','D831','D832','D838','D839','D840','D848','D849','D860','D861','D862',
				 'D863','D868','D869','D890','D891','D892','D893','D898','D899')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
 ),

CTE_AUTOINMUNES AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('D589','D590','D592','D690','D692','D693','N002','N012','N022','N032','N042','N052','N062','N072','L100','I00X','D510','D511','D513','D518','D519',
                 'M052','M320','M321','M328','M329','M300','D891','T806','T805','G611','M053','M058','M059','M060','M068','M069','M080','G35X','G610')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
 ),

CTE_ARTRITIS AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('E790','M000','M001','M002','M008','M010','M010','M012','M013','M014','M015','M016','M018','M030','M071','M082','M083','M084','M088','M089','M090',
                 'M091','M092','M098','M130','M131','M138','M139','M143','M772')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
),

CTE_VIH AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('B200','B201','B202','B203','B204','B205','B206','B207','B208','B209','B210','B211','B212','B213','B217','B218','B219','B220','B221','B222','B227',
                 'B230','B231','B232','B238','B24X','O987','R75X','Z21X')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
 ),

CTE_HUERFANAS AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('Q878','E711','Q870','Q395','K220','E803','G230','E723','E711','E713','E721','D551','E728','E722','E888','D530','E770','E774','Q688','Q758','E832',
                 'Q785','H535','E220','M894','L814','M895','C402','Q828','Q934','D610','D824','Q872','G231','D800','G600','G114','Q991','Q450','Q321','H905','E702',
				 'E703','D560','E771','D479','H355','B601','Q730','E853','Q743','R770','D582','D644','D552','D553','D508','D640','Q000','Q078','Q383','T783','D841',
				 'D180','Q278','E881','Q131','G110','B810','Q043','Q112','Q188','Q248','Q288','Q798','E310','Q848','Q738','D610','P284','H518','Q748','A281','D811',
				 'Q301','L958','M316','M082','M081','Q897','Q890','G318','G112','G111','G118','E798','G113','Q788','Q775','E031','E880','Q442','Q300','Q419','Q410',
				 'Q224','G118','G903','G128','G120','G121','H472','H312','L908','Q875','Q858', 'D822','Q798','D561','Q158','H538','Q750','Q431','G938','G238','E850',
				 'Q873','Q681','I422','I425')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
 ),

CTE_GESTANTE AS
 (
  SELECT 
   GEST.IPCODPACI,
   MONTH(CAST(GEST.FECGESTA as DATE)) M_FECGESTA, 
   YEAR(CAST(GEST.FECGESTA as DATE)) A_FECGESTA
  FROM 
   HCRIESGOSP GEST 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = GEST.IPCODPACI 
  WHERE 
   GEST.GESTACION = 1
  GROUP BY
   GEST.IPCODPACI,
   MONTH(CAST(GEST.FECGESTA as DATE)), 
   YEAR(CAST(GEST.FECGESTA as DATE))
),

CTE_TUBERCULOSIS_RESISTENTE AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('U843')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
 ),

CTE_ESPONDILOPATIA AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('G552','M430','M431','M465','M468','M469','M471','M472','M478','M479','M482','M483','M488','M489','M493','M494','M498','Q762','Q777')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
 ),

CTE_LUPUS AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODPROEGR IN ('M320','M321','M328','M329')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
 ),

CTE_TRAS_COAGULACION AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('M362','D65X','D682','D683','D684','D688','D689','O460','O670','O723','P60X','P616','Y443','D510','D66X','D67X','D681','D682','D684')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
 ),

CTE_HEPATITIS_C AS
 (
  SELECT
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)) M_IFECHAING, 
   YEAR(CAST(ING.IFECHAING as DATE)) A_IFECHAING
  FROM 
   ADINGRESO ING 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI
  WHERE
   CODDIAEGR IN ('B171','B182')
  GROUP BY
   ING.IPCODPACI,
   MONTH(CAST(ING.IFECHAING as DATE)), 
   YEAR(CAST(ING.IFECHAING as DATE))
 ),

CTE_LLAMADAS_GENERAL AS
 (
  SELECT 
   CIT.IPCODPACI,
   MONTH(CAST(CIT.FECHORAIN as DATE)) M_FECHORAIN, 
   YEAR(CAST(CIT.FECHORAIN as DATE)) A_FECHORAIN,
   COUNT(*) AS 'CANTIDAD'
  FROM 
   AGASICITA CIT
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = CIT.IPCODPACI AND CIT.CODESPECI='002' AND MONTH(CAST(CIT.FECHORAIN as DATE)) = CTE.M_FECHISPAC AND YEAR(CAST(CIT.FECHORAIN as DATE)) = CTE.A_FECHISPAC 
  WHERE 
   CIT.TIPSOLICITU = 1 and 
   CIT.CODESTCIT <>'4' and
   CIT.CODTIPSOL = '1' 
  GROUP BY
   CIT.IPCODPACI,
   MONTH(CAST(CIT.FECHORAIN as DATE)), 
   YEAR(CAST(CIT.FECHORAIN as DATE))
 ),

CTE_LLAMADAS_SM AS
 (
  SELECT 
   CIT.IPCODPACI,
   MONTH(CAST(CIT.FECHORAIN as DATE)) M_FECHORAIN, 
   YEAR(CAST(CIT.FECHORAIN as DATE)) A_FECHORAIN,
   COUNT(*) AS 'CANTIDAD'
  FROM 
   AGASICITA CIT
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = CIT.IPCODPACI AND CIT.CODESPECI IN ('112','115','184') AND MONTH(CAST(CIT.FECHORAIN as DATE)) = CTE.M_FECHISPAC AND YEAR(CAST(CIT.FECHORAIN as DATE)) = CTE.A_FECHISPAC 
  WHERE 
   CIT.TIPSOLICITU = 1 and 
   CIT.CODESTCIT <>'4' and 
   CIT.CODTIPSOL = '1' 
  GROUP BY 
   CIT.IPCODPACI,
   MONTH(CAST(CIT.FECHORAIN as DATE)), 
   YEAR(CAST(CIT.FECHORAIN as DATE))
),

CTE_LLAMADAS_ODONTOLOGIA AS
 (
  SELECT 
   CIT.IPCODPACI,
   MONTH(CAST(CIT.FECHORAIN as DATE)) M_FECHORAIN, 
   YEAR(CAST(CIT.FECHORAIN as DATE)) A_FECHORAIN,
   COUNT(*) AS 'CANTIDAD'
  FROM 
   AGASICITA CIT
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = CIT.IPCODPACI AND MONTH(CAST(CIT.FECHORAIN as DATE)) = CTE.M_FECHISPAC AND YEAR(CAST(CIT.FECHORAIN as DATE)) = CTE.A_FECHISPAC AND
                                  CIT.CODESPECI IN ('047','067','070','074','075','092','093','116','117','118','119','120','127','128','139','144','145','146','147','148','149','150','161','174','351','352')
  WHERE 
   CIT.TIPSOLICITU = 1 and 
   CIT.CODESTCIT <>'4' and 
   CIT.CODTIPSOL = '1' 
  GROUP BY 
   CIT.IPCODPACI,
   MONTH(CAST(CIT.FECHORAIN as DATE)), 
   YEAR(CAST(CIT.FECHORAIN as DATE))
),

CTE_ATEN_AUXI AS
 (
  SELECT
   URG.IPCODPACI,
   URG.M_FECHORAIN M_FECHORAIN, 
   URG.A_FECHORAIN A_FECHORAIN,
   SUM(URG.CANTIDAD) AS 'CANTIDAD'
  FROM
   (SELECT 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)) M_FECHORAIN, 
     YEAR(CAST(URG.FECINIATE as DATE)) A_FECHORAIN,
     COUNT(DISTINCT URG.NUMINGRES) AS 'CANTIDAD'
    FROM 
     HCURGING1 AS URG
     INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = URG.IPCODPACI AND URG.CODESPTRA IN ('195') AND 
	            MONTH(CAST(URG.FECINIATE as DATE)) = CTE.M_FECHISPAC AND YEAR(CAST(URG.FECINIATE as DATE)) = CTE.A_FECHISPAC
     INNER JOIN HCHISPACA AS HIS ON URG.IDETIPHIS = HIS.IDETIPHIS AND URG.IPCODPACI = HIS.IPCODPACI AND URG.NUMINGRES = HIS.NUMINGRES AND HIS.NUMEFOLIO = URG.NUMEFOLIO
    WHERE 
     (HIS.GENCONEXT = 1) AND 
     (HIS.TIPHISPAC = 'I')
    GROUP BY 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)), 
     YEAR(CAST(URG.FECINIATE as DATE))
    UNION ALL
    SELECT 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)) M_FECHORAIN, 
     YEAR(CAST(URG.FECINIATE as DATE)) A_FECHORAIN,
     COUNT(DISTINCT URG.NUMINGRES) AS 'CANTIDAD'
    FROM 
     HCNOTEVO1 AS URG
     INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = URG.IPCODPACI AND URG.CODESPTRA IN ('195') AND MONTH(CAST(URG.FECINIATE as DATE)) = CTE.M_FECHISPAC AND YEAR(CAST(URG.FECINIATE as DATE)) = CTE.A_FECHISPAC
     INNER JOIN HCHISPACA AS HIS ON URG.IDETIPHIS = HIS.IDETIPHIS AND URG.IPCODPACI = HIS.IPCODPACI AND URG.NUMINGRES = HIS.NUMINGRES AND HIS.NUMEFOLIO = URG.NUMEFOLIO
    GROUP BY 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)), 
     YEAR(CAST(URG.FECINIATE as DATE))
   ) URG
  GROUP BY 
   URG.IPCODPACI,
   URG.M_FECHORAIN, 
   URG.A_FECHORAIN
 ),

CTE_ATEN_ENF AS
 (
  SELECT
   URG.IPCODPACI,
   URG.M_FECHORAIN M_FECHORAIN, 
   URG.A_FECHORAIN A_FECHORAIN,
   SUM(URG.CANTIDAD) AS 'CANTIDAD'
  FROM
   (SELECT 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)) M_FECHORAIN, 
     YEAR(CAST(URG.FECINIATE as DATE)) A_FECHORAIN,
     COUNT(*) AS 'CANTIDAD'
    FROM 
     HCURGING1 AS URG
     INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = URG.IPCODPACI AND MONTH(CAST(URG.FECINIATE as DATE)) = CTE.M_FECHISPAC AND YEAR(CAST(URG.FECINIATE as DATE)) = CTE.A_FECHISPAC
	            AND URG.CODESPTRA IN ('010','011','012','013','014','015','016','017','019','020','021','022','023','024','025','026','027','028','060','159','190') 
     INNER JOIN HCHISPACA AS HIS ON URG.IDETIPHIS = HIS.IDETIPHIS AND URG.IPCODPACI = HIS.IPCODPACI AND URG.NUMINGRES = HIS.NUMINGRES AND HIS.NUMEFOLIO = URG.NUMEFOLIO
    WHERE 
     (HIS.GENCONEXT = 1) AND 
     (HIS.TIPHISPAC = 'I')
    GROUP BY 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)), 
     YEAR(CAST(URG.FECINIATE as DATE))
    UNION ALL
    SELECT 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)) M_FECHORAIN, 
     YEAR(CAST(URG.FECINIATE as DATE)) A_FECHORAIN,
     COUNT(*) AS 'CANTIDAD'
    FROM 
     HCNOTEVO1 AS URG
     INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = URG.IPCODPACI AND MONTH(CAST(URG.FECINIATE as DATE)) = CTE.M_FECHISPAC AND YEAR(CAST(URG.FECINIATE as DATE)) = CTE.A_FECHISPAC
	                                 AND URG.CODESPTRA IN ('010','011','012','013','014','015','016','017','019','020','021','022','023','024','025','026','027','028','060','159','190') 
     INNER JOIN HCHISPACA AS HIS ON URG.IDETIPHIS = HIS.IDETIPHIS AND URG.IPCODPACI = HIS.IPCODPACI AND URG.NUMINGRES = HIS.NUMINGRES AND HIS.NUMEFOLIO = URG.NUMEFOLIO
    GROUP BY 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)), 
     YEAR(CAST(URG.FECINIATE as DATE))
   ) URG
  GROUP BY 
    URG.IPCODPACI,
    URG.M_FECHORAIN, 
    URG.A_FECHORAIN
 ),

CTE_ATEN_GENERAL AS
 (
  SELECT
   URG.IPCODPACI,
   URG.M_FECHORAIN M_FECHORAIN, 
   URG.A_FECHORAIN A_FECHORAIN,
   SUM(URG.CANTIDAD) AS 'CANTIDAD'
  FROM
   (SELECT 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)) M_FECHORAIN, 
     YEAR(CAST(URG.FECINIATE as DATE)) A_FECHORAIN,
     COUNT(DISTINCT URG.NUMINGRES) AS 'CANTIDAD'
    FROM 
     HCURGING1 AS URG
     INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = URG.IPCODPACI AND URG.CODESPTRA IN ('002') AND MONTH(CAST(URG.FECINIATE as DATE)) = CTE.M_FECHISPAC AND YEAR(CAST(URG.FECINIATE as DATE)) = CTE.A_FECHISPAC
     INNER JOIN HCHISPACA AS HIS ON URG.IDETIPHIS = HIS.IDETIPHIS AND URG.IPCODPACI = HIS.IPCODPACI AND URG.NUMINGRES = HIS.NUMINGRES AND HIS.NUMEFOLIO = URG.NUMEFOLIO
    WHERE 
     (HIS.GENCONEXT = 1) AND 
     (HIS.TIPHISPAC = 'I')
    GROUP BY 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)), 
     YEAR(CAST(URG.FECINIATE as DATE))
    UNION ALL
    SELECT 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)) M_FECHORAIN, 
     YEAR(CAST(URG.FECINIATE as DATE)) A_FECHORAIN,
     COUNT(DISTINCT URG.NUMINGRES) AS 'CANTIDAD'
    FROM 
     HCNOTEVO1 AS URG
     INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = URG.IPCODPACI AND URG.CODESPTRA IN ('002') AND MONTH(CAST(URG.FECINIATE as DATE)) = CTE.M_FECHISPAC AND YEAR(CAST(URG.FECINIATE as DATE)) = CTE.A_FECHISPAC
     INNER JOIN HCHISPACA AS HIS ON URG.IDETIPHIS = HIS.IDETIPHIS AND URG.IPCODPACI = HIS.IPCODPACI AND URG.NUMINGRES = HIS.NUMINGRES AND HIS.NUMEFOLIO = URG.NUMEFOLIO
    GROUP BY 
     URG.IPCODPACI,
     MONTH(CAST(URG.FECINIATE as DATE)), 
     YEAR(CAST(URG.FECINIATE as DATE))
   )  URG
 GROUP BY 
  URG.IPCODPACI,
  URG.M_FECHORAIN, 
  URG.A_FECHORAIN
),

CTE_TELECONSULTAS_MED AS
 (
  SELECT 
   CIT.IPCODPACI,
   MONTH(CAST(CIT.FECHORAIN as DATE)) M_FECHORAIN, 
   YEAR(CAST(CIT.FECHORAIN as DATE)) A_FECHORAIN,
   COUNT(*) AS 'CANTIDAD'
  FROM 
   AGASICITA CIT
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = CIT.IPCODPACI AND MONTH(CAST(CIT.FECHORAIN as DATE)) = CTE.M_FECHISPAC AND YEAR(CAST(CIT.FECHORAIN as DATE)) = CTE.A_FECHISPAC AND
                                   CIT.CODESPECI IN ('002','010','011','012','013','014','015','016','017','019','020','021','022','023','024','025','026','027','028','060','159','190') 
   INNER JOIN AGACTIMED AS ACT ON CIT.CODACTMED = ACT.CODACTMED AND ACT.DESACTMED LIKE '%TELEC%'
  WHERE
   CIT.TIPSOLICITU='1' AND CIT.CODESTCIT='1' 
  GROUP BY 
   CIT.IPCODPACI,
   MONTH(CAST(CIT.FECHORAIN as DATE)), 
   YEAR(CAST(CIT.FECHORAIN as DATE))
 ),

CTE_TELECONSULTAS_ESP AS
 (
  SELECT 
   CIT.IPCODPACI,
   MONTH(CAST(CIT.FECHORAIN as DATE)) M_FECHORAIN, 
   YEAR(CAST(CIT.FECHORAIN as DATE)) A_FECHORAIN,
   COUNT(*) AS 'CANTIDAD'
  FROM 
   AGASICITA CIT
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = CIT.IPCODPACI AND MONTH(CAST(CIT.FECHORAIN as DATE)) = CTE.M_FECHISPAC AND YEAR(CAST(CIT.FECHORAIN as DATE)) = CTE.A_FECHISPAC AND
                                   CIT.CODESPECI IN ('047','067','070','074','075','092','093','116','117','118','119','120','127','128','139','144','145','146','147','148','149','150','161','174','351','352')
   INNER JOIN AGACTIMED AS ACT ON CIT.CODACTMED = ACT.CODACTMED AND ACT.DESACTMED LIKE '%TELEC%'
  WHERE
   CIT.TIPSOLICITU='1' AND CIT.CODESTCIT='1' 
  GROUP BY 
   CIT.IPCODPACI,
   MONTH(CAST(CIT.FECHORAIN as DATE)), 
   YEAR(CAST(CIT.FECHORAIN as DATE))
 ),

CTE_TOTAL_LABORATORIOS AS
(
  SELECT 
    LAB.IPCODPACI,
    MONTH(CAST(LAB.FECORDMED as DATE)) M_FECHORAIN, 
    YEAR(CAST(LAB.FECORDMED as DATE)) A_FECHORAIN,
    SUM(LAB.CANSERIPS) AS 'CANTIDAD' 
  From 
   HCORDLABO LAB
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = LAB.IPCODPACI AND
                                   MONTH(CAST(LAB.FECORDMED as DATE)) = CTE.M_FECHISPAC AND 
								   YEAR(CAST(LAB.FECORDMED as DATE)) = CTE.A_FECHISPAC 
  WHERE 
   LAB.ESTSERIPS in ('3','4') 
  GROUP BY 
   LAB.IPCODPACI,
   MONTH(CAST(LAB.FECORDMED as DATE)), 
   YEAR(CAST(LAB.FECORDMED as DATE))
  UNION ALL
  SELECT 
   LAB.IPCODPACI,
   MONTH(CAST(LAB.FECORDMED as DATE)) M_FECHORAIN, 
   YEAR(CAST(LAB.FECORDMED as DATE)) A_FECHORAIN,
   SUM(LAB.CANSERIPS) AS 'CANTIDAD' 
  From 
    AMBORDLAB LAB 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = LAB.IPCODPACI AND 
                                   MONTH(CAST(LAB.FECORDMED as DATE)) = CTE.M_FECHISPAC AND 
								   YEAR(CAST(LAB.FECORDMED as DATE)) = CTE.A_FECHISPAC
  WHERE 
   LAB.FECORDMED < LAB.FECRECMUE AND
   LAB.ESTSERIPS in ('3','4') 
  GROUP BY 
   LAB.IPCODPACI,
   MONTH(CAST(LAB.FECORDMED as DATE)),
   YEAR(CAST(LAB.FECORDMED as DATE))
 ),

CTE_TOTAL_FORMULAS AS
 (
SELECT
    ING.IPCODPACI,
    YEAR(CAST(PD.ConfirmationDate as DATE)) A_FECHORAIN,
    MONTH(CAST(PD.ConfirmationDate as DATE)) M_FECHORAIN, 
	COUNT(DISTINCT PD.Code) AS 'CANTIDAD' 
  FROM 
   Inventory.PharmaceuticalDispensing PD
   INNER JOIN  ADINGRESO AS ING ON PD.AdmissionNumber= ING.NUMINGRES 
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = ING.IPCODPACI AND 
								   MONTH(CAST(PD.ConfirmationDate as DATE)) = CTE.M_FECHISPAC AND 
								   YEAR(CAST(PD.ConfirmationDate as DATE)) = CTE.A_FECHISPAC
  WHERE 
   PD.status=2 
  GROUP BY 
   ING.IPCODPACI,
   YEAR(CAST(PD.ConfirmationDate as DATE)),
   MONTH(CAST(PD.ConfirmationDate as DATE))
 ),

CTE_GESTANTES_ATENDIDAS AS
 (
  SELECT
    HIS.IPCODPACI,
    MONTH(CAST(HIS.FECHISPAC as DATE)) M_FECHORAIN, 
    YEAR(CAST(HIS.FECHISPAC as DATE)) A_FECHORAIN,
    COUNT(*) AS 'CANTIDAD' 
  FROM 
   HCHISPACA HIS
   INNER JOIN CTE_PACIENTES CTE on CTE.IPCODPACI = HIS.IPCODPACI AND 
                                   HIS.NUMINGRES = CTE.NUMINGRES AND 
								   MONTH(CAST(HIS.FECHISPAC as DATE)) = CTE.M_FECHISPAC AND 
								   YEAR(CAST(HIS.FECHISPAC as DATE)) = CTE.A_FECHISPAC 
  WHERE 
   HIS.IDMODELOHC ='11'
  GROUP BY 
   HIS.IPCODPACI,
   MONTH(CAST(HIS.FECHISPAC as DATE)), 
   YEAR(CAST(HIS.FECHISPAC as DATE))
)

SELECT
 CAST(DB_NAME() AS VARCHAR(9)) AS ID_COMPANY, 
 YEAR(PTES.FECHISPAC) AS 'AÑO ATENCION',
 CONCAT(FORMAT(MONTH(PTES.FECHISPAC), '00') ,' - ', 
	 CASE MONTH(PTES.FECHISPAC) 
		 WHEN 1 THEN 'ENERO'
		 WHEN 2 THEN 'FEBRERO'
		 WHEN 3 THEN 'MARZO'
		 WHEN 4 THEN 'ABRIL'
		 WHEN 5 THEN 'MAYO'
		 WHEN 6 THEN 'JUNIO'
		 WHEN 7 THEN 'JULIO'
		 WHEN 8 THEN 'AGOSTO'
		 WHEN 9 THEN 'SEPTIEMBRE'
		 WHEN 10 THEN 'OCTUBRE'
		 WHEN 11 THEN 'NOVIEMBRE'
		 WHEN 12 THEN 'DICIEMBRE'
		END) AS 'MES ATENCION',
 CEN.NOMCENATE AS 'CENTRO DE ATENCION',
 PTES.NUMINGRES 'INGRESO',
 ENT.HealthEntityCode AS 'CODIGO ENTIDAD', 
 ENT.NAME AS 'NOMBRE EAPB',
 CASE INP.IPTIPODOC 
  WHEN '1' THEN 'CC' 
  WHEN '2' THEN 'CE' 
  WHEN '3' THEN 'TI' 
  WHEN '4' THEN 'RC' 
  WHEN '5' THEN 'PA'
  WHEN '6' THEN 'AS' 
  WHEN '7' THEN 'MS' 
  WHEN '8' THEN 'NU' 
  WHEN '9' THEN 'NV' 				
  WHEN '10' THEN 'CD'
  WHEN '11' THEN 'SC' 
  WHEN '12' THEN 'PE' 
  WHEN '13' THEN 'PT'
  WHEN '14' THEN 'DE'
  WHEN '15' THEN 'SI' 
  END AS 'TIPO IDENTIFICACION',		 
 PTES.IPCODPACI 'IDENTIFICACION PACIENTE',
 INP.IPPRIAPEL 'PRIMER APELLIDO' ,
 INP.IPSEGAPEL 'SEGUNDO APELLIDO' ,
 INP.IPPRINOMB 'PRIMER NOMBRE', 
 INP.IPSEGNOMB 'SEGUNDO NOMBRE', 
 CAST(INP.IPFECNACI AS DATE) 'FECHA DE NACIMIENTO',
 INP.IPTELMOVI 'TEL CELULAR', 
 INP.IPTELEFON 'TEL FIJO', 
 PTES.CODDIAGNO 'DX PRINCIPAL', 
 CEN.CODIPSSEC 'COD. HABILITACION',
 FLOOR((CAST(CONVERT(VARCHAR(8), PTES.FECHISPAC , 112) AS INT)-CAST(CONVERT(VARCHAR(8), INP.IPFECNACI, 112) AS INT)) / 10000) 'EDAD',
 DEP.depcodigo 'COD. DEPARTAMENTO',
 MUN.MUNCODIGO 'COD. MUNICIPIO', 
 MUN.MUNNOMBRE 'NOMBRE MUNICIPIO', 
 CASE INP.IPTIPOPAC 
  WHEN 1 THEN 'Contributivo' 
  WHEN 2 THEN 'Subsidiado' 
  WHEN 3 THEN 'Vinculado'
  WHEN 4 THEN 'Particular' 
  WHEN 5 THEN 'Otro'
  WHEN 6 THEN 'Desplazado Reg. Contributivo' 
  WHEN 7 THEN 'Desplazado Reg. Subsidiado' 
  WHEN 8 THEN 'Desplazado No Asegurado' 
 END 'REGIMEN DE ASEGURAMIENTO',
 CASE WHEN HTA.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'HTA',
 CASE WHEN DM.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'DM', 
 CASE WHEN REN.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'ERC',
 CASE WHEN CAN.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'CANCER',
 CASE WHEN AUT.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'AUTOINMUNES', 
 'NO' 'ANTIGOAGULADO', 
 'NO' 'DIABETES ESPECIALIZADA', 
 'NO' 'OXIGENO-DEPENDIENTE', 
 CASE WHEN ART.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'ARTRITIS',
 CASE WHEN VIH.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'VIH',
 'NO' 'FALLA CARDIACA', 
 CASE WHEN HUE.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'ENFERMEDAD HUERFANA', 
 'NO' 'SALUD MENTAL',
 CASE WHEN GES.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'GESTANTE', 
 CASE WHEN TUB.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'TUBERSULOSIS RESISTENTE', 
 CASE WHEN ESP.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'ESPONDILO-ARTROPATIA',
 CASE WHEN LES.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'LES', 
 CASE WHEN TRAS.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'TRASTORNOS DE COAGULACION', 
 CASE WHEN HEPC.IPCODPACI IS NOT NULL THEN 'SI' ELSE 'NO' END 'HEPATITIS C', 
 'NO' 'MENORES EXPUESTOS A VIH',
 CASE WHEN LLA.CANTIDAD IS NOT NULL THEN LLA.CANTIDAD ELSE 0 END 'LLAMADAS ATENDIDAS EN SALUD GENERAL', 
 CASE WHEN SM.CANTIDAD IS NOT NULL THEN SM.CANTIDAD ELSE 0 END 'LLAMADAS ATENDIDAS EN SALUD MENTAL',
 CASE WHEN SO.CANTIDAD IS NOT NULL THEN SO.CANTIDAD ELSE 0 END 'LLAMADAS ATENDIDAS EN SALUD ORAL', 
 0 'ATENCION DOMICILIARIA POR AUX. DE ENFERMERIA', 
 0 'ATENCION DOMICILIARIA POR ENFERMERIA PROFESIONAL',
 0 'ATENCION DOMICILIARIA POR MEDICINA GENERAL',
 CASE WHEN AUX.CANTIDAD IS NOT NULL THEN AUX.CANTIDAD ELSE 0 END 'ATENCION PRESENCIAL POR AUXILIAR DE ENFERMERIA', 
 CASE WHEN ENF.CANTIDAD IS NOT NULL THEN ENF.CANTIDAD ELSE 0 END 'ATENCION PRESENCIAL POR ENFERMERIA PROFESIONAL',
 CASE WHEN GEN.CANTIDAD IS NOT NULL THEN GEN.CANTIDAD ELSE 0 END 'ATENCION PRESENCIAL POR MEDICINA GENERAL', 
 CASE WHEN TEME.CANTIDAD IS NOT NULL THEN TEME.CANTIDAD ELSE 0 END 'TELECONSULTA MEDICINA GENERAL/ENFERMERIA',
 0 'TELECONSULTA CRONICOS MEDICINA GENERAL/ENFERMERIA', 
 CASE WHEN CESP.CANTIDAD IS NOT NULL THEN CESP.CANTIDAD ELSE 0 END 'TELECONSULTA ESPECIALISTA', 
 0 'LABORATORIOS TOMADOS EN EL DOMICILIO',
 CASE WHEN TLAB.CANTIDAD IS NOT NULL THEN TLAB.CANTIDAD ELSE 0 END as 'LABORATORIOS INSTITUCIONALES TOMADOS', 
 0 'FÓRMULAS DE MEDICAMENTOS ENTREGADAS A DOMICILIO', 
 CASE WHEN FORM.CANTIDAD IS NOT NULL THEN FORM.CANTIDAD ELSE 0 END 'FORMULAS INSTITUCIONALES ENTREGADAS',
 0 'CONTROL PRENATAL DOMICILIO', 
 CASE WHEN GATE.CANTIDAD IS NOT NULL THEN GATE.CANTIDAD ELSE 0 END 'CONTROL PRENATAL INSTITUCIONAL',
 CAST(PTES.FECHISPAC AS date) AS 'FECHA BUSQUEDA',
 YEAR(PTES.FECHISPAC) AS 'AÑO BUSQUEDA',
 MONTH(PTES.FECHISPAC) AS 'MES BUSQUEDA',
 CONCAT(FORMAT(MONTH(PTES.FECHISPAC), '00') ,' - ', 
	   CASE MONTH(PTES.FECHISPAC) 
	    WHEN 1 THEN 'ENERO'
   	    WHEN 2 THEN 'FEBRERO'
	    WHEN 3 THEN 'MARZO'
	    WHEN 4 THEN 'ABRIL'
	    WHEN 5 THEN 'MAYO'
	    WHEN 6 THEN 'JUNIO'
	    WHEN 7 THEN 'JULIO'
	    WHEN 8 THEN 'AGOSTO'
	    WHEN 9 THEN 'SEPTIEMBRE'
	    WHEN 10 THEN 'OCTUBRE'
	    WHEN 11 THEN 'NOVIEMBRE'
	    WHEN 12 THEN 'DICIEMBRE' END) 'MES NOMBRE BUSQUEDA',
 CONVERT(DATETIME,GETDATE() AT TIME ZONE 'Pakistan Standard Time',1) AS ULT_ACTUAL
FROM 
 CTE_PACIENTES PTES 
 INNER JOIN INPACIENT AS INP ON PTES.IPCODPACI = INP.IPCODPACI 
 INNER JOIN CONTRACT.HEALTHADMINISTRATOR AS ENT ON ENT.Id = PTES.GENCONENTITY 
 INNER JOIN ADCENATEN AS CEN ON CEN.CODCENATE = PTES.CODCENATE 
 LEFT JOIN INUBICACI AS UB ON UB.AUUBICACI = INP.AUUBICACI
 LEFT JOIN INMUNICIP AS MUN ON MUN.DEPMUNCOD = UB.DEPMUNCOD
 LEFT JOIN INDEPARTA AS DEP ON DEP.depcodigo = MUN.DEPCODIGO
 LEFT JOIN CTE_HTA AS HTA ON HTA.IPCODPACI = PTES.IPCODPACI AND HTA.M_IFECHAING = PTES.M_FECHISPAC AND HTA.A_IFECHAING = PTES.A_FECHISPAC
 LEFT JOIN CTE_DM AS DM ON DM.IPCODPACI = PTES.IPCODPACI AND DM.M_IFECHAING = PTES.M_FECHISPAC AND DM.A_IFECHAING = PTES.A_FECHISPAC
 LEFT JOIN CTE_RENAL AS REN ON REN.IPCODPACI = PTES.IPCODPACI AND REN.M_IFECHAING = PTES.M_FECHISPAC AND REN.A_IFECHAING = PTES.A_FECHISPAC
 LEFT JOIN CTE_CANCER AS CAN ON CAN.IPCODPACI = PTES.IPCODPACI AND CAN.M_IFECHAING = PTES.M_FECHISPAC AND CAN.A_IFECHAING = PTES.A_FECHISPAC 
 LEFT JOIN CTE_AUTOINMUNES AS AUT ON AUT.IPCODPACI=PTES.IPCODPACI AND AUT.M_IFECHAING = PTES.M_FECHISPAC AND AUT.A_IFECHAING = PTES.A_FECHISPAC 
 LEFT JOIN CTE_ARTRITIS AS ART ON ART.IPCODPACI=PTES.IPCODPACI AND ART.M_IFECHAING = PTES.M_FECHISPAC AND ART.A_IFECHAING = PTES.A_FECHISPAC 
 LEFT JOIN CTE_VIH AS VIH ON VIH.IPCODPACI=PTES.IPCODPACI AND VIH.M_IFECHAING = PTES.M_FECHISPAC AND VIH.A_IFECHAING = PTES.A_FECHISPAC 
 LEFT JOIN CTE_HUERFANAS AS HUE ON HUE.IPCODPACI=PTES.IPCODPACI AND HUE.M_IFECHAING = PTES.M_FECHISPAC AND HUE.A_IFECHAING = PTES.A_FECHISPAC 
 LEFT JOIN CTE_GESTANTE AS GES ON GES.IPCODPACI=PTES.IPCODPACI AND GES.M_FECGESTA = PTES.M_FECHISPAC AND GES.A_FECGESTA = PTES.A_FECHISPAC 
 LEFT JOIN CTE_TUBERCULOSIS_RESISTENTE AS TUB ON TUB.IPCODPACI=PTES.IPCODPACI AND TUB.M_IFECHAING = PTES.M_FECHISPAC AND TUB.A_IFECHAING = PTES.A_FECHISPAC 
 LEFT JOIN CTE_ESPONDILOPATIA AS ESP ON ESP.IPCODPACI=PTES.IPCODPACI AND ESP.M_IFECHAING = PTES.M_FECHISPAC AND ESP.A_IFECHAING = PTES.A_FECHISPAC 
 LEFT JOIN CTE_LUPUS AS LES ON LES.IPCODPACI=PTES.IPCODPACI AND LES.M_IFECHAING = PTES.M_FECHISPAC AND LES.A_IFECHAING = PTES.A_FECHISPAC 
 LEFT JOIN CTE_TRAS_COAGULACION AS TRAS ON TRAS.IPCODPACI=PTES.IPCODPACI AND TRAS.M_IFECHAING = PTES.M_FECHISPAC AND TRAS.A_IFECHAING = PTES.A_FECHISPAC 
 LEFT JOIN CTE_HEPATITIS_C AS HEPC ON HEPC.IPCODPACI = PTES.IPCODPACI AND HEPC.M_IFECHAING = PTES.M_FECHISPAC AND HEPC.A_IFECHAING = PTES.A_FECHISPAC 
 LEFT JOIN CTE_LLAMADAS_GENERAL AS LLA ON LLA.IPCODPACI = PTES.IPCODPACI AND LLA.M_FECHORAIN = PTES.M_FECHISPAC AND LLA.A_FECHORAIN = PTES.A_FECHISPAC
 LEFT JOIN CTE_LLAMADAS_SM AS SM ON SM.IPCODPACI = PTES.IPCODPACI AND SM.M_FECHORAIN = PTES.M_FECHISPAC AND SM.A_FECHORAIN = PTES.A_FECHISPAC
 LEFT JOIN CTE_LLAMADAS_ODONTOLOGIA AS SO ON SO.IPCODPACI = PTES.IPCODPACI AND SO.M_FECHORAIN = PTES.M_FECHISPAC AND SO.A_FECHORAIN = PTES.A_FECHISPAC
 LEFT JOIN CTE_ATEN_AUXI AS AUX ON AUX.IPCODPACI = PTES.IPCODPACI AND AUX.M_FECHORAIN = PTES.M_FECHISPAC AND AUX.A_FECHORAIN = PTES.A_FECHISPAC
 LEFT JOIN CTE_ATEN_ENF AS ENF ON ENF.IPCODPACI = PTES.IPCODPACI AND ENF.M_FECHORAIN = PTES.M_FECHISPAC AND ENF.A_FECHORAIN = PTES.A_FECHISPAC
 LEFT JOIN CTE_ATEN_GENERAL AS GEN ON GEN.IPCODPACI = PTES.IPCODPACI AND GEN.M_FECHORAIN = PTES.M_FECHISPAC AND GEN.A_FECHORAIN = PTES.A_FECHISPAC
 LEFT JOIN CTE_TELECONSULTAS_MED AS TEME ON TEME.IPCODPACI = PTES.IPCODPACI AND TEME.M_FECHORAIN = PTES.M_FECHISPAC AND TEME.A_FECHORAIN = PTES.A_FECHISPAC
 LEFT JOIN CTE_TELECONSULTAS_ESP AS CESP ON CESP.IPCODPACI = PTES.IPCODPACI AND CESP.M_FECHORAIN = PTES.M_FECHISPAC AND CESP.A_FECHORAIN = PTES.A_FECHISPAC
 LEFT JOIN CTE_TOTAL_LABORATORIOS TLAB ON TLAB.IPCODPACI = PTES.IPCODPACI AND TLAB.M_FECHORAIN = PTES.M_FECHISPAC AND TLAB.A_FECHORAIN = PTES.A_FECHISPAC
 LEFT JOIN CTE_TOTAL_FORMULAS AS FORM ON FORM.IPCODPACI = PTES.IPCODPACI AND FORM.M_FECHORAIN = PTES.M_FECHISPAC AND FORM.A_FECHORAIN = PTES.A_FECHISPAC
 LEFT JOIN CTE_GESTANTES_ATENDIDAS AS GATE ON GATE.IPCODPACI = PTES.IPCODPACI AND GATE.M_FECHORAIN = PTES.M_FECHISPAC AND GATE.A_FECHORAIN = PTES.A_FECHISPAC

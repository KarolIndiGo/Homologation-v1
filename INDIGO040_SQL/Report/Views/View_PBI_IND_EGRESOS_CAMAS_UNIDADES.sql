-- Workspace: SQLServer
-- Item: INDIGO040 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: View_PBI_IND_EGRESOS_CAMAS_UNIDADES
-- Extracted by Fabric SQL Extractor SPN v3.9.0


CREATE view [Report].[View_PBI_IND_EGRESOS_CAMAS_UNIDADES] as

WITH CTE_ULTIMO_INGRESO AS 
 (
   SELECT MAX(CAM.ID) ID, CAM.NUMINGRES
   FROM CHREGESTA CAM 
   GROUP BY CAM.NUMINGRES
 )

SELECT 
 --COUNT(*)
 CAST(DB_NAME() AS VARCHAR(9)) AS ID_COMPANY,  
 (YEAR(HC.FECFINEST) * 100) + MONTH(HC.FECFINEST) [ID_TIEMPO],
 CONVERT(int, RTRIM(LTRIM(HC.CODICAMAS))) CODICAMAS,
 CONVERT(int,RTRIM(LTRIM(CAMD.UFUCODIGO))) [ID_UFUN],
 HC.NUMINGRES INGRESO,
 CASE WHEN HC.FECFINEST>'1989-01-01 00:00:00.000' THEN DATEDIFF(DAY,HC.FECINIEST,HC.FECFINEST) 
	  ELSE NULL END AS [DIAS TRANSCURRIDOS],
 CASE WHEN HC.FECFINEST>'1989-01-01 00:00:00.000' THEN DATEDIFF(HOUR,HC.FECINIEST,HC.FECFINEST) 
	  ELSE NULL END AS [HORAS TRANSCURRIDOS],
 IIF(EGR.FECALTPAC IS NULL,'NO', 'SI') [EGRESO],
 IIF(UI.ID IS NULL,'NO', 'SI') [ULT_INGRESO],
 CONVERT(DATETIME,GETDATE() AT TIME ZONE 'Pakistan Standard Time',1) AS ULT_ACTUAL
FROM
 CHREGESTA HC 
 INNER JOIN ADINGRESO ING ON HC.NUMINGRES = ING.NUMINGRES 
 LEFT JOIN CHREGEGRE EGR ON EGR.NUMINGRES = HC.NUMINGRES
 LEFT JOIN CTE_ULTIMO_INGRESO UI ON UI.ID = HC.ID
 INNER JOIN CHCAMASHO CAMD ON CAMD.CODICAMAS = HC.CODICAMAS
WHERE
 CAMD.CAMVIRTUA = 'FALSE'

--IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Report].[View_PBI_IND_EGRESOS_CAMAS_UNIDADES]') AND type in (N'U'))
--DROP EXTERNAL TABLE [Report].[View_PBI_IND_EGRESOS_CAMAS_UNIDADES]
--GO

--CREATE EXTERNAL TABLE [Report].[View_PBI_IND_EGRESOS_CAMAS_UNIDADES]
--(
--	[ID_COMPANY] [varchar](9) NULL,
--	[ID_TIEMPO] [int] NULL,
--	[CODICAMAS] [int] NOT NULL,
--	[ID_UFUN] [int] NULL,
--	[INGRESO] [char](10) NOT NULL,
--	[DIAS TRANSCURRIDOS] [int] NULL,
--	[HORAS TRANSCURRIDOS] [int] NULL,
--	[EGRESO] [varchar](2) NOT NULL,
--	[ULT_INGRESO] [varchar](2) NOT NULL,
--	[ULT_ACTUAL] [datetime] NULL
--)
--WITH (DATA_SOURCE = [INDIGO040],SCHEMA_NAME = N'Report',OBJECT_NAME = N'View_PBI_IND_EGRESOS_CAMAS_UNIDADES')
--GO

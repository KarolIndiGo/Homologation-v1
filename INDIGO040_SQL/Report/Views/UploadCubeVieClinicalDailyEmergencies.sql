-- Workspace: SQLServer
-- Item: INDIGO040 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: UploadCubeVieClinicalDailyEmergencies
-- Extracted by Fabric SQL Extractor SPN v3.9.0




---URGENCIAS DIARIAS
--DECLARE @FECHAINI DATE='2025-01-01';
--DECLARE @FECHAFIN DATE='2025-01-31';

--TODAS LAS ATENCIONES EN LAS UNIDADES DE URGENCIAS DE TRIAGE QUE PUEDEN O NO TENER ATENCIONES EN CONSULTORIOS DE URGENCIAS 

CREATE VIEW [Report].[UploadCubeVieClinicalDailyEmergencies] AS

----*** CTE PARA TRAR LOS REGISTROS UNICOS MENOR DE LA LLEGADA DE LOS PACIENTES Y POSTERIOR PASO POR TRIAGE ***---

WITH CTE_DATO_UNICO_MIN
AS
(
  SELECT MIN(A.ID) ID ,A.IPCODPACI ,A.NUMINGRES 
  FROM dbo.ADTRIAGEU AS A 
   LEFT JOIN dbo.ADCONTURG AS U                                                           
      ON A.TRIANUMER=U.CODCONCEC 
   LEFT JOIN dbo.ADINGRESO AS I                                                       
      ON A.NUMINGRES = I.NUMINGRES
   LEFT JOIN dbo.INUNIFUNC AS UNF                                                              
      ON ISNULL(U.UFUCODIGO,I.UFUCODIGO)=UNF.UFUCODIGO		   
  WHERE A.TRIAGECLA BETWEEN 1 AND 5  AND UNF.UFUTIPUNI=1 
  AND CAST(ISNULL(U.IPFECLLEGA ,ISNULL(A.TRIAFECHA,I.IFECHAING)) AS DATE)=(SELECT CAST(DATEADD(HOUR, -5, GETDATE()) AS DATE))--(SELECT CAST(GETDATE() AS DATE))--  between @FECHAINI and @FECHAFIN
  GROUP BY A.IPCODPACI ,A.NUMINGRES
)

----*** CTE PARA TRAR LOS REGISTROS UNICOS MAYOR DE LA LLEGADA DE LOS PACIENTES Y POSTERIOR PASO POR TRIAGE ***---

, CTE_DATO_UNICO_MAX
AS
(
  SELECT MAX(A.ID) ID ,A.IPCODPACI ,A.NUMINGRES 
  FROM dbo.ADTRIAGEU AS A 
   LEFT JOIN dbo.ADCONTURG AS U                                                           
      ON A.TRIANUMER=U.CODCONCEC 
   LEFT JOIN dbo.ADINGRESO AS I                                                       
      ON A.NUMINGRES = I.NUMINGRES
   LEFT JOIN dbo.INUNIFUNC AS UNF                                                              
      ON ISNULL(U.UFUCODIGO,I.UFUCODIGO)=UNF.UFUCODIGO		   
  WHERE A.TRIAGECLA BETWEEN 1 AND 5  AND UNF.UFUTIPUNI=1 AND CAST(ISNULL(U.IPFECLLEGA ,ISNULL(A.TRIAFECHA,I.IFECHAING)) AS DATE)=(SELECT CAST(DATEADD(HOUR, -5, GETDATE()) AS DATE))--(SELECT CAST(GETDATE() AS DATE))--  between @FECHAINI and @FECHAFIN
  GROUP BY A.IPCODPACI ,A.NUMINGRES
)

----*** CTE PARA TRAR LAS RECLASIFICACIONES DE TRIAGE ***---

, CTE_RECLA_TRIAGE
AS
(
  SELECT A.ID ,A.NUMINGRES ,A.IPCODPACI ,A.TRIANUMER ,A.TRIAGECLA ,A.CODPROSAL 
  FROM dbo.ADTRIAGEU AS A 
  INNER JOIN CTE_DATO_UNICO_MAX AS MAX ON MAX.ID =A.ID AND MAX.NUMINGRES =A.NUMINGRES 
)

----*** CTE PARA TRAR LOS REGISTROS  DE LA LLEGADA DE LOS PACIENTES Y POSTERIOR PASO POR TRIAGE ***---

,  CTE_TRIAGE_UNICO_POR_ATENCION AS (
    SELECT
     ROW_NUMBER() OVER(PARTITION BY A.TRIANUMER ORDER BY A.IPCODPACI,A.ID DESC) AS NUMERO
   	, A.IPCODPACI
    , A.CODCENATE
    , A.CODPROSAL
    , A.TRIANUMER
    , A.TRIACATEG
    , A.NUMINGRES
    , A.ID
    , ISNULL(U.IPFECLLEGA,ISNULL(A.TRIAFECHA,I.IFECHAING)) AS [FECHA LLEGADA]                      ---- SIEMPRE DEBE EXISTIR UN FECHA DE LLEGADA
    , CASE WHEN A.FECHINITR <= A.TRIAFECHA THEN A.FECHINITR ELSE A.TRIAFECHA END AS FECHA_TRIAGE
    , A.TRIAFECHA [FECHA FIN TRIAGE]
    , A.TRIAGECLA
    , UNF.UFUCODIGO AS [CODIGO UNIDAD FUNCIONAL DE INGRESO]
    , UNF.UFUDESCRI AS [UNIDAD FUNCIONAL DE INGRESO]
    , I.CODDIAING
    , I.CODDIAEGR
    FROM dbo.ADTRIAGEU AS A                                                                        ---- TABLA DONDE SE ALMACENA LA ATENCION DE TRIAGE 
	INNER JOIN CTE_DATO_UNICO_MIN AS UNI															   ---- CTE DATO UNICO DE TRIAGE
	  ON UNI.ID =A.ID 
	LEFT JOIN dbo.ADCONTURG AS U                                                                   ---- TABLA DONDE SE ALMACENA EL CONTROL DE ADMISION DEL PACIENTE ANTES DE PASAR A TRIAGE
      ON A.TRIANUMER=U.CODCONCEC 			               	                                      
    LEFT JOIN dbo.ADINGRESO AS I                                                                   ---- TABLA DONDE SE ALMACENA LOS INGRESOS QUE PASARON A CONSULTORIO
      ON A.NUMINGRES = I.NUMINGRES			               	                                      
    LEFT JOIN dbo.INUNIFUNC AS UNF                                                                 ---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES
      ON ISNULL(U.UFUCODIGO,I.UFUCODIGO)=UNF.UFUCODIGO		                                      
    WHERE A.TRIAGECLA BETWEEN 1 AND 5                                                              ---- CONDICION PARA TRAR SOLO LOS TRIAGE DE 1 A 5
      AND UNF.UFUTIPUNI=1                                                                          ---- CONDICION PARA TRAR SOLO LAS UNIDADES DE TIPO URGENCIAS QUE ES 1
      AND CAST(ISNULL(U.IPFECLLEGA ,ISNULL(A.TRIAFECHA,I.IFECHAING)) AS DATE) =(SELECT CAST(DATEADD(HOUR, -5, GETDATE()) AS DATE))--(SELECT CAST(GETDATE() AS DATE))--	  between @FECHAINI and @FECHAFIN
	  --= (SELECT CAST(COMMON.GETDATE() AS DATE))
 )

----*** CTE PARA TRAR EL MAXIMO REGISTRO DE LA TABLA DE RIESGO DEL PACIENTE PARA IDENTIFICAR SI ES UNA MATERNA, TENER EN CUENTA QUE ESTA TABLA SE ALAMCENA POR CADA ATENCIÓN DEL MISMO INGRESO POR ESO EL MAX ***---

 , CTE_MAX_GINECO AS (
   SELECT MAX(RI.ID) ID
   , RI.NUMINGRCES 
   FROM dbo.HCRIESGOSP RI                                                                           ---- TABLA DONDE SE ALMACENAN LOS RIESGOS DE LOS PACIENTES
   WHERE RI.GESTACION=1 GROUP BY RI.NUMINGRCES                                                      ---- CONDICION PARA TRAR SOLO EL REISGO MATERNAS
)

----*** CTE PARA TRAR EL REGISTRO UNICO DE LA TABLA DE RIESGO DEL PACIENTE PARA IDENTIFICAR SI ES UNA MATERNA ***---

, CTE_ANTECEDENTES_GINECOBSTETRICOS AS ( 
  SELECT  A.NUMINGRES 
  FROM dbo.HCRIESGOSP AS RIE                                                                         ---- TABLA DONDE SE ALMACENAN LOS RIESGOS DE LOS PACIENTES
  INNER JOIN CTE_TRIAGE_UNICO_POR_ATENCION AS A                                                      ---- CTE TRAIGE UNICO
    ON RIE.NUMINGRCES = A.NUMINGRES 
	AND A.NUMERO = 1
  INNER JOIN CTE_MAX_GINECO AS G 
    ON G.ID =RIE.ID 
	AND G.NUMINGRCES =RIE.NUMINGRCES 
  WHERE RIE.GESTACION = 1
)

----*** CTE PARA TRAR EL REGISTRO MENOS DE LAS HISTORIAS CLINICAS QUE TENGA EL PACIENTE EN URGENCIAS ***---

, CTE_MIN_FOLIO AS
(
 SELECT MIN(NUMEFOLIO) NUMEFOLIO
   , K.NUMINGRES 
   FROM dbo.HCURGING1 K																				 ---- TABLA DONDE SE ALMACENAN LOS REGISTROS CLINICOS DE PRIEMRA VEZ POR CADA INGRESO
   INNER JOIN DBO.INUNIFUNC AS U																     ---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES
     ON U.UFUCODIGO =K.UFUCODIGO   
	 AND U.UFUTIPUNI =1
   GROUP BY K.NUMINGRES
)

----*** CTE PARA TRAR EL REGISTRO UNICO DE LAS HISTORIAS CLINICAS QUE TENGA EL PACIENTE EN URGENCIAS ***---

, CTE_HCURGING1 AS
(
 SELECT K.NUMINGRES
   , K.NUMEFOLIO
   , K.CODPROSAL
   , K.UFUCODIGO
   , K.FECHINIHI
   , K.FECHFINH
   , K.INDICAPAC
   FROM dbo.HCURGING1 K																				 ---- TABLA DONDE SE ALMACENAN LOS REGISTROS CLINICOS DE PRIEMRA VEZ POR CADA INGRESO
   INNER JOIN CTE_TRIAGE_UNICO_POR_ATENCION AS A													 ---- CTE TRIAGE UNICO
     ON A.NUMINGRES = K.NUMINGRES   
	 AND A.NUMERO = 1
   INNER JOIN CTE_MIN_FOLIO F																		 ---- CTE PARA EL MENOR FOLIO 
     ON F.NUMINGRES =K.NUMINGRES 
	 AND F.NUMEFOLIO =K.NUMEFOLIO 
)

----*** CTE PARA TRAR EL REGISTRO MAXIMO DE LAS ESTANCIAS QUE TENGA EL PACIENTE EN URGENCIAS ***---

, CTE_MAX_CAMA_OCUPADA_OBSERVACION AS (  
  SELECT EGR.NUMINGRES
  , MAX(EGR.ID) AS ID 
  FROM dbo.CHREGESTA AS EGR																			 ---- TABLA DONDE SE ALMACENAN LA TRAZABILIDAD DE CAMAS QUE TUVO EL PACIENTE EN HOSPITALIZACION
  INNER JOIN dbo.CHCAMASHO AS CAM																	 ---- TABLA DONDE SE ALMACENAN LAS CAMAS			
    ON CAM.CODICAMAS = EGR.CODICAMAS
  INNER JOIN dbo.INUNIFUNC AS FUN																	 ---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES
    ON CAM.UFUCODIGO = FUN.UFUCODIGO
  WHERE FUN.UFUTIPUNI = '1'																			 ---- CONDICION PARA TRAR SOLO LAS UNIDADES DE TIPO URGENCIAS QUE ES 1
  GROUP BY EGR.NUMINGRES
)

----*** CTE PARA TRAR EL REGISTRO UNICO DE LAS ESTANCIAS QUE TENGA EL PACIENTE EN URGENCIAS ***---

, CTE_ULTIMA_CAMAS_OCUPADA_OBSERVACION AS
 (
  SELECT EGR.NUMINGRES
  , CAM.NUMCAMHOS [CAMA OBSERVACION URGENCIA]
  , fun.UFUTIPUNI
  , CAM.DESCCAMAS 
  FROM dbo.CHREGESTA AS EGR                                                                         ---- TABLA DONDE SE ALMACENAN LA TRAZABILIDAD DE CAMAS QUE TUVO EL PACIENTE EN HOSPITALIZACION
  INNER JOIN CTE_TRIAGE_UNICO_POR_ATENCION AS A														---- CTE TRIAGE UNICO
    ON A.NUMINGRES = EGR.NUMINGRES  
    AND A.NUMERO = 1
  INNER JOIN CTE_MAX_CAMA_OCUPADA_OBSERVACION M													    ---- CTE PARA LA ULTIMA CAMA OCUPADA EN LA UNIDAD
    ON M.ID =EGR.ID 
    AND M.NUMINGRES =EGR.NUMINGRES 
  INNER JOIN CHCAMASHO AS CAM																		---- TABLA DONDE SE ALMACENAN LAS CAMAS
    ON CAM.CODICAMAS =EGR.CODICAMAS 
  INNER JOIN DBO.INUNIFUNC AS FUN																	---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES
    ON CAM.UFUCODIGO =FUN.UFUCODIGO
)

----*** CTE PARA TRAR EL REGISTRO SI EL PACIENTE FALLECIO EN URGENCIAS ***---

, CTE_MUERTOS AS
 (
  SELECT
  HIS.NUMINGRES AS INGRESO
  , HIS.ID
  , EGR.FECMUEPAC AS FECHA_MUERTE
  FROM dbo.HCHISPACA HIS																			---- TABLA MAESTRA DONDE SE ALMACENAN TODOS LOS FOLIOS DE CUALQUIER AMBITO DONDE SE REALIZAN REGISTROS CLÍNICOS									
   INNER JOIN CTE_TRIAGE_UNICO_POR_ATENCION AS A
      ON HIS.NUMINGRES = A.NUMINGRES
	  AND A.NUMERO = 1
   INNER JOIN dbo.HCREGEGRE AS EGR																	---- TABLA DONDE SE ALMACENAN TODOS LOS REGISTROS DE EGRESOS CLINCOS POR PARTE DE LOS MEDICOS	
      ON HIS.NUMINGRES = EGR.NUMINGRES
      AND HIS.NUMEFOLIO = EGR.NUMEFOLIO 
   INNER JOIN dbo.INUNIFUNC AS FUN																	---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES
      ON EGR.UFUCODIGO = FUN.UFUCODIGO 
  WHERE  HIS.INDICAPAC = 11																			---- CONDICION PARA TRAR SOLO LOS FALLECIDOS QUE ES 11
    AND FUN.UFUTIPUNI = '1'																			---- CONDICION PARA TRAR SOLO LAS UNIDADES DE TIPO URGENCIAS QUE ES 1
 )

 ----*** CTE PARA TRAR EL MENOR REGISTRO DE LA HISTORIA CLINICA DEL PACIENTE POR ESE INGRESO ***---

, CTE_MIN_HCHISPACA1 AS 
 (
  SELECT H.NUMINGRES
  , MIN(H.NUMEFOLIO) NUMEFOLIO
  FROM DBO.HCHISPACA H																				---- TABLA MAESTRA DONDE SE ALMACENAN TODOS LOS FOLIOS DE CUALQUIER AMBITO DONDE SE REALIZAN REGISTROS CLÍNICOS	
  INNER JOIN dbo.INUNIFUNC AS UNF																	---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES		
    ON UNF.UFUCODIGO=H.UFUCODIGO  
	AND UNF.UFUTIPUNI =1																			---- CONDICION PARA TRAR SOLO LAS UNIDADES DE TIPO URGENCIAS QUE ES 1
  GROUP BY H.NUMINGRES
)

 ----*** CTE PARA TRAR EL PRIMER REGISTRO Y UNICO DE LA HISTORIA CLINICA DEL PACIENTE POR ESE INGRESO ***---

, CTE_HCHISPACA1 AS 
 (
  SELECT HIS.NUMINGRES
  , HIS.IPCODPACI
  , HIS.NUMEFOLIO
  , HIS.INDICAPAC
  , HIS.FECHISPAC
   ,HIS.CODPROSAL
  FROM DBO.HCHISPACA HIS																			---- TABLA MAESTRA DONDE SE ALMACENAN TODOS LOS FOLIOS DE CUALQUIER AMBITO DONDE SE REALIZAN REGISTROS CLÍNICOS	
  INNER JOIN CTE_TRIAGE_UNICO_POR_ATENCION AS A														---- CTE TRIAGE UNICO
      ON HIS.NUMINGRES = A.NUMINGRES
	  AND A.NUMERO = 1
  INNER JOIN CTE_MIN_HCHISPACA1 M                                                                   ---- CTE FOLIO MENOR HISTORIA CLINICA
    ON M.NUMINGRES =HIS.NUMINGRES 
	  AND M.NUMEFOLIO =HIS.NUMEFOLIO 
  INNER JOIN dbo.INUNIFUNC AS UNF																	---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES
    ON UNF.UFUCODIGO=HIS.UFUCODIGO  
	AND UNF.UFUTIPUNI =1																		    ---- CONDICION PARA TRAR SOLO LAS UNIDADES DE TIPO URGENCIAS QUE ES 1
)

 ----*** CTE PARA TRAR EL ULTIMO REGISTRO DE LA HISTORIA CLINICA DEL PACIENTE POR ESE INGRESO ***---

 , CTE_MAX_HCHISPACA2 AS 
 (
  SELECT H.NUMINGRES
  , MAX(H.NUMEFOLIO) NUMEFOLIO
  FROM DBO.HCHISPACA H																				---- TABLA MAESTRA DONDE SE ALMACENAN TODOS LOS FOLIOS DE CUALQUIER AMBITO DONDE SE REALIZAN REGISTROS CLÍNICOS	
  INNER JOIN dbo.INUNIFUNC AS UNF																	---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES
    ON UNF.UFUCODIGO=H.UFUCODIGO  
	AND UNF.UFUTIPUNI =1																			---- CONDICION PARA TRAR SOLO LAS UNIDADES DE TIPO URGENCIAS QUE ES 1
  GROUP BY H.NUMINGRES
)

 ----*** CTE PARA TRAR EL ULTIMO REGISTRO Y UNICO DE LA HISTORIA CLINICA DEL PACIENTE POR ESE INGRESO ***---

, CTE_HCHISPACA2 AS 
 (
  SELECT HIS.NUMINGRES
  , HIS.IPCODPACI 
  , HIS.NUMEFOLIO 
  , HIS.INDICAPAC
  FROM DBO.HCHISPACA HIS																			---- TABLA MAESTRA DONDE SE ALMACENAN TODOS LOS FOLIOS DE CUALQUIER AMBITO DONDE SE REALIZAN REGISTROS CLÍNICOS
  INNER JOIN CTE_TRIAGE_UNICO_POR_ATENCION AS A														---- CTE TRIAGE UNICO
      ON HIS.NUMINGRES = A.NUMINGRES
	  AND A.NUMERO = 1
  INNER JOIN CTE_MAX_HCHISPACA2 M																	---- CTE FOLIO MAYOR HISTORIA CLINICA
    ON M.NUMINGRES =HIS.NUMINGRES 
	  AND M.NUMEFOLIO =HIS.NUMEFOLIO 
  INNER JOIN dbo.INUNIFUNC AS UNF																	---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES
    ON UNF.UFUCODIGO=HIS.UFUCODIGO  
	AND UNF.UFUTIPUNI =1                                                                            ---- CONDICION PARA TRAR SOLO LAS UNIDADES DE TIPO URGENCIAS QUE ES 1
)

----*** CTE PARA TRAR EL ULTIMO REGISTRO DE EGRESO CLINICO DEL PACIENTE POR ESE INGRESO ***---

, CTE_MAX_HCREGEGRE AS
(
  SELECT MAX(H.NUMEFOLIO) NUMEFOLIO
  , H.NUMINGRES 
  FROM DBO.HCREGEGRE H																				---- TABLA MAESTRA DONDE SE ALMACENAN TODOS LOS EGRESOS QUE SE REALIZAN A LOS PACIENTES POR PARTE DE LOS MEDICOS
  INNER JOIN dbo.INUNIFUNC AS UNF																	---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES
    ON UNF.UFUCODIGO=H.UFUCODIGO 
	AND UNF.UFUTIPUNI =1																			---- CONDICION PARA TRAR SOLO LAS UNIDADES DE TIPO URGENCIAS QUE ES 1
  GROUP BY H.NUMINGRES
)

----*** CTE PARA TRAR EL UNICO REGISTRO DE EGRESO CLINICO DEL PACIENTE POR ESE INGRESO ***---

, CTE_HCREGEGRE AS
(
  SELECT H.UFUCODIGO
  , H.NUMINGRES
  , H.NUMEFOLIO
  , H.FECALTPAC
  FROM DBO.HCREGEGRE H																			  ---- TABLA MAESTRA DONDE SE ALMACENAN TODOS LOS EGRESOS QUE SE REALIZAN A LOS PACIENTES POR PARTE DE LOS MEDICOS
  INNER JOIN CTE_TRIAGE_UNICO_POR_ATENCION AS A													  ---- CTE TRIAGE UNICO
      ON H.NUMINGRES = A.NUMINGRES
	  AND A.NUMERO = 1
  INNER JOIN CTE_MAX_HCREGEGRE E                                                                  ---- CTE MAXIMO REGISTRO DE EGRESO
    ON H.NUMINGRES =E.NUMINGRES 
	  AND H.NUMEFOLIO =E.NUMEFOLIO 
  INNER JOIN dbo.INUNIFUNC AS UNF																  ---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES
    ON UNF.UFUCODIGO=H.UFUCODIGO  
	AND UNF.UFUTIPUNI =1																		  ---- CONDICION PARA TRAR SOLO LAS UNIDADES DE TIPO URGENCIAS QUE ES 1
)

----*** CTE PARA TRAR EL MAXIMO REGISTRO DE REFERECIA Y CONTRA REFERENCIA DEL PACIENTE POR ESE INGRESO ***---

, CTE_HCREFCONP AS
(
  SELECT MAX(R.AUTO) AUTO
  , R.NUMINGRES 
  FROM dbo.HCREFCONP R																			  ---- TABLA MAESTRA DONDE SE ALMACENAN TODOS LAS REFERENCIA DE LOS PACIENTES
  INNER JOIN CTE_TRIAGE_UNICO_POR_ATENCION AS A													  ---- CTE TRIAGE UNICO
      ON R.NUMINGRES = A.NUMINGRES
	  AND A.NUMERO = 1
  GROUP BY R.NUMINGRES
)

----*** CTE PARA TRAR EL MAXIMO REGISTRO DE ESTANCIA DEL PACIENTE POR ESE INGRESO ***---

, CTE_MAX_CHREGESTA AS
( 
  SELECT MAX(ID) ID 
  , EGR.NUMINGRES 
  FROM CHREGESTA EGR																			  ---- TABLA DONDE SE ALMACENAN LA TRAZABILIDAD DE CAMAS QUE TUVO EL PACIENTE EN HOSPITALIZACION
  INNER JOIN CHCAMASHO AS CAM ON EGR.CODICAMAS=CAM.CODICAMAS									  ---- TABLA DONDE SE ALMACENAN LA CAMAS DE LA INSTITUCION
  INNER JOIN DBO.INUNIFUNC AS FUN ON CAM.UFUCODIGO =FUN.UFUCODIGO AND FUN.UFUTIPUNI ='1'		  ---- TABLA DONDE SE ALMACENA LAS UNIDADES FUNCIONALES
  GROUP BY EGR.NUMINGRES 
)

----*** CTE PARA TRAR EL EL REGISTRO UNICO DE ESTANCIA DEL PACIENTE POR ESE INGRESO ***---

, CTE_CHREGESTA AS
(
  sELECT EST.NUMINGRES
  , EST.CODICAMAS
  FROM CHREGESTA AS EST																		      ---- TABLA DONDE SE ALMACENAN LA TRAZABILIDAD DE CAMAS QUE TUVO EL PACIENTE EN HOSPITALIZACION
  INNER JOIN CTE_TRIAGE_UNICO_POR_ATENCION AS A												      ---- CTE TRIAGE UNICO	
      ON EST.NUMINGRES = A.NUMINGRES														     
	  AND A.NUMERO = 1																		     
  INNER JOIN CTE_MAX_CHREGESTA E															      ---- CTE REGISTRO MAXIMO DE ESTANCIA
  ON E.ID =EST.ID AND E.NUMINGRES =EST.NUMINGRES 
)

----*** CTE PARA IDENTIFICAR SI SE TIENE UN REINGRESO Y TRAE EL ULTIMO INGRESO CON LOS MISMO DIAGNOSTICOS Y QUE NO SUPERE LAS 72 HORAS ***---

, CTE_MAX_REINGRESO AS
(
  SELECT MAX(ING.NUMINGRES) NUMINGRES
  , ING.IPCODPACI
  , A.NUMINGRES [INGRESO NUEVO]
  FROM DBO.ADINGRESO ING																		   ---- TABLA DONDE SE ALMACENAN TODOS DATOS ADMINISTRATIVOS DE LOS INGRESOS U ADMISIONES A LOS PACIENTES
  INNER JOIN CTE_TRIAGE_UNICO_POR_ATENCION A													   
    ON A.IPCODPACI =ING.IPCODPACI 																   
  INNER JOIN DBO.HCREGEGRE EGR																	   ---- TABLA MAESTRA DONDE SE ALMACENAN TODOS LOS EGRESOS QUE SE REALIZAN A LOS PACIENTES POR PARTE DE LOS MEDICOS
    ON ING.NUMINGRES=EGR.NUMINGRES 
    AND EGR.FECALTPAC IS NOT NULL 
  WHERE (ING.IINGREPOR<>2) AND (A.IPCODPACI =ING.IPCODPACI) AND (ING.NUMINGRES < A.NUMINGRES) AND                                                            --- CONDICION PARA QUE SEA UN REINGRESO: DEBE SER DE TIPO 2
	(ISNULL(EGR.FECALTPAC,ING.IFECHAING)>=DATEADD(HOUR,-72,A.[FECHA LLEGADA])) AND (ING.CODDIAING=A.CODDIAEGR OR ING.CODDIAING=A.CODDIAING)                  --- QUE ES INGRESA POR URGENCIAS, DEBE SER ANTES DE 72 HORAS DEL NUEVO
	GROUP BY ING.IPCODPACI, A.NUMINGRES																														 --- INGRESO Y DEBEN COINCIDIR SUS DIAGNOSTICOS 	
)

----*** CTE DE REINGRESO ***---

, CTE_REINGRESO
AS
(
  SELECT ING.NUMINGRES,ING.IPCODPACI ,R.[INGRESO NUEVO] 
  FROM DBO.ADINGRESO AS ING																		      ---- TABLA DONDE SE ALMACENAN TODOS DATOS ADMINISTRATIVOS DE LOS INGRESOS U ADMISIONES A LOS PACIENTES
  INNER JOIN CTE_MAX_REINGRESO R ON R.NUMINGRES=ING.NUMINGRES AND R.IPCODPACI=ING.IPCODPACI           ---- CTE REINGRESO ULTIMO
)

SELECT
  CAST(DB_NAME() AS VARCHAR(9)) AS ID_COMPANY 
  , IIF(CEN.NOMCENATE='SOCIEDAD DE CIRUGIA DE BOGOTA HOSPITAL DE SAN JOSE','San Jose',CEN.NOMCENATE) AS [CENTRO DE ATENCION]
  , CASE PAC.IPTIPODOC
          WHEN 1 THEN 'CC'  				  
          WHEN 2 THEN 'CE'
          WHEN 3 THEN 'TI' 
          WHEN 4 THEN 'RC'
          WHEN 5 THEN 'PA'
          WHEN 6 THEN 'AS'
          WHEN 7 THEN 'MS'
          WHEN 8 THEN 'NU'
          WHEN 9 THEN 'CN'
          WHEN 10 THEN 'CD'
          WHEN 11 THEN 'SC'				  
          WHEN 12 THEN 'PE'
          WHEN 13 THEN 'PT'
          WHEN 14 THEN 'DE'
          WHEN 20 THEN 'OT' END AS [TIPO DOCUMENTO]
    , A.IPCODPACI AS [IDENTIFICACION]
    , PAC.IPPRIAPEL AS [PRIMER APELLIDO]
    , PAC.IPSEGAPEL AS [SEGUNDO APELLIDO]
    , PAC.IPPRINOMB AS [PRIMER NOMBRE]
    , PAC.IPSEGNOMB AS [SEGUNDO NOMBRE]
    , PAC.IPNOMCOMP AS [PACIENTE NOMBRE COMPLETO]
    ,CASE WHEN PAC.IPSEXOPAC = '1' THEN 'Hombre' 
        WHEN PAC.IPSEXOPAC = '2' THEN 'Mujer' 
        END AS [SEXO BIOLOGICO]
    , GEN.Name AS [IDENTIDAD DE GENERO]
    , CAST(PAC.IPFECNACI AS DATE) AS [FECHA NACIMIENTO]
    , PAC.IPTELEFON AS TELEFONO
    , PAC.IPTELMOVI AS MOVIL
    , PAC.IPDIRECCI AS [DIRECCION PACIENTE]
	,CASE
        WHEN DATEDIFF(YEAR, PAC.IPFECNACI, GETDATE()) BETWEEN 0 AND 5 THEN 'Primera Infancia'
        WHEN DATEDIFF(YEAR, PAC.IPFECNACI, GETDATE()) BETWEEN 6 AND 11 THEN 'Infancia'
        WHEN DATEDIFF(YEAR, PAC.IPFECNACI, GETDATE()) BETWEEN 12 AND 17 THEN 'Adolescencia'
        WHEN DATEDIFF(YEAR, PAC.IPFECNACI, GETDATE()) BETWEEN 18 AND 28 THEN 'Juventud'
        WHEN DATEDIFF(YEAR, PAC.IPFECNACI, GETDATE()) BETWEEN 29 AND 59 THEN 'Adultez'
        WHEN DATEDIFF(YEAR, PAC.IPFECNACI, GETDATE()) >= 60 THEN 'Vejez'
        ELSE 'Edad no válida'
    END AS [GRUPO ETARIO]
    ,DATEDIFF(YEAR, PAC.IPFECNACI, GETDATE()) AS [EDAD1]
    ,CONCAT
(
    -- Cálculo de años
    CAST(
        DATEDIFF(YEAR, PAC.IPFECNACI, GETDATE()) - 
        CASE 
            WHEN (MONTH(PAC.IPFECNACI) > MONTH(GETDATE())) 
              OR (MONTH(PAC.IPFECNACI) = MONTH(GETDATE()) AND DAY(PAC.IPFECNACI) > DAY(GETDATE())) 
            THEN 1 
            ELSE 0 
        END AS VARCHAR),
    ' años, ',
    
    -- Cálculo de meses
    CAST(
        (MONTH(GETDATE()) - MONTH(PAC.IPFECNACI) + 
         CASE 
            WHEN DAY(GETDATE()) < DAY(PAC.IPFECNACI) THEN -1 ELSE 0 
         END + 12) % 12 AS VARCHAR),
    ' meses, ',
    
    -- Cálculo de días
    CAST(
        DAY(GETDATE()) - DAY(PAC.IPFECNACI) + 
        CASE 
            WHEN DAY(GETDATE()) < DAY(PAC.IPFECNACI) 
            THEN DAY(EOMONTH(DATEADD(MONTH, -1, GETDATE()))) 
            ELSE 0 
        END AS VARCHAR),
    ' días'
) AS EDAD
    , HA.HealthEntityCode AS [CODIGO EPS/ENTIDAD TERRITORIAL]
    , TP.Nit 'NIT'
    , RTRIM(ISNULL(HABI.ShortName,HA.Name)) 'ENTIDAD'
    , RTRIM(E.Code) 'CODIGO GRUPO ATENCION'
    , RTRIM(E.Name) 'GRUPO ATENCION'
     ,ISNULL(CASE HA.EntityType WHEN 1 THEN 'Contributivo' 
                      WHEN 2 THEN 'Subsidiado' 
                      WHEN 3 THEN 'Vinculado' 
                      WHEN 4 THEN 'Vinculado'
                      WHEN 5 THEN 'Arl' 
                      WHEN 6 THEN 'Prepagada' 
                      WHEN 7 THEN 'Ips Privada' 
                      WHEN 8 THEN 'Ips Pública' 
                      WHEN 9 THEN 'Régimen Especial' 
                      WHEN 10 THEN 'Accidente de Tránsito'
                      WHEN 11 THEN 'Adres' 
                      WHEN 12 THEN 'Otros' 
                      WHEN 99 THEN 'Particulares'
                      END ,'Sin Dato') AS REGIMEN
    , IIF(RIE.NUMINGRES IS NOT NULL,'Maternas',GRU.Name) AS [TIPO PACIENTE]
    , A.[FECHA LLEGADA]
    , IIF(A.[FECHA FIN TRIAGE] IS NULL,'NO','SI') AS [ATENDIDO TRIAGE]
    , A.FECHA_TRIAGE
    , rtrim(convert(char(8),A.FECHA_TRIAGE, 108)) [HORA TRIAGE]
    ,IIF(A.[FECHA LLEGADA] IS NULL,'0.00',FORMAT(DATEDIFF(SECOND,A.[FECHA LLEGADA],A.FECHA_TRIAGE) / 60.0,'N2')) AS [MINUTOS ESPERA LLEGADA VS TRIAGE]
    , IIF(convert(char(8),A.FECHA_TRIAGE,108) BETWEEN '07:00:00' AND '12:59:59','Mañana', IIF(convert(char(8),A.FECHA_TRIAGE,108) BETWEEN '13:00:00' AND '18:59:59','Tarde',
      IIF(((convert(char(8),A.FECHA_TRIAGE,108) BETWEEN '19:00:00' AND '23:59:99') OR (convert(char(8),A.FECHA_TRIAGE,108) BETWEEN '00:00:00' AND '06:59:99')) AND 
        DAY(A.FECHA_TRIAGE)%2=0,'Noche Día Par',
      IIF(((convert(char(8),A.FECHA_TRIAGE,108) BETWEEN '19:00:00' AND '23:59:99')OR(convert(char(8),A.FECHA_TRIAGE,108) BETWEEN '00:00:00' AND '06:59:99')) AND DAY(A.FECHA_TRIAGE)%2=1,'Noche Día Impar','')))) [JORNADA]
    , A.TRIAGECLA AS [CLASIFICACION TRIAGE #]
    ,CASE A.TRIAGECLA  WHEN 1 THEN 'I'  
                     WHEN 2 THEN 'II' 
                     WHEN 3 THEN 'III' 
                     WHEN 4 THEN 'IV' 
                     WHEN 5 THEN 'V' 
                     END AS [CLASIFICACION TRIAGE]
    , A.CODPROSAL AS [DOCUMENTO PROFESIONAL TRIAGE]
    , P.NOMMEDICO AS [PROFESIONAL TRIAGE]
    , ES.DESESPECI AS [ESPECIALIDAD PROFESIONAL TRIAGE]
    , C.OBVAUSENT AS [OBSERVACION AUSENCIA TRIAGE O CONSULTA]
    , IIF(REC.TRIAGECLA IS NULL,'NO','SI') AS [RECLASIFICADO TRIAGE]
    , REC.TRIAGECLA AS [CLASIFICACION DESPUES DE LA RECLASIFICACION]
    ,RTRIM(REC.CODPROSAL)+' - '+REPRO.NOMMEDICO AS [PROFESIONAL RECLASIFICACION]
    , IIF(KC.FECHINIHI IS NULL OR HC.FECHISPAC IS NULL,'NO','SI') AS [ATENDIDO CONSULTA]
    ,A.NUMINGRES AS INGRESO
    ,CASE I.IINGREPOR WHEN 1 THEN 'Urgencias'
                    WHEN 2 THEN 'Urgencias'  
                    WHEN 3 THEN 'Urgencias' 
                    WHEN 4 THEN 'Remitido' 
                    WHEN 5 THEN 'Urgencias' 
                    END AS [TIPO INGRESO]
	,A.[CODIGO UNIDAD FUNCIONAL DE INGRESO]
    ,A.[UNIDAD FUNCIONAL DE INGRESO]
    , PAIU.CODPROSAL AS [DOCUMENTO PROFESIONAL CONSULTA]
    ,PAIU.NOMMEDICO AS [PROFESIONAL CONSULTA]
    ,ESP.DESESPECI AS [ESPECIALIDAD PROFESIONAL CONSULTA]
    , IIF(KC.FECHINIHI IS NULL OR HC.FECHISPAC IS NULL,NULL,CAST(ISNULL(KC.FECHINIHI,I.IFECHAING) as date)) AS [FECHA ATENCION MEDICA]
    , IIF(KC.FECHINIHI IS NULL OR HC.FECHISPAC IS NULL,NULL,rtrim(convert(char(5),ISNULL(KC.FECHINIHI,I.IFECHAING),108))) AS [HORA ATENCION MEDICA]
    ,CAST( IIF(KC.FECHINIHI IS NULL OR HC.FECHISPAC IS NULL,'0.00',FORMAT(DATEDIFF(SECOND,A.FECHA_TRIAGE,ISNULL(KC.FECHINIHI,I.IFECHAING)) / 60.0,'N2')) AS FLOAT)  [MINUTOS ESPERA TRIAGE VS CONSULTA]
    ,CASE WHEN C.CONESTADO = '1' THEN 'Sin Atender' 
        WHEN C.CONESTADO = '2' THEN 'Ausente TRIAGE'--'Ausente en Clasificacion TRIAGE'  
        WHEN C.CONESTADO = '3' THEN 'Sin Ingreso'--'Clasificado sin Ingreso' 
        WHEN C.CONESTADO = '4' THEN 'Con Ingreso'--'Clasificado con Ingreso' 
        WHEN C.CONESTADO = '5' THEN 'Atendido' 
        WHEN C.CONESTADO = '6' THEN 'Ausente Urgencia'--'Ausente en Atencion Inicial Urgencias' 
        WHEN C.CONESTADO = '7' THEN 'Anulado'--'Anulado por error de Parametrizacion' 
        WHEN C.CONESTADO = '8' THEN 'No Atendido'--'No atendido por Clasificacion sin Autorizacion' 
		ELSE 'Atendido' END AS [ESTADO PACIENTE]
    , DX.CODDIAGNO AS [CODIGO DX INGRESO]
	,ISNULL (DX.NOMDIAGNO,'Sin Diagnóstico') AS [DX INGRESO]
	,ISNULL(KC.FECHFINH,HC.FECHISPAC) AS [FECHA HORA FINAL CONSULTA]
    , IIF(KC.FECHINIHI IS NULL,'0.00',FORMAT(DATEDIFF(SECOND,KC.FECHINIHI,KC.FECHFINH) / 60.0,'N2')) [MINUTOS DE CONSULTA]
    , CAST(IIF(A.[FECHA LLEGADA] IS NULL OR KC.FECHINIHI IS NULL,'0.00',FORMAT(DATEDIFF(SECOND,A.[FECHA LLEGADA],KC.FECHINIHI) / 60.0,'N2'))AS FLOAT)  AS [MINUTOS LLEGADA VS ATENCION]
    ,CASE HIS.INDICAPAC WHEN 1 THEN 'Trasladar a Urgencias' 
                      WHEN 2 THEN 'Trasladar a Observación Urgencias' 
                      WHEN 3 THEN 'Trasladar a Hospitalización' 
                      WHEN 4 THEN 'Trasladar a UCI Adulto'
                      WHEN 5 THEN 'Trasladar a UCI Pediatrica' 
                      WHEN 6 THEN 'Trasladar a UCI Neonatal' 
                      WHEN 7 THEN 'Trasladar a Consulta Externa' 
                      WHEN 8 THEN 'Trasladar a Cirugía'
                      WHEN 9 THEN 'Hospitalización en Casa' 
                      WHEN 10 THEN 'Referencia' 
                      WHEN 11 THEN 'Morgue' 
                      WHEN 12 THEN 'Salida' 
                      WHEN 13 THEN 'Continua en la Unidad'
                      WHEN 14 THEN 'Paciente en Tratamiento' 
                      WHEN 15 THEN 'Retiro Voluntario' 
                      WHEN 16 THEN 'Fuga' 
                      WHEN 17 THEN 'Salida Parcial' 
                      WHEN 18 THEN 'Estancia Con la Madre'
                      WHEN 19 THEN 'U.Cuidado Intermedio' 
                      WHEN 20 THEN 'U.Básica' 
                      WHEN 21 THEN 'Hospitalización Pediatría' ELSE '' end [DESTINO URGENCIAS]
    , EGR.FECALTPAC [ALTA MEDICA URGENCIA]
    , DXA.CODDIAGNO AS [CODIGO DX EGRESO]
    ,ISNULL (DXA.NOMDIAGNO,'Sin Diagnóstico') AS [DX EGRESO]
    , FUNEA.UFUCODIGO [CODIGO UNIDAD FUNCIONAL DE EGRESO]
    , FUNEA.UFUDESCRI [UNIDAD EGRESO URGENCIAS]
    , CASE WHEN TRA.MEDIOTRASPORTE = 1 THEN 'Básica' 
       WHEN TRA.MEDIOTRASPORTE = 2 THEN 'Medicalizada' 
       END AS [TIPO DE AMBULACIA]
    , CAM.NUMCAMHOS [CAMA OBSERVACION URGENCIA]
    , IIF(MUE.ID IS NULL,'NO','SI') AS FALLECIDO
	,MUE.FECHA_MUERTE
    , IIF(INGR.NUMINGRES IS NULL,'NO','SI') REINGRESO
    , INGR.NUMINGRES [NUMERO DE REINGRESO]
	, A.ID AS [ID TRIAGE]
    , 1 AS CANTIDAD
    , CAST(A.[FECHA LLEGADA] AS DATE) [FECHA BUSQUEDA]
    , YEAR(A.[FECHA LLEGADA]) AS [A O BUSQUEDA]
    , MONTH(A.[FECHA LLEGADA]) AS [MES BUSQUEDA]
    ,CONCAT(FORMAT(MONTH(A.[FECHA LLEGADA]), '00') ,' - ',CASE MONTH(A.[FECHA LLEGADA]) WHEN 1 THEN 'ENE'
                                                                                      WHEN 2 THEN 'FEB'
                                                                                      WHEN 3 THEN 'MAR'
                                                                                      WHEN 4 THEN 'ABR'
                                                                                      WHEN 5 THEN 'MAY'
                                                                                      WHEN 6 THEN 'JUN'
                                                                                      WHEN 7 THEN 'JUL'
                                                                                      WHEN 8 THEN 'AGO'
                                                                                      WHEN 9 THEN 'SEP'
                                                                                      WHEN 10 THEN 'OCT'
                                                                                      WHEN 11 THEN 'NOV'
                                                                                      WHEN 12 THEN 'DIC' END) AS [MES NOMBRE BUSQUEDA]
  ,CASE DATENAME(dw,A.[FECHA LLEGADA]) WHEN 'Monday' THEN 'LUN'
                                       WHEN 'Tuesday' THEN 'MAR' 
                                       WHEN 'Wednesday' THEN 'MIE' 
                                       WHEN 'Thursday' THEN 'JUE' 
                                       WHEN 'Friday' THEN 'VIE'
                                       WHEN 'Saturday' THEN 'SAB' 
                                       WHEN 'Sunday' THEN 'DOM' END AS [DIA SEMANA]
    , CONVERT(DATETIME,GETDATE() AT TIME ZONE 'Pakistan Standard Time',1) AS ULT_ACTUAL

 FROM CTE_TRIAGE_UNICO_POR_ATENCION A
 INNER JOIN dbo.INPACIENT AS PAC                                                                        ---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LOS PACIENTES
    ON A.IPCODPACI = PAC.IPCODPACI AND A.NUMERO=1
 INNER JOIN Contract.CareGroup AS E																		---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LOS GRIPOS DE ATENCIÓN QUE TIENE EL PACIENTE DATO DE CONTRATACION
    ON E.Id = PAC.GENCAREGROUP
 LEFT JOIN Admissions.GenderTypes AS GEN																---- TABLA DONDE SE ALAMCENAN LOS TIPOS DE GENEROS						
    ON PAC.IdGenderIdentity=GEN.Id
 LEFT JOIN dbo.ADCENATEN AS CEN																			---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LAS SUCRUSALES O SEDES, CENTROS DE ATENCION 
    ON A.CODCENATE=CEN.CODCENATE
 LEFT JOIN dbo.INPROFSAL AS P																			---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LOS PROFESIONALES DE LA SALUD
    ON  A.CODPROSAL=P.CODPROSAL
 LEFT JOIN dbo.ADCONTURG AS C																			---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LOS CONTROLES DE LLEGADA A URGENCIAS
    ON A.TRIANUMER=C.CODCONCEC 
 LEFT JOIN dbo.ADINGRESO AS I																			---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LAS ADMISIONES O INGRESOS DE LOS PACIENTES
    ON A.NUMINGRES = I.NUMINGRES 
 LEFT JOIN Contract.HealthAdministrator AS HA															---- TABLA DONDE SE ALAMCENAN LOS DATOS DE ENTIDADES O EPS
    ON HA.Id =ISNULL(I.GENCONENTITY,PAC.GENCONENTITY)
 LEFT JOIN Report.BI_HealthAdministrator AS HABI														---- TABLA ALTERNA DONDE SE ALAMCENAN LOS DATOS DE ENTIDADES CON NOMBRE CORTO
    ON HABI.HealthAdministratorId=HA.Id AND HABI.Code=HA.Code 
 LEFT JOIN Common.ThirdParty AS TP																	    ---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LOS TERCEROS
    ON TP.Id =HA.ThirdPartyId 
 LEFT JOIN Admissions.TypesPopulationGroups AS GRU                                                      ---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LOS GRUPOS POBLACIONLAES
    ON C.CODTIPPAC=GRU.Code
 LEFT JOIN dbo.INESPECIA AS ES																		    ---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LAS ESPECIALIDADES
    ON P.CODESPEC1=ES.CODESPECI
 LEFT JOIN CTE_ANTECEDENTES_GINECOBSTETRICOS AS RIE  
    ON A.NUMINGRES=RIE.NUMINGRES AND A.NUMERO=1
 LEFT JOIN CTE_HCURGING1 AS KC  
    ON A.NUMINGRES = KC.NUMINGRES ---cambie k por KC
 LEFT JOIN CTE_HCHISPACA1 AS HC
    ON HC.NUMINGRES =A.NUMINGRES 
 LEFT JOIN dbo.INPROFSAL AS PAIU																	    ---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LOS PROFESIONALES DE LA SALUD		
    ON ISNULL(KC.CODPROSAL,HC.CODPROSAL)=PAIU.CODPROSAL 
 LEFT JOIN dbo.INESPECIA AS ESP  
    ON PAIU.CODESPEC1=ESP.CODESPECI
 LEFT JOIN dbo.INDIAGNOS AS DX																			---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LOS DIAGNOSTICOS
    ON DX.CODDIAGNO = I.CODDIAING 
 LEFT JOIN dbo.INDIAGNOS AS DXA																			---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LOS DIAGNOSTICOS
    ON DXA.CODDIAGNO=I.CODDIAEGR
 LEFT JOIN CTE_HCHISPACA2 AS HIS  
    ON HIS.NUMINGRES =A.NUMINGRES 
 LEFT JOIN CTE_HCREGEGRE AS EGR
    ON EGR.NUMINGRES =A.NUMINGRES
 LEFT JOIN dbo.INUNIFUNC AS FUNEA																		---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LAS UNIDADES FUNCIONALES
    ON EGR.UFUCODIGO = FUNEA.UFUCODIGO
 LEFT JOIN CTE_HCREFCONP AS OTRA
    ON OTRA.NUMINGRES=I.NUMINGRES
 LEFT JOIN dbo.HCTRASLADOS AS TRA  
    ON TRA.IDHCREFCONP=OTRA.AUTO 
 LEFT JOIN CTE_CHREGESTA AS EST
    ON EST.NUMINGRES=A.NUMINGRES
 LEFT JOIN dbo.CHCAMASHO AS CAM																			---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LAS CAMAS
    ON CAM.CODICAMAS =EST.CODICAMAS 
 LEFT JOIN dbo.INUNIFUNC AS FUN  
    ON CAM.UFUCODIGO =FUN.UFUCODIGO 
 LEFT JOIN CTE_MUERTOS AS MUE  
    ON A.NUMINGRES=MUE.INGRESO 
 LEFT JOIN CTE_REINGRESO AS INGR
    ON INGR.IPCODPACI=A.IPCODPACI AND INGR.[INGRESO NUEVO]=A.NUMINGRES 
 LEFT JOIN CTE_RECLA_TRIAGE AS REC
    ON REC.TRIANUMER =A.TRIANUMER AND REC.NUMINGRES =A.NUMINGRES AND REC.TRIAGECLA <> A.TRIAGECLA  
 LEFT JOIN dbo.INPROFSAL AS REPRO																	 	---- TABLA DONDE SE ALAMCENAN LOS DATOS DE LOS PROFESIONALES DE LA SALUD												
    ON REC.CODPROSAL=REPRO.CODPROSAL
 WHERE A.NUMERO=1 

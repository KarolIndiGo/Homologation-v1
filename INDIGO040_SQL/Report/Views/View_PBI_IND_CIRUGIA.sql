-- Workspace: SQLServer
-- Item: INDIGO040 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: View_PBI_IND_CIRUGIA
-- Extracted by Fabric SQL Extractor SPN v3.9.0


CREATE view [Report].[View_PBI_IND_CIRUGIA] as

 SELECT 
  CAST(DB_NAME() AS VARCHAR(9)) AS ID_COMPANY, 
  YEAR(PR.FECHORAIN) * 100 + MONTH(PR.FECHORAIN) [ID_TIEMPO],
  CASE
   WHEN CODESTPQX <> 6 THEN 'Agendada' 
   ELSE 'Cancelada'
  END [ESTADO PROGRAMACION],
  0 AS [DURACION EN MINUTOS],
  1 [CANTIDAD],
  LTRIM(RTRIM(ISNULL(PR.AGENSALAC,0))) AS [CODISALA],
  CONVERT(int, LTRIM(RTRIM(PR.CODESPECI))) AS [ID_ESPEC], 
  19 ID_TUNID_FUN,
  CONVERT(DATETIME,GETDATE() AT TIME ZONE 'Pakistan Standard Time',1) AS ULT_ACTUAL
 FROM
  AGEPROGQX PR
  LEFT JOIN AGENSALAC SALA ON SALA.CODCONCEC = PR.AGENSALAC
 WHERE
  SALA.TIPOSALA = 'Q'

UNION ALL

 SELECT 
  CAST(DB_NAME() AS VARCHAR(9)) AS ID_COMPANY, 
  YEAR(QX.FECHORINI) * 100 + MONTH(QX.FECHORINI) [ID_TIEMPO],
  IIF(PR.IDAGENDA IS NULL, 'No Programada', 'Cirugia Realizada') [ESTADO PROGRAMACION],
  DATEDIFF(MINUTE,QX.FECHORINI,QX.FECHORFIN) AS [DURACION EN MINUTOS],
  1 [CANTIDAD],
  CONVERT(int, LTRIM(RTRIM(ISNULL(PR.AGENSALAC,0)))) AS [CODISALA], 
  CONVERT(int, LTRIM(RTRIM(PRO.CODESPEC1))) AS [ID_ESPEC], 
  19 ID_TUNID_FUN,
  CONVERT(DATETIME,GETDATE() AT TIME ZONE 'Pakistan Standard Time',1) AS ULT_ACTUAL
 FROM
  HCQXINFOR QX 
  INNER JOIN INPROFSAL PRO ON PRO.CODPROSAL=QX.CODPROSAL
  LEFT JOIN AGEPROGQX PR ON QX.NUMINGRES=PR.NUMINGRES AND QX.CODSERIPS=PR.CODSERIPS 
 WHERE
  QX.TIPOINFORME = 1

--IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Report].[View_PBI_IND_CIRUGIA]') AND type in (N'U'))
-- DROP EXTERNAL TABLE [Report].[View_PBI_IND_CIRUGIA]
--GO

--CREATE EXTERNAL TABLE [Report].[View_PBI_IND_CIRUGIA]
-- (
--	[ID_COMPANY] [varchar](9) NULL,
--	[ID_TIEMPO] [int] NULL,
--	[ESTADO PROGRAMACION] [varchar](46) NOT NULL,
--	[DURACION EN MINUTOS] [int] NULL,
--	[CANTIDAD] [int] NULL,
--	[CODISALA] [int] NOT NULL,
--	[ID_ESPEC] [int] NULL,
--	[ID_TUNID_FUN] [int] NULL,
--	[ULT_ACTUAL] [datetime] NULL
-- )
--WITH (DATA_SOURCE = [INDIGO036],SCHEMA_NAME = N'Report',OBJECT_NAME = N'View_PBI_IND_CIRUGIA')
--GO

-- Workspace: SQLServer
-- Item: INDIGO040 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: AtencionHemodinamia
-- Extracted by Fabric SQL Extractor SPN v3.9.0




CREATE VIEW [Report].[AtencionHemodinamia]
AS

WITH CTE_ORDENES
AS
(
SELECT ROW_NUMBER () OVER (PARTITION BY ORD.IPCODPACI ORDER BY ORD.FECORDMED DESC ) 'NUMERO',  ORD.IPCODPACI,ORD.FECORDMED,ISNULL(CAST(ORD.FECORDMED AS DATE),'') 'FECHA SOLICITUD', ISNULL(CAST(ORD.FECORDMED AS TIME),'') 'HORA SOLICITUD'

FROM HCORDPRON ORD

WHERE ORD.CODSERIPS IN ('903839','873501','877602','360202','360300','372102','372503','395018','395023','352103','355102','358710','360101',
'360102','360104','360105','360106','360201','360401','360402','360501','360600','372101','372201','372202','372301','372302','372401',
'372402','372501','372502','372601','372602','372701','372702','372801','372802','373412','373413','373414','378001','378201','378301',
'378401','378602','378604','378606','378901','378902','379003','380111','385120','385220','385620','385720','385720','385920','387300',
'395001','395010','395022','395024','395025','395026','395027','395028','395030','395031','395060','395061','395062','395063','395080',
'395081','395101','395102','395103','395104','395202','395205','395211','395212','395213','395214','395215','395216','395217','395218',
'395219','395220','395301','395302','395303','395304','395305','395306','395307','395308','395309','395400','395600','395700','395800',
'510301','872202','874133','875101','876110','876121','876122','876123','876131','876132','876140','876212','876241','877201','878201',
'878301','893802','895801','896501','896502','896700','896801','896802','896803','896901','996101','996102')

)



SELECT ISNULL(CAST(ORD.FECORDMED AS DATE),'') 'FECHA SOLICITUD', ISNULL(CAST(ORD.FECORDMED AS TIME),'') 'HORA SOLICITUD', US1.NOMUSUARI 'USUARIO ASIGNA' ,CAST(CIT.FECHORAIN AS DATE) 'FECHA AGENDADA',
CAST(FECHORAIN AS TIME) 'HORA INICIA', CAST(FECHORAFI AS TIME) 'HORA FIN',ID.NOMBRE 'TIPO DOC' ,CIT.IPCODPACI 'NUMERO DOC',PAC.IPNOMCOMP 'NOMBRE',PAC.IPFECNACI 'FECHA DE NACIMIENTO', 
DATEDIFF(YEAR,PAC.IPFECNACI,GETDATE()) 'EDAD', ISNULL(CIT.NUMINGRES,'') 'HCL/INGRESO', CG.Name 'GRUPO DE ATENCION',HA.Name 'ENTIDAD', PAC.IPTELEFON 'TEL FIJO',
PAC.IPTELMOVI 'TEL CELULAR','Ambulatorio' 'AMBITO',
CASE CIT.TIPSOLICITU WHEN 1 THEN 'Cita Medica' WHEN 2 THEN 'Cita Apoyo Diagnostico' WHEN 3 THEN 'Cita Tratamiento Especiales' END 'TIPO DE CITA',
CIT.CODSERIPS 'COD PROCEDIMIENTO', CUPS.DESSERIPS 'PROCEDIMIENTO',ISNULL(CIT.CODPROSAL,'') 'COD PROFESIONAL',
PROF.NOMMEDICO 'NOMBRE PROFESIONAL' , ESP.DESESPECI 'ESPECIALIDAD',
CASE CIT.CODESTCIT WHEN 0 THEN 'Asignada'
				   WHEN 1 THEN 'Cumplida'
				   WHEN 2 THEN 'Incumplida'
				   WHEN 3 THEN 'PreAsignada'
				   WHEN 4 THEN 'Cita Cancelada'
				   WHEN 5 THEN 'Inatencion'
				   ELSE 'Procedimiento Intrahospitalario' END 'ESTADO',ISNULL(CIT.OBSERVACI,'') 'OBSERVACION DE LA CITA',
ISNULL(US2.NOMUSUARI,'') 'USUARIO CANCELA', 
CASE WHEN CIT.CODCAUCAN IS NOT NULL  THEN CAN.DESCAUCAN ELSE '' END 'MOTIVO DE CANCELACION', CIT.OBSCAUCAN 'OBSERVACION CANCELACION'




FROM AGASICITA CIT
INNER JOIN INPACIENT PAC ON PAC.IPCODPACI=CIT.IPCODPACI
INNER JOIN Contract.CAREGROUP CG ON CG.ID=CIT.GENCAREGROUP
INNER JOIN Contract.HealthAdministrator HA ON HA.ID=CIT.GENCONENTITY
INNER JOIN ADTIPOIDENTIFICA ID ON ID.CODIGO=PAC.IPTIPODOC
INNER JOIN INCUPSIPS CUPS ON CUPS.CODSERIPS=CIT.CODSERIPS
LEFT JOIN INESPECIA ESP ON ESP.CODESPECI=CIT.CODESPECI
LEFT JOIN INPROFSAL PROF ON PROF.CODPROSAL=CIT.CODPROSAL
LEFT JOIN SEGusuaru US1 ON US1.CODUSUARI=CIT.CODUSUASI
LEFT JOIN SEGusuaru US2 ON US2.CODUSUARI=CIT.CANCELUSU
LEFT JOIN AGCAUCANC CAN ON CAN.CODCAUCAN=CIT.CODCAUCAN
LEFT JOIN CTE_ORDENES ORD ON ORD.IPCODPACI=CIT.IPCODPACI AND ORD.NUMERO IN (1)



WHERE CIT.CODESPECI IN (121) OR CIT.IDSALA IN (1,31)


UNION ALL

SELECT ISNULL(CAST(ORD.FECORDMED AS DATE),'') 'FECHA SOLICITUD', ISNULL(CAST(ORD.FECORDMED AS TIME),'') 'HORA SOLICITUD', 'INTRAHOSPITALARIO' 'USUARIO ASIGNA' ,CAST(CIT.FECHAREGISTRO AS DATE) 'FECHA AGENDADA',
CAST(CIT.FECHAREGISTRO  AS TIME) 'HORA INICIA', CAST(CIT.FECHAREGISTRO  AS TIME) 'HORA FIN',ID.NOMBRE 'TIPO DOC' ,CIT.IPCODPACI 'NUMERO DOC',PAC.IPNOMCOMP 'NOMBRE',PAC.IPFECNACI 'FECHA DE NACIMIENTO', 
DATEDIFF(YEAR,PAC.IPFECNACI,GETDATE()) 'EDAD', ISNULL(CIT.NUMINGRES,'') 'HCL/INGRESO', CG.Name 'GRUPO DE ATENCION',HA.Name 'ENTIDAD', PAC.IPTELEFON 'TEL FIJO',
PAC.IPTELMOVI 'TEL CELULAR','Procedimiento Menor Intrahospitalario' 'AMBITO',
'Procedimiento Intrahospitalario' 'TIPO DE CITA',
CO.CODSERIPS 'COD PROCEDIMIENTO', CUPS.DESSERIPS 'PROCEDIMIENTO',ISNULL(CIT.CODPROSAL,'') 'COD PROFESIONAL',
PROF.NOMMEDICO 'NOMBRE PROFESIONAL' , ESP.DESESPECI 'ESPECIALIDAD',
'Procedimiento Intrahospitalario' 'ESTADO','' 'OBSERVACION DE LA CITA',
'' 'USUARIO CANCELA', '' 'MOTIVO DE CANCELACION', '' 'OBSERVACION CANCELACION'




FROM HCPLAOTRPROC CIT
INNER JOIN HCPLAOTRPROCUPS CO ON CO.IDHCPLAOTRPROC=CIT.ID
INNER JOIN HCHISPACA HIS ON HIS.ID=CIT.IDHCHISPACA
INNER JOIN INPACIENT PAC ON PAC.IPCODPACI=CIT.IPCODPACI
INNER JOIN ADINGRESO ING ON ING.NUMINGRES=CIT.NUMINGRES
INNER JOIN Contract.CAREGROUP CG ON CG.ID=ING.GENCAREGROUP
INNER JOIN Contract.HealthAdministrator HA ON HA.ID=ING.GENCONENTITY
INNER JOIN ADTIPOIDENTIFICA ID ON ID.CODIGO=PAC.IPTIPODOC
INNER JOIN INCUPSIPS CUPS ON CUPS.CODSERIPS=CO.CODSERIPS
LEFT JOIN INESPECIA ESP ON ESP.CODESPECI=HIS.CODESPTRA
LEFT JOIN INPROFSAL PROF ON PROF.CODPROSAL=CIT.CODPROSAL
LEFT JOIN CTE_ORDENES ORD ON ORD.IPCODPACI=CIT.IPCODPACI AND ORD.NUMERO IN (1)



WHERE HIS.CODESPTRA IN (121) 


UNION ALL


SELECT ISNULL(CAST(ORD.FECORDMED AS DATE),'') 'FECHA SOLICITUD', ISNULL(CAST(ORD.FECORDMED AS TIME),'') 'HORA SOLICITUD', 'INTRAHOSPITALARIO' 'USUARIO ASIGNA' ,CAST(ING.FECREGCRE AS DATE) 'FECHA AGENDADA',
CAST(CIT.FECHORFIN  AS TIME) 'HORA INICIA', CAST(CIT.FECHORFIN  AS TIME) 'HORA FIN',ID.NOMBRE 'TIPO DOC' ,CIT.IPCODPACI 'NUMERO DOC',PAC.IPNOMCOMP 'NOMBRE',PAC.IPFECNACI 'FECHA DE NACIMIENTO', 
DATEDIFF(YEAR,PAC.IPFECNACI,GETDATE()) 'EDAD', ISNULL(CIT.NUMINGRES,'') 'HCL/INGRESO', CG.Name 'GRUPO DE ATENCION',HA.Name 'ENTIDAD', PAC.IPTELEFON 'TEL FIJO',
PAC.IPTELMOVI 'TEL CELULAR','Procedimiento Qx' 'AMBITO',
'Procedimiento Intrahospitalario' 'TIPO DE CITA',
CO.CODSERIPS 'COD PROCEDIMIENTO', CUPS.DESSERIPS 'PROCEDIMIENTO',ISNULL(CIT.CODPROSAL,'') 'COD PROFESIONAL',
PROF.NOMMEDICO 'NOMBRE PROFESIONAL' , ESP.DESESPECI 'ESPECIALIDAD',
'Procedimiento Intrahospitalario' 'ESTADO','' 'OBSERVACION DE LA CITA',
'' 'USUARIO CANCELA', '' 'MOTIVO DE CANCELACION', '' 'OBSERVACION CANCELACION'




FROM HCQXINFOR CIT
INNER JOIN HCQXREALI CO ON CO.CONSECUQX=CIT.AUTO
INNER JOIN INPACIENT PAC ON PAC.IPCODPACI=CIT.IPCODPACI
INNER JOIN ADINGRESO ING ON ING.NUMINGRES=CIT.NUMINGRES
INNER JOIN Contract.CAREGROUP CG ON CG.ID=ING.GENCAREGROUP
INNER JOIN Contract.HealthAdministrator HA ON HA.ID=ING.GENCONENTITY
INNER JOIN ADTIPOIDENTIFICA ID ON ID.CODIGO=PAC.IPTIPODOC
INNER JOIN INCUPSIPS CUPS ON CUPS.CODSERIPS=CO.CODSERIPS
LEFT JOIN INESPECIA ESP ON ESP.CODESPECI=CIT.CODESPECI
LEFT JOIN INPROFSAL PROF ON PROF.CODPROSAL=CIT.CODPROSAL
LEFT JOIN CTE_ORDENES ORD ON ORD.IPCODPACI=CIT.IPCODPACI AND ORD.NUMERO IN (1)



WHERE CIT.CODESPECI IN (121)

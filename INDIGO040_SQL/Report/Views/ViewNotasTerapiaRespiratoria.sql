-- Workspace: SQLServer
-- Item: INDIGO040 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: ViewNotasTerapiaRespiratoria
-- Extracted by Fabric SQL Extractor SPN v3.9.0





CREATE VIEW [Report].[ViewNotasTerapiaRespiratoria]

AS



WITH CTE_NOTAS_TERAPIA
AS
(
SELECT ROW_NUMBER () OVER (PARTITION BY NUMINGRES ORDER BY NUMINGRES) 'NUMERO',NUMINGRES, IPCODPACI, FECREGIST, CODPROSAL

FROM HCCTRNOTT 


WHERE CODPROSAL IN ('1000061609','1000255174','1010057049','1010063091','1010122566','1012450609','1013679232','1014234285','1015447306','1015471112','1023926214','1023959777',
'1024501770','1024553950','1026288159','1033764534','1033766136','1033814142','1104702423','1110465913','1143353947','40437410','43972981','46369872','51954776','52207979',  
'52218035','52323642','52354126','52559170','52819268','52888398','53071396','53122155','56076279','80064102') 

GROUP BY NUMINGRES, IPCODPACI, FECREGIST, CODPROSAL
),

CTE_CUENTA
AS
(
SELECT TOP (100) PERCENT COUNT(NUMINGRES) CANTIDAD, NUMINGRES

FROM HCCTRNOTT 


WHERE CODPROSAL IN ('1000061609','1000255174','1010057049','1010063091','1010122566','1012450609','1013679232','1014234285','1015447306','1015471112','1023926214','1023959777',
'1024501770','1024553950','1026288159','1033764534','1033766136','1033814142','1104702423','1110465913','1143353947','40437410','43972981','46369872','51954776','52207979',  
'52218035','52323642','52354126','52559170','52819268','52888398','53071396','53122155','56076279','80064102') 

GROUP BY NUMINGRES
)


SELECT DISTINCT CAST(TER.FECREGIST AS DATE) 'FECHA DE BUSQUEDA',OX.IPCODPACI 'ID PACIENTE',PAC.IPNOMCOMP 'NOMBRE', OX.NUMINGRES '# INGRESO', OX.UFUCODIGO 'COD UF',FUN.UFUDESCRI 'UNIDAD FUNCIONAL',OX.CODVIAADM 'COD. DISPOSITIVO', 
PAR.DESVIAADM 'DISPOSITIVO', CU.CANTIDAD  'NUMERO DE NOTAS'



FROM dbo.HCCONOXIG OX
INNER JOIN INPACIENT PAC ON PAC.IPCODPACI=OX.IPCODPACI
INNER JOIN INUNIFUNC FUN ON FUN.UFUCODIGO=OX.UFUCODIGO
INNER JOIN CTE_CUENTA CU ON CU.NUMINGRES=OX.NUMINGRES
LEFT JOIN dbo.HCPARCONO PAR ON PAR.CODVIAADM=OX.CODVIAADM
LEFT JOIN CTE_NOTAS_TERAPIA TER ON TER.IPCODPACI=OX.IPCODPACI AND OX.NUMINGRES=TER.NUMINGRES





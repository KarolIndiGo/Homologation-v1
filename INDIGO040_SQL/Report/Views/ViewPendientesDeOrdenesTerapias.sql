-- Workspace: SQLServer
-- Item: INDIGO040 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: ViewPendientesDeOrdenesTerapias
-- Extracted by Fabric SQL Extractor SPN v3.9.0




CREATE VIEW [Report].[ViewPendientesDeOrdenesTerapias]
as

WITH CTE_TERAPIAS
AS
(
	SELECT	 'TERAPIAS' EntityName,iif(A.GENSERVICEORDER IS NULL,'SIN ORDEN','CON ORDEN')  'ORDENE DE SERVICIO' ,'HOSPITALARIO'  'AMBITO',
    A.CODSERIPS 'CODIGO CUPS',B.DESSERIPS 'PROCEDIMIENTO CUPS',A.NUMINGRES 'INGRESO',A.IPCODPACI 'IDENTIFICACION',RTRIM(i.IPNOMCOMP) 'PACIENTE' ,
	RTRIM(D.UFUDESCRI) AS 'UNIDAD FUNCIONAL',RTRIM(C.NOMMEDICO) AS 'PROFESIONAL',A.FECHISPAC 'FECHA REALIZACION'
	FROM dbo.HCPROCTER A 
	INNER JOIN dbo.INCUPSIPS B ON A.CODSERIPS=B.CODSERIPS 
	INNER JOIN dbo.INPROFSAL C ON A.CODPROSAL=C.CODPROSAL 
	INNER JOIN dbo.INUNIFUNC D ON A.UFUCODIGO=D.UFUCODIGO
	inner join dbo.INPACIENT i on a.IPCODPACI = i.IPCODPACI 
	where A.GENSERVICEORDER IS NULL
UNION ALL
	SELECT	'TERAPIAS' EntityName,iif(A.GENSERVICEORDER IS NULL,'SIN ORDEN','CON ORDEN')  'ORDENE DE SERVICIO' ,'HOSPITALARIO'  'AMBITO',
    A.CODSERIPS 'CODIGO CUPS',B.DESSERIPS 'PROCEDIMIENTO CUPS',A.NUMINGRES 'INGRESO',A.IPCODPACI 'IDENTIFICACION',RTRIM(i.IPNOMCOMP) 'PACIENTE' ,
	RTRIM(D.UFUDESCRI) AS 'UNIDAD FUNCIONAL',RTRIM(C.NOMMEDICO) AS 'PREOFESIONAL',A.FECHISPAC 'FECHA REALIZACION'
	FROM dbo.HCPROCTER A 
	INNER JOIN dbo.INCUPSIPS B ON A.CODSERIPS=B.CODSERIPS 
	INNER JOIN dbo.INPROFSAL C ON A.CODPROSAL=C.CODPROSAL 
	INNER JOIN dbo.INUNIFUNC D ON A.UFUCODIGO=D.UFUCODIGO
	INNER JOIN dbo.HCINGRESORECNAC INGMH  on a.NUMINGRES = INGMH .NUMINGRESHIJO
	INNER JOIN dbo.HCRECINAC RN  on INGMH.NUMINGRESHIJO  = rn.NUMINGRESHIJO  
	INNER JOIN dbo.ADINGRESO AS ING  on ING.NUMINGRES = INGMH.NUMINGRESHIJO 
	inner join dbo.INPACIENT i on a.IPCODPACI = i.IPCODPACI
	where A.GENSERVICEORDER IS NULL
),

CTE_ALTA_MEDICA
AS
(
  SELECT EGR.NUMINGRES ,EGR.IPCODPACI ,MAX(FECALTPAC) 'FECHA ALTA' FROM DBO.HCREGEGRE EGR with (nolock) 
  INNER JOIN CTE_TERAPIAS AS PEN with (nolock) ON PEN.INGRESO =EGR.NUMINGRES 
  GROUP BY EGR.NUMINGRES ,EGR.IPCODPACI
),

CTE_ESTANCIA_MAYOR
AS
(
  SELECT C.NUMINGRES ,C.IPCODPACI,C.CODICAMAS  ,C.FECINIEST 'FECHA ESTANCIA',C.REGESTADO,C.CODTIPEST,C.ID    FROM dbo.CHREGESTA C with (nolock)
  INNER JOIN CTE_TERAPIAS  AS PEN ON PEN.INGRESO =C.NUMINGRES 
  INNER JOIN(SELECT C.NUMINGRES ,C.IPCODPACI ,MAX(C.ID ) IDD FROM dbo.CHREGESTA C with (nolock) GROUP BY C.NUMINGRES ,C.IPCODPACI) AS G ON G.IDD =C.ID 
),

CTE_CAMAS
AS
(
     SELECT FUN.UFUDESCRI 'UNIDAD FUNCIONAL' ,C.IPCODPACI 'IDENTIFICACION' ,C.NUMINGRES 'INGRESO',A.NUMCAMHOS 'CAMA',G.DESTIPEST 'TIPO ESTANCIA'  ,C.ID  'ID_ESTANCIA', 
	 A.CODICAMAS 'ID_CAMAS', CEN.NOMCENATE 'CENTRO DE ATENCION',A.CODCLAHAB ,A.CODCLACAM 
	 FROM dbo.CHCAMASHO A with (nolock)
	 INNER JOIN DBO.INUNIFUNC AS FUN with (nolock) ON A.UFUCODIGO =FUN.UFUCODIGO 
	 INNER JOIN CTE_ESTANCIA_MAYOR C with (nolock) ON A.CODICAMAS=C.CODICAMAS AND C.REGESTADO = 1 
     INNER JOIN dbo.CHTIPESTA G with (nolock) ON G.CODTIPEST=C.CODTIPEST 
	 INNER JOIN DBO.ADCENATEN AS CEN with (nolock) ON CEN.CODCENATE =A.CODCENATE 
),

CTE_HISTORIAS_AMBULATORIAS
AS
(
  SELECT HIS.NUMINGRES ,HIS.IPCODPACI ,MAX(FECHISPAC) AS 'FECHA ALTA'    FROM  DBO.HCHISPACA HIS with (nolock)
  INNER JOIN CTE_TERAPIAS AS PEN with (nolock) ON PEN.INGRESO =HIS.NUMINGRES 
  WHERE HIS.GENCONEXT =1
  GROUP BY HIS.NUMINGRES ,HIS.IPCODPACI
)

SELECT 
 CAST(DB_NAME() AS VARCHAR(9)) AS ID_COMPANY, 
 IMG.*, ING.IESTADOIN 'ESTADO',F.InvoiceNumber 'NRO FACTURA',
 ALT.[FECHA ALTA],
 CONVERT(DATETIME,GETDATE() AT TIME ZONE 'Pakistan Standard Time',1) AS ULT_ACTUAL
FROM 
 CTE_TERAPIAS IMG
 INNER JOIN DBO.ADINGRESO AS ING ON ING.NUMINGRES= IMG.INGRESO
 LEFT JOIN CTE_ALTA_MEDICA AS ALT with (nolock) ON ALT.NUMINGRES =IMG.INGRESO 
 LEFT JOIN Billing .Invoice AS F ON F.AdmissionNumber =IMG.INGRESO 

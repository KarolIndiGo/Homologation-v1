-- Workspace: SQLServer
-- Item: INDIGO040 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: ViewAvailabilityAgenda
-- Extracted by Fabric SQL Extractor SPN v3.9.0



/*******************************************************************************************************************
Nombre: [Report].[ViewAvailabilityAgenda]
Tipo:Vista
Profesional:Nilson Miguel Galindo
Fecha:
---------------------------------------------------------------------------
Modificaciones
_____________________________________________________________________________
Version 1
Persona que modifico:Amira Gil Meneses
Fecha:24-01-2025
Observaciones: Se adicionan la información sobre los bloqueos de Agenda por parte de los Medicos.
------------------------------------------------------------------------------
Version 2
Persona que modifico:
Observación:
Fecha:
------------------------------------------------------------------------------
Version 3
Persona que modifico:
Observación:
Fecha:
-------------------------------------------------------------------------------

***********************************************************************************************************************************/

CREATE VIEW [Report].[ViewAvailabilityAgenda]
AS
WITH CTE_AGENDA AS (
SELECT 
CAST(DB_NAME() AS VARCHAR(9)) AS [ID_COMPANY], 
--MAX(A.CODAUTONU) CODAUTONU, 
C.NOMCENATE 'CENTRO DE ATENCION', 
CON.DESCRICON AS 'CONSULTORIO', 
E.CODPROSAL AS [IDENTIFICACION PROFESIONAL],
E.NOMMEDICO 'PROFESIONAL', 
B.DESESPECI 'ESPECIALIDAD', 
CONVERT(VARCHAR, MIN(FECHORAIN), 23) 'FECHA INICIAL DE AGENDA', 
CONVERT(VARCHAR, MIN(FECHORAIN), 20) 'FECHA HORA INICIAL DE AGENDA', 
CONVERT(VARCHAR, MAX(FECHORAFI), 23) 'FECHA FINAL DE AGENDA', 
CONVERT(VARCHAR, MAX(FECHORAFI), 20) 'FECHA HORA FINAL DE AGENDA', 
SUM(DATEDIFF(MINUTE, A.FECHORAIN, A.FECHORAFI))/60 'HORAS DIA', 
GB.ESTADO,
GB.[FECHA INICIO BLOQUEO],
GB.[FECHA FIN BLOQUEO],
SUM(ISNULL(GB.HORAS, 0)) 'HORAS BLOQUEO', 
GB.[USUARIO BLOQUEO],
GB.[NOM USUARIO BLOQUEO],
GB.[USUARIO DESBLOQUEO],
GB.[NOM USUARIO DESBLOQUEO],
GB.[FECHA DESBLOQUEO],
GB.[CAUSA],
SUM(ISNULL(G.CITAS, 0)) 'NRO DE CITAS DIAS', 
SUM(ISNULL(GC.CITASCUMPLIDAS, 0)) 'CITAS CUMPLIDAS', 
SUM(ISNULL(GI.CITASINCUMPLIDAS, 0)) 'CITAS INCUMPLIDAS', 
CAST(A.FECHORAIN AS DATE) 'FECHA BUSQUEDA'
FROM AGAGEMEDC AS A
INNER JOIN INPROFSAL AS E WITH(NOLOCK) ON A.CODPROSAL = E.CODPROSAL
INNER JOIN INESPECIA AS B WITH(NOLOCK) ON ISNULL(A.CODESPECI,E.CODESPEC1) = B.CODESPECI
INNER JOIN ADCENATEN AS C WITH(NOLOCK) ON A.CODCENATE = C.CODCENATE
INNER JOIN AGCONSULT AS CON WITH(NOLOCK) ON A.CODIGOCON = CON.CODIGOCON AND C.CODCENATE = CON.CODCENATE
LEFT JOIN (SELECT 
		   AGB.IDAGENDA, 
           CASE AGB.ESTADO WHEN '1' THEN 'BLOQUEO ACTIVO'
						   WHEN '2' THEN 'BLOQUEO INACTIVO' END AS 'ESTADO', -----Se adiciona información de bloqueo              
           AGB.FECHAINIBLOQUEO AS 'FECHA INICIO BLOQUEO',
		   AGB.FECHAFINBLOQUEO AS 'FECHA FIN BLOQUEO',
		   SUM(DATEDIFF(HOUR, FECHAINIBLOQUEO, FECHAFINBLOQUEO)) 'HORAS',
		   AGB.CODUSUARIO AS 'USUARIO BLOQUEO',
		   USUB.NOMUSUARI AS 'NOM USUARIO BLOQUEO',
		   AGB.CODUSUARIODESBLO AS 'USUARIO DESBLOQUEO',
		   USUD.NOMUSUARI AS 'NOM USUARIO DESBLOQUEO',
		   AGB.FECHADESBLO AS 'FECHA DESBLOQUEO',
		   MOT.DESMOTANU AS 'CAUSA'
		FROM AGBLOQUEOPARCIAL AS AGB
		INNER JOIN dbo.SEGusuaru AS USUB ON AGB.CODUSUARIO=USUB.CODUSUARI 
		LEFT JOIN dbo.SEGusuaru AS USUD ON AGB.CODUSUARIODESBLO=USUD.CODUSUARI
		LEFT JOIN dbo.HCMOANULB MOT ON MOT.CODMOTANU=AGB.BlockingReason AND MOT.TIPSERIPS=35
        GROUP BY AGB.IDAGENDA,AGB.ESTADO, AGB.CODUSUARIO,USUB.NOMUSUARI,AGB.CODUSUARIODESBLO,AGB.FECHADESBLO,USUD.NOMUSUARI, AGB.FECHAINIBLOQUEO,AGB.FECHAFINBLOQUEO, MOT.DESMOTANU
              ) AS GB ON GB.IDAGENDA = A.CODAUTONU
LEFT JOIN(SELECT 
		  COUNT(IDAGENDA) AS CITAS, 
          IDAGENDA
          FROM AGASICITA WITH(NOLOCK)
          WHERE TIPSOLICITU = 1 AND CODESTCIT <> 4
          GROUP BY IDAGENDA
              ) AS G ON G.IDAGENDA = A.CODAUTONU
--LEFT JOIN (SELECT 
--		   COUNT(IDAGENDA) AS CITASASIGNADAS, 
--           IDAGENDA
--           FROM AGASICITA WITH(NOLOCK)
--           WHERE TIPSOLICITU = 1 AND CODESTCIT = 0
--           GROUP BY IDAGENDA
--              ) AS GA ON GA.IDAGENDA = A.CODAUTONU
LEFT JOIN (SELECT 
		   COUNT(IDAGENDA) AS CITASCUMPLIDAS, 
           IDAGENDA
           FROM AGASICITA WITH(NOLOCK)
           WHERE TIPSOLICITU = 1 AND CODESTCIT = 1
           GROUP BY IDAGENDA
              ) AS GC ON GC.IDAGENDA = A.CODAUTONU
LEFT JOIN(SELECT 
		  COUNT(IDAGENDA) AS CITASINCUMPLIDAS, 
          IDAGENDA
          FROM AGASICITA WITH(NOLOCK)
          WHERE TIPSOLICITU = 1 AND CODESTCIT = 2
          GROUP BY IDAGENDA
              ) AS GI ON GI.IDAGENDA = A.CODAUTONU
GROUP BY C.NOMCENATE,CON.DESCRICON, B.DESESPECI, E.NOMMEDICO,GB.[ESTADO],GB.[FECHA INICIO BLOQUEO],GB.[FECHA FIN BLOQUEO],GB.HORAS, GB.[USUARIO BLOQUEO],
GB.[NOM USUARIO BLOQUEO],GB.[USUARIO DESBLOQUEO],GB.[NOM USUARIO DESBLOQUEO],GB.[FECHA DESBLOQUEO],GB.[CAUSA],YEAR(FECHORAIN), MONTH(FECHORAIN), DAY(FECHORAIN), YEAR(FECHORAFI), 
MONTH(FECHORAFI), DAY(FECHORAFI),CAST(A.FECHORAIN AS DATE),E.CODPROSAL
)

SELECT *,
YEAR([FECHA BUSQUEDA]) AS 'AÑO FECHA BUSQUEDA', 
MONTH([FECHA BUSQUEDA]) AS 'MES AÑO FECHA BUSQUEDA',
CASE MONTH([FECHA BUSQUEDA]) WHEN 1 THEN 'ENERO'
	WHEN 2 THEN 'FEBRERO'
	WHEN 3 THEN 'MARZO'
	WHEN 4 THEN 'ABRIL'
	WHEN 5 THEN 'MAYO'
	WHEN 6 THEN 'JUNIO'
	WHEN 7 THEN 'JULIO'
	WHEN 8 THEN 'AGOSTO'
	WHEN 9 THEN 'SEPTIEMBRE'
	WHEN 10 THEN 'OCTUBRE'
	WHEN 11 THEN 'NOVIEMBRE'
	WHEN 12 THEN 'DICIEMBRE'
	END AS 'MES NOMBRE FECHA BUSQUEDA', 
 DAY([FECHA BUSQUEDA]) AS 'DIA FECHA BUSQUEDA',
CONVERT(DATETIME,GETDATE() AT TIME ZONE 'Pakistan Standard Time',1) AS ULT_ACTUAL
FROM CTE_AGENDA 
--WHERE [IDENTIFICACION PROFESIONAL]='79147571' AND CAST([FECHA HORA INICIAL DE AGENDA] AS DATE)>='2025-01-01'
--ORDER BY [FECHA HORA INICIAL DE AGENDA]

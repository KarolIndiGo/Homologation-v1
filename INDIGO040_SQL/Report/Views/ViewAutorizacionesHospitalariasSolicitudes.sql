-- Workspace: SQLServer
-- Item: INDIGO040 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: ViewAutorizacionesHospitalariasSolicitudes
-- Extracted by Fabric SQL Extractor SPN v3.9.0









CREATE VIEW [Report].[ViewAutorizacionesHospitalariasSolicitudes] AS

------*****3. SCRIPS LISTADO DE PACIENTES DASHBOAR AUTORIZACIONES HOSPITALARIA - GESTION RESOLUCION 3047 - SOLICTUD LISTA DE SOLICITUDES v2*******-------
--DECLARE @FechaInicio Datetime ='2022-04-30';
--DECLARE @FechaFin Datetime ='2022-05-05';

WITH CTE_AUTORIZACIONES_HOSPITALARIAS
AS
(
SELECT CASE WHEN I.NUMINGRES IS NULL THEN '3- Pacientes en la unidad' ELSE '2- Pacientes alta medica' END AS Egreso,
CASE J.SERSUSCEP WHEN 1 THEN 'Alerta' ELSE 'Normal' END as Alerta, RTRIM(DESCCAMAS) AS Cama,dbo.ClaseHabitacion(A.CODCLAHAB) AS 'Clase Habitacion',
dbo.ClaseCama(A.CODCLACAM) AS 'Clase de Cama', C.IPCODPACI AS Identificacion,C.NUMINGRES AS Ingreso, dbo.TipoAislamiento(A.CODAISLAM) AS Aislamiento,RTRIM(DESTIPEST) AS 'Tipo Estancia',
RTRIM(IPNOMCOMP) AS Paciente, A.CODCONCEC AS Consecutivo,CAST('' as bit) AS 'Muestra Alerta',
RTRIM(K.DESESPECI) AS 'Descripcion Especialidad',CAST(IFECHAING AS DATE) 'Fecha Ingreso', RTRIM(J.UFUACTPAC) + ' - ' + RTRIM(U.UFUDESCRI) as 'Unidad Funcional Actual',
CASE WHEN FECHEGRESO IS NULL THEN 'Sin egreso' ELSE CONVERT(VARCHAR, (FORMAT(FECHEGRESO, 'dd/MM/yyyy'))) END AS 'Fecha Egreso', CAST(H.IPFECNACI AS DATE) AS 'Fecha Nacimiento',
FLOOR((CAST(CONVERT(VARCHAR(8), J.IFECHAING , 112) AS INT) - CAST(CONVERT(VARCHAR(8), H.IPFECNACI, 112) AS INT)) / 10000) AS 'Edad',
RTRIM(P.CODENTIDA) + '-'+ RTRIM(P.NOMENTIDA) as 'Entidad Paciente',C.ID ,C.FECINIEST [Fecha Ingreso Estancia] ,C.FECFINEST [Fecha Egreso Estancia]
FROM dbo.CHCAMASHO A
INNER JOIN dbo.ADcenaten D ON A.CODCENATE=D.CODCENATE
INNER JOIN dbo.INUNIFUNC E ON A.UFUCODIGO=E.UFUCODIGO
INNER JOIN dbo.CHREGESTA C ON A.CODICAMAS=C.CODICAMAS AND C.REGESTADO = 1
INNER JOIN dbo.CHTIPESTA G ON G.CODTIPEST=C.CODTIPEST
INNER JOIN dbo.INPacient H ON C.IPCODPACI=H.IPCODPACI
LEFT JOIN dbo.INENTIDAD P with(nolock) ON P.CODENTIDA = H.CODENTIDA
LEFT JOIN dbo.HCREGEGRE I ON C.NUMINGRES=I.NUMINGRES
INNER JOIN dbo.ADINGRESO J ON C.NUMINGRES=J.NUMINGRES
INNER JOIN dbo.INESPECIA K ON J.CODESPTRA=K.CODESPECI
INNER JOIN dbo.INUNIFUNC U ON U.UFUCODIGO = J.UFUACTPAC
WHERE /*convert(varchar(50),A.UFUCODIGO) IN ('1111001') AND cast(IFECHAING as date) BETWEEN @FechaInicio AND @FechaFin AND*/ ESTADCAMA =2
--and H.IPCODPACI IN ('1023417717')
AND NOT EXISTS (
SELECT 1 FROM [Authorization].PatientConfirmation PC
WHERE PC.AdmisionNumber = C.NUMINGRES
AND PC.ConfirmationDate > [Authorization].ObtenerFechaMaximaSolicitud(C.NUMINGRES)
)
UNION ALL
SELECT '4- Pacientes egresados' AS Egreso,
CASE J.SERSUSCEP WHEN 1 THEN 'Alerta' ELSE 'Normal' END as Alerta, RTRIM(DESCCAMAS) AS Cama,dbo.ClaseHabitacion(A.CODCLAHAB) AS 'Clase Habitacion',
dbo.ClaseCama(A.CODCLACAM) AS 'Clase de Cama', C.IPCODPACI AS Identificacion,C.NUMINGRES AS Ingreso, dbo.TipoAislamiento(A.CODAISLAM) AS Aislamiento,RTRIM(DESTIPEST) AS 'Tipo Estancia',RTRIM(IPNOMCOMP) AS Paciente,
A.CODCONCEC AS Consecutivo,CAST('' as bit) AS 'Muestra Alerta',RTRIM(K.DESESPECI) AS 'Descripcion Especialidad',CAST(IFECHAING AS DATE) 'Fecha Ingreso',
RTRIM(J.UFUACTPAC) + ' - ' + RTRIM(U.UFUDESCRI) as 'Unidad Funcional Actual',
CASE WHEN FECHEGRESO IS NULL THEN 'Sin egreso' ELSE CONVERT(VARCHAR, (FORMAT(FECHEGRESO, 'dd/MM/yyyy'))) END AS 'Fecha Egreso', CAST(H.IPFECNACI AS DATE) AS 'Fecha Nacimiento',
FLOOR((CAST(CONVERT(VARCHAR(8), J.IFECHAING , 112) AS INT) - CAST(CONVERT(VARCHAR(8), H.IPFECNACI, 112) AS INT)) / 10000) AS 'Edad',
RTRIM(P.CODENTIDA) + '-'+ RTRIM(P.NOMENTIDA) as 'Entidad Paciente',C.ID ,C.FECINIEST ,C.FECFINEST
FROM dbo.CHCAMASHO A
INNER JOIN dbo.ADcenaten D ON A.CODCENATE=D.CODCENATE
INNER JOIN dbo.INUNIFUNC E ON A.UFUCODIGO=E.UFUCODIGO
LEFT JOIN dbo.CHREGESTA C ON A.CODICAMAS=C.CODICAMAS AND C.REGESTADO = 2
LEFT JOIN dbo.CHTIPESTA G ON G.CODTIPEST=C.CODTIPEST
LEFT JOIN dbo.INPacient H ON C.IPCODPACI=H.IPCODPACI
LEFT JOIN dbo.INENTIDAD P with(nolock) ON P.CODENTIDA = H.CODENTIDA
LEFT JOIN dbo.HCREGEGRE I ON C.NUMINGRES=I.NUMINGRES
LEFT JOIN dbo.ADINGRESO J ON C.NUMINGRES=J.NUMINGRES
LEFT JOIN dbo.INESPECIA K ON J.CODESPTRA=K.CODESPECI
LEFT JOIN dbo.INUNIFUNC U ON U.UFUCODIGO = J.UFUACTPAC
WHERE /* convert(varchar(50),A.UFUCODIGO) IN ('1111001') AND cast(FECHEGRESO as date) BETWEEN @FechaInicio AND @FechaFin AND*/ SERSUSCEP = 1
--and H.IPCODPACI IN ('1023417717')
AND NOT EXISTS (
SELECT 1 FROM [Authorization].PatientConfirmation PC
WHERE PC.AdmisionNumber = C.NUMINGRES
AND PC.ConfirmationDate > [Authorization].ObtenerFechaMaximaSolicitud(C.NUMINGRES)
)

UNION ALL

SELECT '1- Pacientes Urgencias con orden de hospitalizacion' as Egreso,
CASE C.SERSUSCEP WHEN 1 THEN 'Alerta' ELSE 'Normal' END as Alerta,'' as Cama,'Sin Clase' AS 'Clase Habitacion','Sin Clase' AS 'Clase de Cama', C.IPCODPACI AS Identificacion,
C.NUMINGRES AS Ingreso, '' AS Aislamiento, Historia.Destino AS 'Tipo Estancia',RTRIM(IPNOMCOMP) AS Paciente,0 AS Consecutivo,CAST('' as bit) AS 'Muestra Alerta',
RTRIM(K.DESESPECI) AS 'Descripcion Especialidad',CAST(IFECHAING AS DATE) 'Fecha Ingreso',RTRIM(C.UFUACTPAC) + ' - ' + RTRIM(U.UFUDESCRI) as 'Unidad Funcional Actual',
CASE WHEN FECHEGRESO IS NULL THEN 'Sin egreso' ELSE CONVERT(VARCHAR, (FORMAT(FECHEGRESO, 'dd/MM/yyyy'))) END AS 'Fecha Egreso', CAST(H.IPFECNACI AS DATE) AS 'Fecha Nacimiento',
FLOOR((CAST(CONVERT(VARCHAR(8), C.IFECHAING , 112) AS INT) - CAST(CONVERT(VARCHAR(8), H.IPFECNACI, 112) AS INT)) / 10000) AS 'Edad',
RTRIM(P.CODENTIDA) + '-'+ RTRIM(P.NOMENTIDA) as 'Entidad Paciente','' AS ID ,'' FECINIEST ,'' FECFINEST
FROM dbo.ADINGRESO C with (NOLOCK)
INNER JOIN dbo.ADcenaten D with(nolock) ON C.CODCENATE=D.CODCENATE
INNER JOIN dbo.INUNIFUNC E with(nolock) ON C.UFUCODIGO=E.UFUCODIGO
INNER JOIN dbo.INPacient H with(nolock) ON C.IPCODPACI=H.IPCODPACI
INNER JOIN dbo.INENTIDAD P with(nolock) ON P.CODENTIDA = H.CODENTIDA
INNER JOIN dbo.INESPECIA K with(nolock) ON C.CODESPTRA=K.CODESPECI
INNER JOIN dbo.INUNIFUNC U with(nolock) ON C.UFUACTPAC = U.UFUCODIGO AND U.UFUTIPUNI = 1
OUTER APPLY (
SELECT TOP(1) NUMEFOLIO, IDETIPHIS,
CASE INDICAPAC
WHEN '2' THEN 'Trasladar a Observacion'
WHEN '3' THEN 'Trasladar a Hospitalizacion'
WHEN '4' THEN 'Trasladar a UCI Adulto '
WHEN '5' THEN 'Trasladar a UCI Pediatrica'
WHEN '6' THEN 'Trasladar a UCI Neonatal'
WHEN '18' THEN 'Estancia Con la Madre'
WHEN '19' THEN 'U.Cuidado Intermedio'
WHEN '20' THEN 'U.Basica'
WHEN '21' THEN 'Hospitalización Pediatría'
END as Destino,
INDICAPAC
FROM HCHISPACA WHERE NUMINGRES = C.NUMINGRES AND IPCODPACI = C.IPCODPACI AND INDICAPAC IN ('2','3','4','5','6','18','19','20','21') ORDER BY FECHISPAC
)As Historia
WHERE /*AND C.UFUACTPAC IN (SELECT Value FROM dbo.splitstring('1111001')) AND cast(IFECHAING as date) BETWEEN @FechaInicio AND @FechaFin */
 NOT EXISTS (
SELECT 1 FROM [Authorization].PatientConfirmation PC
WHERE PC.AdmisionNumber = C.NUMINGRES
AND PC.ConfirmationDate > [Authorization].ObtenerFechaMaximaSolicitud(C.NUMINGRES)
)
AND C.IESTADOIN = '' AND C.CODICAMHO IS NULL AND Historia.INDICAPAC is NOT NULL AND E.UFUTIPUNI = '1'
--and H.IPCODPACI IN ('1023417717')
),



CTE_RESOLUCION_3047
AS
(
-----******SCRIPS RESOLUCION 3047********------
---REGISTRO DE INCONSISTENCIAS
SELECT FECINFORM AS 'Fecha Informe','Inconsistencias' AS 'Tipo Documento',CASE ESTTRANSA WHEN '1' THEN 'En Proceso de Envio' WHEN '2' THEN 'Envio Satisfactorio' WHEN '3' THEN 'Envio Fallido' END AS Estado,
RTRIM(NOMUSUARI) AS 'Enviado Por',CODCONCEC,'1-' + CAST(CODCONCEC AS CHAR) AS Llave,CODCONCEC AS 'Consecutivo Interno',NUMINFORM AS 'Numero Informe',A.CODCENATE,'' AS ID_RES ,
A.IPCODPACI ,'' AS 'NUMINGRES',A.CODCONCEC 'CONSECU'
FROM dbo.ADINCBASD A
INNER JOIN dbo.SEGusuaru B On A.CODUSUARI = B.CODUSUARI
INNER JOIN CTE_AUTORIZACIONES_HOSPITALARIAS AS AUT ON AUT.Identificacion =A.IPCODPACI
--WHERE A.IPCODPACI = '1031651472'
UNION
---REGISTRO DE ATENCION INICIAL DE URGENCIAS
SELECT FECINFORM AS 'Fecha Informe','Atencion Inicial Urgencias' AS 'Tipo Documento',
CASE ESTTRANSA WHEN '1' THEN 'En Proceso de Envio' WHEN '2' THEN 'Intento de Envio 1' WHEN '3' THEN 'Intento de Envio 2' WHEN '4' THEN 'Intento de Envio 3' WHEN '5' THEN 'Intento de Envio DTL' WHEN '6' THEN 'Intento de Envio DTD' WHEN '7' THEN 'Envio Satisfactorio' END AS Estado,
RTRIM(NOMUSUARI) AS 'Enviado Por',CODCONCEC,'2-' + CAST(CODCONCEC AS CHAR) AS Llave,CODCONCEC AS 'Consecutivo Interno',NUMINFORM AS 'Numero Informe',A.CODCENATE,CASE C.TIPOTRAZA WHEN 1 THEN 'AI - ' + RTRIM(
CONVERT(CHAR, C.ADAUTSERID)) WHEN 2 THEN 'AS - ' + RTRIM(CONVERT(CHAR, A.CODCONCEC)) END AS ID_RES,A.IPCODPACI ,A.NUMINGRES ,A.CODCONCEC 'CONSECU'
FROM dbo.ADATEINIU A
INNER JOIN dbo.SEGusuaru B ON A.CODUSUARI = B.CODUSUARI
INNER JOIN CTE_AUTORIZACIONES_HOSPITALARIAS AS AUT ON AUT.Identificacion =A.IPCODPACI AND AUT.Ingreso =A.NUMINGRES
LEFT OUTER JOIN dbo.ADAUTEVEN C ON C.ADAUTSERID = A.CODCONCEC
WHERE (C.TIPOTRAZA IS NULL OR C.TIPOTRAZA = 1)
--AND A.IPCODPACI = '1031651472'AND A.NUMINGRES = '538 '
UNION
---REGISTRO DE CABECERA DE AUTORIZACION DE SERVICIOS
SELECT FECINFORM AS 'Fecha Informe','Autorizacion de Servicios' AS 'Tipo Documento',
CASE ESTTRANSA WHEN '1' THEN 'En Proceso de Envio' WHEN '2' THEN 'Intento de Envio 1' WHEN '3' THEN 'Intento de Envio 2' WHEN '4' THEN 'Intento de Envio 3' WHEN '5' THEN 'Intento de Envio DTL' WHEN '6' THEN 'Intento de Envio DTD' WHEN '7' THEN 'Envio Satisfactorio' END AS Estado,
RTRIM(NOMUSUARI) AS 'Enviado Por',CODCONCEC,'3-' + CAST(CODCONCEC AS CHAR) AS Llave,CODCONCEC AS 'Consecutivo Interno',NUMINFORM AS 'Numero Informe',A.CODCENATE,'AS - ' + RTRIM(CONVERT(CHAR, A.CODCONCEC)) AS ID_RES,
A.IPCODPACI ,A.NUMINGRES ,A.CODCONCEC 'CONSECU'
FROM dbo.ADAUTSERC A
INNER JOIN dbo.SEGusuaru B ON A.CODUSUARI = B.CODUSUARI
INNER JOIN CTE_AUTORIZACIONES_HOSPITALARIAS AS AUT ON AUT.Identificacion =A.IPCODPACI AND AUT.Ingreso =A.NUMINGRES
--WHERE A.IPCODPACI = '1031651472'AND A.NUMINGRES = '538 '
),

CTE_RESOLUCION_3047_DETALLADO
AS
(
-----TABLA DETALLE AUTORIZACION DE SERVICIOS PROCEDIMIENTOS
SELECT A.CODSERIPS AS 'Codigo CUPS',RTRIM(DESSERIPS) AS Servicio,CANSERIPS AS Cantidad,CASE ESTATUSER WHEN '1' THEN 'Autorizado' WHEN '2' THEN 'No Autorizado' WHEN '3' THEN 'Pendiente de Autorizacion' END AS Estado,
A.CANSERAUT AS 'Cantidad Autorizada','3-' + CAST(A.CODCONCEC AS CHAR) AS Llave,A.CODCONCEC AS 'Consecutivo Interno',
(SELECT TOP 1 PACIENTNOT FROM DBO.ADAUTEVEN AD WHERE AD.ADAUTSERID = A.CODCONCEC ORDER BY FECREGEVE DESC) AS PacienteNotificado,
(SELECT TOP 1 INFOPACI FROM DBO.ADAUTEVEN AD WHERE AD.ADAUTSERID = A.CODCONCEC ORDER BY FECREGEVE DESC) AS InfoPaciente,A.IPCODPACI ,A.NUMINGRES
FROM dbo.ADAUTSERD A
INNER JOIN dbo.INCUPSIPS B ON A.CODSERIPS = B.CODSERIPS
INNER JOIN CTE_RESOLUCION_3047 AS RES ON RES.IPCODPACI =A.IPCODPACI AND RES.NUMINGRES =A.NUMINGRES AND RES.CONSECU =A.CODCONCEC
--WHERE A.IPCODPACI = '1031651472'AND A.NUMINGRES = '538 '
UNION
-----TABLA DETALLE AUTORIZACION DE SERVICIOS MEDICAMENTOS
SELECT A.CODSERIPS AS 'Codigo CUPS', RTRIM(DESPRODUC) AS Servicio, CANSERIPS AS Cantidad,CASE ESTATUSER WHEN '1' THEN 'Autorizado' WHEN '2' THEN 'No Autorizado' WHEN '3' THEN 'Pendiente de Autorizacion' END AS Estado,
A.CANSERAUT AS 'Cantidad Autorizada', '3-' + CAST(A.CODCONCEC AS CHAR) AS Llave,A.CODCONCEC AS 'Consecutivo Interno','' AS PacienteNotificado,'' AS InfoPaciente,A.IPCODPACI ,A.NUMINGRES
FROM dbo.ADAUTSERD A
INNER JOIN dbo.IHLISTPRO B On A.CODSERIPS = B.CODPRODUC
INNER JOIN CTE_RESOLUCION_3047 AS RES ON RES.IPCODPACI =A.IPCODPACI AND RES.NUMINGRES =A.NUMINGRES AND RES.CODCONCEC =A.CODCONCEC
--WHERE A.IPCODPACI = '1031651472'AND A.NUMINGRES = '538 '
),



CTE_EVENTOS
AS
(
SELECT DISTINCT CODREGUNI,FECREGEVE,RTRIM(NOMENTIDA) AS NOMENTIDA,CASE TIPREPENT WHEN '1' THEN 'Llamada Telefonica' WHEN '2' THEN 'Envio FAX' WHEN '3' THEN 'Registro Pagina Web' END TIPREPENT,
RTRIM(NOMUSUARI) AS NOMUSUARI,CASE WHEN A.CODDOCALM IS NULL THEN '' ELSE RTRIM(CAST(A.CODDOCALM AS VARCHAR)) END AS CODDOCALM,A.CODENTIDA,
CASE TIPOTRAZA WHEN 1 THEN 'AI - ' + RTRIM(CONVERT(CHAR, ADAUTSERID)) WHEN 2 THEN 'AS - ' + RTRIM(CONVERT(CHAR, ADAUTSERID)) END AS ID,A.ADAUTSERID,A.IPCODPACI ,A.NUMINGRES ,a.ESTADO
FROM
dbo.ADAUTEVEN A
INNER JOIN dbo.SEGusuaru B ON A.CODUSUARI = B.CODUSUARI
INNER JOIN dbo.INENTIDAD C ON A.CODENTIDA = C.CODENTIDA
INNER JOIN CTE_RESOLUCION_3047 AS RES ON RES.IPCODPACI =A.IPCODPACI AND RES.NUMINGRES =A.NUMINGRES AND RES.CONSECU =A.ADAUTSERID
LEFT OUTER JOIN dbo.ADAUTSERD E ON E.CODCONCEC = A.ADAUTSERID
LEFT OUTER JOIN dbo.INCUPSIPS I ON I.CODSERIPS = E.CODSERIPS
--WHERE A.IPCODPACI = '1023417717'AND A.NUMINGRES = '11534 '
)



SELECT
 CAST(DB_NAME() AS VARCHAR(9)) AS ID_COMPANY, 
 AUT.* ,RES.ID_RES,RES.[Fecha Informe] ,RES.[Tipo Documento], RES.Estado [Estado RESOL], RES.[Enviado Por] ,DET.[Codigo CUPS],
 DET.Servicio ,DET.Cantidad ,DET.[Cantidad Autorizada], DET.Estado [Estado RESOL DET], eve.ID  [ID EVENTO],  EVE.FECREGEVE 'Evento fecha Registro',
 eve.TIPREPENT 'Evento Tipo de Reporte',eve.NOMUSUARI 'Evento Enviado Por',eve.ESTADO,
 CAST(AUT.[Fecha Ingreso] AS date) AS 'FECHA BUSQUEDA',
 YEAR(AUT.[Fecha Ingreso] ) AS 'AÑO FECHA BUSQUEDA',
 MONTH(AUT.[Fecha Ingreso] ) AS 'MES AÑO FECHA BUSQUEDA',
 CASE MONTH(AUT.[Fecha Ingreso]) 
	WHEN 1 THEN 'ENERO'
	WHEN 2 THEN 'FEBRERO'
	WHEN 3 THEN 'MARZO'
	WHEN 4 THEN 'ABRIL'
	WHEN 5 THEN 'MAYO'
	WHEN 6 THEN 'JUNIO'
	WHEN 7 THEN 'JULIO'
	WHEN 8 THEN 'AGOSTO'
	WHEN 9 THEN 'SEPTIEMBRE'
	WHEN 10 THEN 'OCTUBRE'
	WHEN 11 THEN 'NOVIEMBRE'
	WHEN 12 THEN 'DICIEMBRE'
  END AS 'MES NOMBRE FECHA BUSQUEDA',
  FORMAT(DAY(AUT.[Fecha Ingreso]), '00') AS 'DIA FECHA BUSQUEDA',
  CONVERT(DATETIME,GETDATE() AT TIME ZONE 'Pakistan Standard Time',1) AS ULT_ACTUAL
FROM CTE_AUTORIZACIONES_HOSPITALARIAS AS AUT
LEFT JOIN CTE_RESOLUCION_3047 AS RES ON AUT.Identificacion =RES.IPCODPACI
LEFT JOIN CTE_RESOLUCION_3047_DETALLADO AS DET ON DET.IPCODPACI =RES.IPCODPACI AND DET.NUMINGRES =RES.NUMINGRES AND RES.CODCONCEC = DET.[Consecutivo Interno]
LEFT JOIN CTE_EVENTOS AS EVE ON EVE.IPCODPACI =RES.IPCODPACI AND EVE.NUMINGRES =RES.NUMINGRES AND RES.CONSECU = EVE.ADAUTSERID AND AUT.Identificacion = EVE.IPCODPACI

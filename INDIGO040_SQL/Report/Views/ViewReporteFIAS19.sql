-- Workspace: SQLServer
-- Item: INDIGO040 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: ViewReporteFIAS19
-- Extracted by Fabric SQL Extractor SPN v3.9.0


CREATE VIEW [Report].[ViewReporteFIAS19] as

WITH DISPENSACION AS
 (
  SELECT AdmissionNumber 'INGRESO',
         C.ConfirmationDate 'FECHA ENTREGA',
	     ATC.Code 'CODIGO MEDICAMENTO',
		 P.Code 'CUM',
		 D.Quantity 'CANTIDAD ENTREGADA',
		 D.EntityId 'IDFORMULA',
		 PF.Name 'FORMA FARMACEUTICA',
		 CASE WHEN ATC.POSProduct='0' THEN 'NO' ELSE 'SI' END [INCLUIDO EN PBS],
		 CASE WHEN ATC.Conditioned='0' THEN 'NO' ELSE 'SI' END [MEDICMANETO CONDICIONADO],
		 CASE WHEN ATC.UNIRS ='0' THEN 'NO' ELSE 'SI' END [MEDICMANETO UNIRS],
		 IIF (ATC.AllPOSPathologies = 'TRUE', 'SI', 'NO') [TODAS_LAS_PATOLOGIAS],
		 C.Status as ESTADO_DIS
  FROM 
   Inventory.PharmaceuticalDispensing AS C
   JOIN Inventory.PharmaceuticalDispensingDetail AS D ON C.Id =D.PharmaceuticalDispensingId 
   JOIN Inventory.InventoryProduct AS P ON  D.ProductId =P.ID 
   JOIN Inventory.ATC AS ATC  ON P.ATCId =ATC.Id  
   LEFT JOIN Inventory.PharmaceuticalForm PF ON ATC.PharmaceuticalFormId = PF.Id 
)

SELECT
  CAST(DB_NAME() AS VARCHAR(9)) AS ID_COMPANY, 
  CASE c.TIPOSOLICITUD 
       WHEN 1 THEN 'IntraHospitalario'
	   WHEN 3 THEN 'Mixto'
	   ELSE  'Extramural'	   
  END 'AMBITO DISPENSACION',
  C.CODCONCEC 'FORMULA',
  MED.NOMMEDICO 'PROFESIONAL',
  CEN.NOMCENATE 'CENTRO ATENCION',
  DEP.depcodigo AS 'COD. DEPARTAMENTO',
  DEP.nomdepart AS 'DEPARTAMENTO',
  MUN.DEPCODIGO AS 'COD. MUNICIPIO',
  MUN.MUNNOMBRE AS 'MUNICIPIO',
  UNI.UFUDESCRI 'UNIDAD FUNCIONAL',
  HA.Name 'ENTIDAD-EAPB',
  C.IPCODPACI 'IDENTIFICACION',
  CASE PAC.IPTIPODOC WHEN '1' THEN 'CEDULA DE CIUDADANIA'
					 WHEN '2' THEN 'CEDULA DE EXTRANJERIA'
					 WHEN '3' THEN 'TARJETA DE IDENTIDAD'
					 WHEN '4' THEN 'REGISTRO CIVIL'
					 WHEN '5' THEN 'PASAPORTE'
					 WHEN '6' THEN 'ADULTO SIN IDENTIFICACION'
					 WHEN '7' THEN 'MENOR SIN IDENTIFICACION'
					 WHEN '8' THEN 'NUMERO UNICO DE IDENTIFICACIÒN'
					 WHEN '9' THEN 'CERTIFICADO NACIDO VIVO'
					 WHEN '10' THEN 'CARNET DIPLOMATICO'
					 WHEN '11' THEN 'SALVOCONDUCTO'
					 WHEN '12' THEN 'PERMISO ESPECIAL DE PERMANENCIA' END AS [TIPO DOCUMENTO],
  PAC.IPNOMCOMP AS 'NOMBRE PACIENTE',
  C.NUMINGRES 'INGRESO',
  D.CODPRODUC 'CODIGO MEDICAMENTO',
  PRO.DESPRODUC 'MEDICAMENTO' , 
  PRE.DESFORMED 'PRESENTACION',
  PG.Name 'GRUPO FARMACOLOGICO' ,
  DIS.[FORMA FARMACEUTICA] 'FORMA FARMACEUTICA',
  C.FECHAORDE 'FECHA SOLICITUD',
  CANPEDPRO 'CANTIDAD SOLICITADA',
  DIS.[FECHA ENTREGA], 
  ISNULL(DIS.[CANTIDAD ENTREGADA] ,0) [CANTIDAD ENTREGADA],
  CASE 
   WHEN DIS.[CANTIDAD ENTREGADA] IS NULL THEN 'NO ENTREGADO'
   WHEN CANPEDPRO - DIS.[CANTIDAD ENTREGADA] = 0 THEN 'ENTREGA COMPLETA'
   ELSE 'ENTREGA INCOMPLETA' 
  END 'ENTREGA FORMULA',
  DATEDIFF(HOUR, C.FECHAORDE,DIS.[FECHA ENTREGA]) [DIFERENCIA EN HORAS],
  [INCLUIDO EN PBS],
  [MEDICMANETO CONDICIONADO],
  [MEDICMANETO UNIRS],
  [TODAS_LAS_PATOLOGIAS],
  CAST(C.FECHAORDE AS DATE) AS 'FECHA BUSQUEDA', 
  YEAR(C.FECHAORDE) AS 'AÑO FECHA BUSQUEDA', 
  MONTH(C.FECHAORDE) AS 'MES AÑO FECHA BUSQUEDA',
  CASE MONTH(C.FECHAORDE)
       WHEN 2 THEN 'FEBRERO'
	   WHEN 3 THEN 'MARZO'
	   WHEN 4 THEN 'ABRIL'
	   WHEN 5 THEN 'MAYO'
	   WHEN 6 THEN 'JUNIO'
	   WHEN 7 THEN 'JULIO'
	   WHEN 8 THEN 'AGOSTO'
	   WHEN 9 THEN 'SEPTIEMBRE'
	   WHEN 10 THEN 'OCTUBRE'
	   WHEN 11 THEN 'NOVIEMBRE'
	   WHEN 12 THEN 'DICIEMBRE'
 END AS 'MES NOMBRE FECHA BUSQUEDA', 
 DAY(C.FECHAORDE) AS 'DIA FECHA BUSQUEDA',
 CONVERT(DATETIME,GETDATE() AT TIME ZONE 'Pakistan Standard Time',1) AS ULT_ACTUAL
FROM 
 HCFARMEPC AS C
 JOIN HCFARMEPD AS D ON C.CODCONCEC = D.CODCONCEC AND C.NUMINGRES =D.NUMINGRES 
 JOIN IHLISTPRO AS PRO ON D.CODPRODUC = PRO.CODPRODUC
 JOIN INPROFSAL AS MED ON D.CODPROSAL = MED.CODPROSAL 
 JOIN ADCENATEN AS CEN ON C.CODCENATE = CEN.CODCENATE
 JOIN INUNIFUNC AS UNI ON C.UFUCODIGO = UNI.UFUCODIGO 
 JOIN Payroll.FunctionalUnit AS FU ON FU.Code =UNI.UFUCODIGO 
 JOIN INPACIENT AS PAC ON C.IPCODPACI =PAC.IPCODPACI
 LEFT JOIN INUBICACI AS UB WITH(NOLOCK) ON UB.AUUBICACI = PAC.AUUBICACI
 LEFT JOIN INMUNICIP AS MUN WITH(NOLOCK) ON MUN.DEPMUNCOD = UB.DEPMUNCOD
 LEFT JOIN INDEPARTA AS DEP WITH(NOLOCK) ON DEP.depcodigo=MUN.DEPCODIGO
 JOIN ADINGRESO AS ING ON C.NUMINGRES =ING.NUMINGRES 
 JOIN Contract.HealthAdministrator AS HA ON ING.GENCONENTITY =HA.Id  
 JOIN Inventory.ATC AS ATC  ON D.CODPRODUC =ATC.Code 
 JOIN Inventory.ATCEntity AS ATCE ON ATC.ATCEntityId =ATCE.Id 
 JOIN Inventory.PharmacologicalGroup AS PG ON PG.Id =ATCE.IdPharmacologicalGroup 
 LEFT JOIN IHFORMEDI AS PRE ON PRO.CODFORMED =PRE.CODFORMED 
 LEFT JOIN DISPENSACION AS DIS ON D.ID = DIS.IDFORMULA AND D.NUMINGRES =DIS.INGRESO 

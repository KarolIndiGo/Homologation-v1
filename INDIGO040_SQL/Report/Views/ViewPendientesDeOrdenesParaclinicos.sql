-- Workspace: SQLServer
-- Item: INDIGO040 [SQL]
-- ItemId: SPN
-- Schema: Report
-- Object: ViewPendientesDeOrdenesParaclinicos
-- Extracted by Fabric SQL Extractor SPN v3.9.0





CREATE VIEW [Report].[ViewPendientesDeOrdenesParaclinicos]
as
----*******IMAGENES*******-----
WITH CTE_INGRESOS_CON_PENDIENTES
AS
(

SELECT NUMINGRES ,IPCODPACI  FROM 
(
   SELECT DISTINCT NUMINGRES, IPCODPACI FROM dbo.HCORDIMAG A WITH (NOLOCK)  WHERE  A.GENSERVICEORDER IS NULL and ESTSERIPS IN ('2','3','4') AND A.MANEXTPRO = 0
   UNION ALL 
   SELECT DISTINCT NUMINGRES, IPCODPACI FROM dbo.HCORDLABO  A WITH (NOLOCK) WHERE A.GENSERVICEORDER IS NULL AND A.ESTSERIPS IN ('3','4') AND A.MANEXTPRO = 0
   UNION ALL 
   SELECT DISTINCT NUMINGRES, IPCODPACI FROM dbo.HCORDPATO  A WITH (NOLOCK) WHERE A.GENSERVICEORDER IS NULL AND A.ESTSERIPS IN ('3','4') AND A.MANEXTPRO = 0
   ) G GROUP BY G.NUMINGRES,G.IPCODPACI 
),

CTE_IMAGENES
AS
(
SELECT	CONCAT('HCORDIMAG', '-', A.AUTO) ID,
			'IMAGENES' EntityName,iif(A.GENSERVICEORDER IS NULL,'SIN ORDEN','CON ORDEN')  'ORDENE DE SERVICIO' ,CASE A.MANEXTPRO WHEN 0 THEN 'HOSPITALARIO' ELSE 'AMBULATORIO' END 'AMBITO', 
			A.CODSERIPS 'CODIGO CUPS',B.DESSERIPS 'PROCEDIMIENTO CUPS',
			CONCAT(RTRIM(D.UFUCODIGO), ' - ', RTRIM(D.UFUDESCRI)) AS 'UNIDAD FUNCIONAL',
			CONCAT(RTRIM(C.CODIGONIT), ' - ', RTRIM(C.NOMMEDICO)) AS 'MEDICO ORDENAMIENTO',
			A.FECORDMED AS 'FECHA ORDENAMIENTO',A.NUMEFOLIO AS 'FOLIO ORDENAMIENTO',
			A.NUMFOLINT AS 'FOLIO INTERPRETACION',A.CODPROINT AS 'MEDICO INTERPRETO',A.INTERPRET AS 'INTERPRETACION',
			A.CANSERIPS 'CANTIDAD',	A.NUMINGRES 'INGRESO',A.IPCODPACI 'IDENTIFICACION',RTRIM(PAC.IPNOMCOMP) 'PACIENTE' ,
			CASE WHEN SERREASIT='1' THEN 'Estudios Realizados' WHEN  ESTSERIPS IN ('2','3','4') THEN 'Estudios Realizados' when ESTSERIPS = '6' then 'Anulado' ELSE 'Estudios No Realizados' END AS 'ESTADO',
			A.MEDREALEC as 'MEDICO LECTURA',
			A.FECHLECT as 'FECHA LECTURA',
			CASE WHEN A.MEDREALEC IS NULL THEN 'NO' ELSE 'SI' END as 'LECTURA REALIZADA',
			ISNULL(cd.Code + ' - ' + cd.Name, '') 'DESCRIPCION RELACIONADA',A.NOMARCIMG 'ADJUNTO'
	FROM dbo.ADINGRESO ing
	INNER JOIN dbo.HCORDIMAG A with (nolock) ON ing.NUMINGRES = A.NUMINGRES
	INNER JOIN DBO.INPACIENT AS PAC with (nolock) ON PAC.IPCODPACI =A.IPCODPACI 
	INNER JOIN dbo.INCUPSIPS B with (nolock) ON A.CODSERIPS=B.CODSERIPS 
	INNER JOIN dbo.INPROFSAL C with (nolock) ON A.CODPROSAL=C.CODPROSAL 	
	INNER JOIN dbo.INUNIFUNC D with (nolock) ON A.UFUCODIGO=D.UFUCODIGO
	INNER JOIN CTE_INGRESOS_CON_PENDIENTES AS PEN with (nolock) ON PEN.NUMINGRES =ING.NUMINGRES 
	LEFT JOIN dbo.INPROFSAL CR with (nolock) ON COALESCE(A.MEDREALEC, A.CODPROSAL)=CR.CODPROSAL 
	LEFT JOIN Contract.CUPSEntityContractDescriptions cecd with (nolock) ON cecd.Id = a.IDDESCRIPCIONRELACIONADA
	LEFT JOIN Contract.ContractDescriptions cd with (nolock) ON cd.Id = cecd.ContractDescriptionId
	WHERE  A.GENSERVICEORDER IS NULL and ESTSERIPS IN ('2','3','4') AND A.MANEXTPRO = 0 --OR ISNULL(ing.TRATAESPECIA, 0) = 3 

UNION ALL

	SELECT	CONCAT('HCORDIMAG', '-', A.AUTO) ID,
			'HCORDIMAG' EntityName,iif(A.GENSERVICEORDER IS NULL,'SIN ORDEN','CON ORDEN')  'ORDENE DE SERVICIO' ,
			CASE A.MANEXTPRO WHEN 0 THEN 'HOSPITALARIO' ELSE 'AMBULATORIO' END 'AMBITO', 
			A.CODSERIPS 'CODIGO CUPS',B.DESSERIPS 'PROCEDIMIENTO CUPS',
			CONCAT(RTRIM(D.UFUCODIGO), ' - ', RTRIM(D.UFUDESCRI)) AS 'UNIDAD FUNCIONAL',
			CONCAT(RTRIM(C.CODIGONIT), ' - ', RTRIM(C.NOMMEDICO)) AS 'MEDICO ORDENAMIENTO',
			A.FECORDMED AS 'FECHA ORDENAMIENTO',A.NUMEFOLIO AS 'FOLIO ORDENAMIENTO',
			A.NUMFOLINT AS 'FOLIO INTERPRETACION',A.CODPROINT AS 'MEDICO INTERPRETO',A.INTERPRET AS 'INTERPRETACION',
			A.CANSERIPS 'CANTIDAD',	A.NUMINGRES 'INGRESO',A.IPCODPACI 'IDENTIFICACION',RTRIM(PAC.IPNOMCOMP) 'PACIENTE' ,
			CASE WHEN SERREASIT='1' THEN 'Estudios Realizados en Sitio' WHEN  ESTSERIPS IN ('2','3','4') THEN 'Estudios Realizados' when ESTSERIPS = '6' then 'Anulado' ELSE 'Estudios No Realizados' END AS 'ESTADO',
			A.MEDREALEC as 'MEDICO LECTURA',
			A.FECHLECT as 'FECHA LECTURA',
			CASE WHEN A.MEDREALEC IS NULL THEN 'NO' ELSE 'SI' END as 'LECTURA REALIZADA',
			ISNULL(cd.Code + ' - ' + cd.Name, '') 'DESCRIPCION RELACIONADA',A.NOMARCIMG 'ADJUNTO'
	FROM dbo.HCORDIMAG A 
	INNER JOIN dbo.INCUPSIPS B with (nolock) ON A.CODSERIPS=B.CODSERIPS 
	INNER JOIN DBO.INPACIENT AS PAC with (nolock) ON PAC.IPCODPACI =A.IPCODPACI
	INNER JOIN dbo.INPROFSAL C with (nolock) ON A.CODPROSAL=C.CODPROSAL 	
	INNER JOIN dbo.INUNIFUNC D with (nolock) ON A.UFUCODIGO=D.UFUCODIGO
	INNER JOIN dbo.HCINGRESORECNAC INGMH  with (nolock) ON a.NUMINGRES = INGMH .NUMINGRESHIJO
	INNER JOIN dbo.HCRECINAC RN  with (nolock) ON INGMH.NUMINGRESHIJO  = rn.NUMINGRESHIJO  
	INNER JOIN dbo.ADINGRESO AS ING  with (nolock) ON ING.NUMINGRES = INGMH.NUMINGRESHIJO  
	INNER JOIN CTE_INGRESOS_CON_PENDIENTES AS PEN with (nolock) ON PEN.NUMINGRES =ING.NUMINGRES
	LEFT JOIN dbo.INPROFSAL CR with (nolock) ON COALESCE(A.MEDREALEC, A.CODPROSAL)=CR.CODPROSAL
	LEFT JOIN Contract.CUPSEntityContractDescriptions cecd with (nolock) ON cecd.Id = a.IDDESCRIPCIONRELACIONADA
	LEFT JOIN Contract.ContractDescriptions cd with (nolock) ON cd.Id = cecd.ContractDescriptionId
	WHERE  A.GENSERVICEORDER IS NULL and ESTSERIPS IN ('2','3','4')  AND A.MANEXTPRO = 0 --OR ISNULL(ing.TRATAESPECIA, 0) = 3 
),

------********------
--LABORATORIOS
CTE_LABORATORIOS
AS
(
SELECT	CONCAT('HCORDLABO', '-', A.AUTO) ID,
			'LABORATORIOS' EntityName,iif(A.GENSERVICEORDER IS NULL,'SIN ORDEN','CON ORDEN')  'ORDENE DE SERVICIO' ,CASE A.MANEXTPRO WHEN 0 THEN 'HOSPITALARIO' ELSE 'AMBULATORIO' END 'AMBITO', 
			A.CODSERIPS 'CODIGO CUPS',B.DESSERIPS 'PROCEDIMIENTO CUPS',
			CONCAT(RTRIM(D.UFUCODIGO), ' - ', RTRIM(D.UFUDESCRI)) AS 'UNIDAD FUNCIONAL',
			CONCAT(RTRIM(C.CODIGONIT), ' - ', RTRIM(C.NOMMEDICO)) AS 'MEDICO ORDENAMIENTO',
			A.FECORDMED AS 'FECHA ORDENAMIENTO',A.NUMEFOLIO AS 'FOLIO ORDENAMIENTO',
			A.NUMFOLINT AS 'FOLIO INTERPRETACION',A.CODPROINT AS 'MEDICO INTERPRETO',A.INTERPRET AS 'INTERPRETACION',
			A.CANSERIPS 'CANTIDAD',	A.NUMINGRES 'INGRESO',A.IPCODPACI 'IDENTIFICACION',RTRIM(PAC.IPNOMCOMP) 'PACIENTE' ,
			CASE WHEN SERREASIT='1' THEN 'Estudios Realizados' WHEN A.ESTSERIPS IN ('3','4') THEN 'Estudios Realizados' WHEN A.ESTSERIPS = '6' THEN 'Anulados' 
			WHEN A.ESTSERIPS= '1' THEN 'Solicitados'	ELSE 'No Realizados' END AS 'ESTADO',
			CASE 
				WHEN ISNULL(A.PROFRESULT, '') <> '' THEN RTRIM(LTRIM(A.PROFRESULT))
				WHEN ISNULL(I.CODPROSAL, '') <> '' THEN RTRIM(LTRIM(I.CODPROSAL))
				WHEN ISNULL(E.CODPROSAL, '') <> '' THEN RTRIM(LTRIM(E.CODPROSAL))
				ELSE NULL END  as 'MEDICO LECTURA',
			I.FECREGIST as 'FECHA LECTURA',
            'SI' 'LECTURA REALIZADA',
			ISNULL(cd.Code + ' - ' + cd.Name, '') 'DESCRIPCION RELACIONADA',A.NOMARCLAB 'ADJUNTO'
	FROM dbo.ADINGRESO ing
	INNER JOIN dbo.HCORDLABO A  with (nolock) ON ing.NUMINGRES = a.NUMINGRES
	INNER JOIN DBO.INPACIENT AS PAC with (nolock) ON PAC.IPCODPACI =A.IPCODPACI
	INNER JOIN dbo.INCUPSIPS B with (nolock) ON A.CODSERIPS=B.CODSERIPS 
	INNER JOIN dbo.INPROFSAL C with (nolock) ON A.CODPROSAL=C.CODPROSAL 	
	INNER JOIN dbo.INUNIFUNC D with (nolock) ON A.UFUCODIGO=D.UFUCODIGO
	INNER JOIN CTE_INGRESOS_CON_PENDIENTES AS PEN with (nolock) ON PEN.NUMINGRES =ING.NUMINGRES
	LEFT JOIN
	(
		SELECT I.AUTOLABOR, MIN(I.AUTO) AUTO
		FROM dbo.INTERCTRL I
		WHERE I.NUMUESTRA = 1
		GROUP BY I.AUTOLABOR
	) ID ON A.AUTO = ID.AUTOLABOR
	LEFT JOIN dbo.INTERCTRL I with (nolock) ON ID.AUTO = I.AUTO
	LEFT JOIN dbo.INPROFSAL C2 with (nolock) ON I.CODPROSAL=C2.CODPROSAL
	LEFT JOIN dbo.HCHISPACA E with (nolock) ON A.NUMINGRES = E.NUMINGRES AND A.NUMEFOLIO = E.NUMEFOLIO
	LEFT JOIN Contract.CUPSEntityContractDescriptions cecd with (nolock) ON cecd.Id = A.IDDESCRIPCIONRELACIONADA
	LEFT JOIN Contract.ContractDescriptions cd with (nolock) ON cd.Id = cecd.ContractDescriptionId
	WHERE A.GENSERVICEORDER IS NULL AND A.ESTSERIPS IN ('3','4') AND A.MANEXTPRO = 0 
UNION ALL

SELECT	CONCAT('HCORDLABO', '-', A.AUTO) ID,
			'LABORATORIOS' EntityName,iif(A.GENSERVICEORDER IS NULL,'SIN ORDEN','CON ORDEN')  'ORDENE DE SERVICIO' ,CASE A.MANEXTPRO WHEN 0 THEN 'HOSPITALARIO' ELSE 'AMBULATORIO' END 'AMBITO', 
			A.CODSERIPS 'CODIGO CUPS',B.DESSERIPS 'PROCEDIMIENTO CUPS',
			CONCAT(RTRIM(D.UFUCODIGO), ' - ', RTRIM(D.UFUDESCRI)) AS 'UNIDAD FUNCIONAL',
			CONCAT(RTRIM(C.CODIGONIT), ' - ', RTRIM(C.NOMMEDICO)) AS 'MEDICO ORDENAMIENTO',
			A.FECORDMED AS 'FECHA ORDENAMIENTO',A.NUMEFOLIO AS 'FOLIO ORDENAMIENTO',
			A.NUMFOLINT AS 'FOLIO INTERPRETACION',A.CODPROINT AS 'MEDICO INTERPRETO',A.INTERPRET AS 'INTERPRETACION',
			A.CANSERIPS 'CANTIDAD',	A.NUMINGRES 'INGRESO',A.IPCODPACI 'IDENTIFICACION',RTRIM(PAC.IPNOMCOMP) 'PACIENTE' ,
			CASE WHEN SERREASIT='1' THEN 'Estudios Realizados' WHEN A.ESTSERIPS IN ('3','4') THEN 'Estudios Realizados' WHEN A.ESTSERIPS = '6' THEN 'Anulados' 
			WHEN A.ESTSERIPS= '1' THEN 'Solicitados'	ELSE 'No Realizados' END AS 'ESTADO',
			CASE 
				WHEN ISNULL(A.PROFRESULT, '') <> '' THEN RTRIM(LTRIM(A.PROFRESULT))
				WHEN ISNULL(I.CODPROSAL, '') <> '' THEN RTRIM(LTRIM(I.CODPROSAL))
				WHEN ISNULL(E.CODPROSAL, '') <> '' THEN RTRIM(LTRIM(E.CODPROSAL))
				ELSE NULL END  as 'MEDICO LECTURA',
			I.FECREGIST as 'FECHA LECTURA',
            'SI' 'LECTURA REALIZADA',
			ISNULL(cd.Code + ' - ' + cd.Name, '') 'DESCRIPCION RELACIONADA',A.NOMARCLAB 'ADJUNTO'
	FROM dbo.HCORDLABO A 
	INNER JOIN dbo.INCUPSIPS B with (nolock) ON A.CODSERIPS = B.CODSERIPS 
	INNER JOIN DBO.INPACIENT AS PAC with (nolock) ON PAC.IPCODPACI =A.IPCODPACI
	INNER JOIN dbo.INPROFSAL C with (nolock) ON A.CODPROSAL = C.CODPROSAL 
	INNER JOIN dbo.INUNIFUNC D with (nolock) ON A.UFUCODIGO = D.UFUCODIGO
	INNER JOIN CTE_INGRESOS_CON_PENDIENTES AS PEN with (nolock) ON PEN.NUMINGRES =A.NUMINGRES
	INNER JOIN
	(
		SELECT INGMH.NUMINGRESHIJO, MIN(INGMH.ID) ID
		FROM dbo.HCINGRESORECNAC INGMH
		GROUP BY INGMH.NUMINGRESHIJO
	) INGMHD ON A.NUMINGRES = INGMHD.NUMINGRESHIJO
	INNER JOIN dbo.HCINGRESORECNAC INGMH with (nolock) ON INGMHD.ID = INGMH.ID
	INNER JOIN dbo.HCRECINAC RN with (nolock) ON INGMH.NUMINGRESHIJO  = rn.NUMINGRESHIJO  
	INNER JOIN  dbo.ADINGRESO AS ING with (nolock) ON ING.NUMINGRES = INGMH.NUMINGRESHIJO  
	LEFT JOIN
	(
		SELECT I.AUTOLABOR, MIN(I.AUTO) AUTO
		FROM dbo.INTERCTRL I
		WHERE I.NUMUESTRA = 1
		GROUP BY I.AUTOLABOR
	) ID ON A.AUTO = ID.AUTOLABOR
	LEFT JOIN dbo.INTERCTRL I with (nolock) ON ID.AUTO = I.AUTO
	LEFT JOIN dbo.INPROFSAL C2 with (nolock) ON I.CODPROSAL = C2.CODPROSAL 
	LEFT JOIN dbo.HCHISPACA E with (nolock) ON INGMH.NUMINGRES = E.NUMINGRES AND A.NUMEFOLIO = E.NUMEFOLIO
	LEFT JOIN Contract.CUPSEntityContractDescriptions cecd with (nolock) ON cecd.Id = A.IDDESCRIPCIONRELACIONADA
	LEFT JOIN Contract.ContractDescriptions cd with (nolock) ON cd.Id = cecd.ContractDescriptionId
	WHERE A.GENSERVICEORDER IS NULL AND A.ESTSERIPS IN ('3','4') AND A.MANEXTPRO = 0 
),

CTE_PATOLOGIAS
AS
(
SELECT	CONCAT('HCORDPATO', '-', A.AUTO) Id,
			'PATOLOGIAS' EntityName,iif(A.GENSERVICEORDER IS NULL,'SIN ORDEN','CON ORDEN')  'ORDENE DE SERVICIO' ,
			CASE A.MANEXTPRO WHEN 0 THEN 'HOSPITALARIO' ELSE 'AMBULATORIO' END 'AMBITO', 
			A.CODSERIPS 'CODIGO CUPS',B.DESSERIPS 'PROCEDIMIENTO CUPS',
			CONCAT(RTRIM(D.UFUCODIGO), ' - ', RTRIM(D.UFUDESCRI)) AS 'UNIDAD FUNCIONAL',
			CONCAT(RTRIM(C.CODIGONIT), ' - ', RTRIM(C.NOMMEDICO)) AS 'MEDICO ORDENAMIENTO',
			A.FECORDMED AS 'FECHA ORDENAMIENTO',A.NUMEFOLIO AS 'FOLIO ORDENAMIENTO',
			A.NUMFOLINT AS 'FOLIO INTERPRETACION',A.CODPROINT AS 'MEDICO INTERPRETO',A.INTERPRET AS 'INTERPRETACION',
			A.CANSERIPS 'CANTIDAD',	A.NUMINGRES 'INGRESO',A.IPCODPACI 'IDENTIFICACION',RTRIM(PAC.IPNOMCOMP) 'PACIENTE' ,
			CASE 
				WHEN ESTSERIPS IN ('3','4') THEN 'Estudios Realizados' when ESTSERIPS = '6' then 'Anulados'	when ESTSERIPS = '1' then 'Solicitados'
				ELSE 'No Realizados' END AS 'ESTADO',
			CASE WHEN A.PROFRESULTADO IS NULL THEN A.CODPROSAL ELSE A.PROFRESULTADO END as 'MEDICO LECTURA',

			CASE WHEN A.PROFRESULTADO IS NULL THEN A.FECORDMED ELSE A.FECHARESULT END as 'FECHA LECTURA',
			IIF(CASE WHEN A.PROFRESULTADO IS NULL THEN A.FECORDMED ELSE A.FECHARESULT END IS NULL,'NO','SI') 'LECTURA REALIZADA',
			ISNULL(cd.Code + ' - ' + cd.Name, '') 'DESCRIPCION RELACIONADA',A.NOMARCPAT 'ADJUNTO'
	FROM dbo.ADINGRESO ing with (nolock)
	INNER JOIN dbo.HCORDPATO A with (nolock) ON ing.NUMINGRES = A.NUMINGRES
	INNER JOIN DBO.INPACIENT AS PAC with (nolock) ON PAC.IPCODPACI =A.IPCODPACI
	INNER JOIN dbo.INCUPSIPS B with (nolock) ON A.CODSERIPS=B.CODSERIPS 
	INNER JOIN dbo.INPROFSAL C with (nolock) ON A.CODPROSAL=C.CODPROSAL 
	INNER JOIN dbo.INUNIFUNC D with (nolock) ON A.UFUCODIGO=D.UFUCODIGO
	INNER JOIN dbo.INPACIENT i with (nolock) ON a.IPCODPACI = i.IPCODPACI 
	INNER JOIN CTE_INGRESOS_CON_PENDIENTES AS PEN with (nolock) ON PEN.NUMINGRES =ING.NUMINGRES
	LEFT JOIN Contract.CUPSEntityContractDescriptions cecd with (nolock) ON cecd.Id = a.IDDESCRIPCIONRELACIONADA
	LEFT JOIN Contract.ContractDescriptions cd with (nolock) ON cd.Id = cecd.ContractDescriptionId
	WHERE A.GENSERVICEORDER IS NULL AND A.ESTSERIPS IN ('3','4') AND A.MANEXTPRO = 0

UNION ALL

SELECT	CONCAT('HCORDPATO', '-', A.AUTO) Id,
			'PATOLOGIAS' EntityName,iif(A.GENSERVICEORDER IS NULL,'SIN ORDEN','CON ORDEN')  'ORDENE DE SERVICIO' ,
			CASE A.MANEXTPRO WHEN 0 THEN 'HOSPITALARIO' ELSE 'AMBULATORIO' END 'AMBITO', 
			A.CODSERIPS 'CODIGO CUPS',B.DESSERIPS 'PROCEDIMIENTO CUPS',
			CONCAT(RTRIM(D.UFUCODIGO), ' - ', RTRIM(D.UFUDESCRI)) AS 'UNIDAD FUNCIONAL',
			CONCAT(RTRIM(C.CODIGONIT), ' - ', RTRIM(C.NOMMEDICO)) AS 'MEDICO ORDENAMIENTO',
			A.FECORDMED AS 'FECHA ORDENAMIENTO',A.NUMEFOLIO AS 'FOLIO ORDENAMIENTO',
			A.NUMFOLINT AS 'FOLIO INTERPRETACION',A.CODPROINT AS 'MEDICO INTERPRETO',A.INTERPRET AS 'INTERPRETACION',
			A.CANSERIPS 'CANTIDAD',	A.NUMINGRES 'INGRESO',A.IPCODPACI 'IDENTIFICACION',RTRIM(PAC.IPNOMCOMP) 'PACIENTE' ,
			CASE 
				WHEN ESTSERIPS IN ('3','4') THEN 'Estudios Realizados' when ESTSERIPS = '6' then 'Anulados'	when ESTSERIPS = '1' then 'Solicitados'
				ELSE 'No Realizados' END AS 'ESTADO',
			CASE WHEN A.PROFRESULTADO IS NULL THEN A.CODPROSAL ELSE A.PROFRESULTADO END as 'MEDICO LECTURA',
			CASE WHEN A.PROFRESULTADO IS NULL THEN A.FECORDMED ELSE A.FECHARESULT END as 'FECHA LECTURA',
			IIF(CASE WHEN A.PROFRESULTADO IS NULL THEN A.FECORDMED ELSE A.FECHARESULT END IS NULL,'NO','SI') 'LECTURA REALIZADA',
			ISNULL(cd.Code + ' - ' + cd.Name, '') 'DESCRIPCION RELACIONADA',A.NOMARCPAT 'ADJUNTO'
	
	FROM dbo.HCORDPATO A  with (nolock) 
	INNER JOIN dbo.INCUPSIPS B with (nolock) ON A.CODSERIPS=B.CODSERIPS 
	INNER JOIN dbo.INPROFSAL C with (nolock) ON A.CODPROSAL=C.CODPROSAL 
	INNER JOIN dbo.INUNIFUNC D with (nolock) ON A.UFUCODIGO=D.UFUCODIGO
	INNER JOIN dbo.HCINGRESORECNAC INGMH  with (nolock) ON a.NUMINGRES = INGMH .NUMINGRESHIJO
	INNER JOIN dbo.HCRECINAC RN  with (nolock) ON INGMH.NUMINGRESHIJO  = rn.NUMINGRESHIJO  
	INNER JOIN dbo.ADINGRESO AS ING  with (nolock) ON ING.NUMINGRES = INGMH.NUMINGRESHIJO 
	INNER JOIN DBO.INPACIENT AS PAC with (nolock) ON PAC.IPCODPACI =A.IPCODPACI
	INNER JOIN dbo.INPACIENT i with (nolock) ON a.IPCODPACI = i.IPCODPACI 
	INNER JOIN CTE_INGRESOS_CON_PENDIENTES AS PEN with (nolock) ON PEN.NUMINGRES =ING.NUMINGRES
	LEFT JOIN Contract.CUPSEntityContractDescriptions cecd with (nolock) ON cecd.Id = a.IDDESCRIPCIONRELACIONADA
	LEFT JOIN Contract.ContractDescriptions cd with (nolock) ON cd.Id = cecd.ContractDescriptionId
	WHERE A.GENSERVICEORDER IS NULL AND A.ESTSERIPS IN ('3','4') AND A.MANEXTPRO = 0
),

CTE_ALTA_MEDICA
AS
(
  SELECT EGR.NUMINGRES ,EGR.IPCODPACI ,MAX(FECALTPAC) 'FECHA ALTA' FROM DBO.HCREGEGRE EGR with (nolock) 
  INNER JOIN CTE_INGRESOS_CON_PENDIENTES AS PEN with (nolock) ON PEN.NUMINGRES =EGR.NUMINGRES 
  GROUP BY EGR.NUMINGRES ,EGR.IPCODPACI
),

CTE_ESTANCIA_MAYOR
AS
(
  SELECT C.NUMINGRES ,C.IPCODPACI,C.CODICAMAS  ,C.FECINIEST 'FECHA ESTANCIA',C.REGESTADO,C.CODTIPEST,C.ID    FROM dbo.CHREGESTA C with (nolock)
  INNER JOIN CTE_INGRESOS_CON_PENDIENTES AS PEN ON PEN.NUMINGRES =C.NUMINGRES 
  INNER JOIN(SELECT C.NUMINGRES ,C.IPCODPACI ,MAX(C.ID ) IDD FROM dbo.CHREGESTA C with (nolock) GROUP BY C.NUMINGRES ,C.IPCODPACI) AS G ON G.IDD =C.ID 
),

CTE_CAMAS
AS
(
     SELECT FUN.UFUDESCRI 'UNIDAD FUNCIONAL' ,C.IPCODPACI 'IDENTIFICACION' ,C.NUMINGRES 'INGRESO',A.NUMCAMHOS 'CAMA',G.DESTIPEST 'TIPO ESTANCIA'  ,C.ID  'ID_ESTANCIA', 
	 A.CODICAMAS 'ID_CAMAS', CEN.NOMCENATE 'CENTRO DE ATENCION',A.CODCLAHAB ,A.CODCLACAM 
	 FROM dbo.CHCAMASHO A with (nolock)
	 INNER JOIN DBO.INUNIFUNC AS FUN with (nolock) ON A.UFUCODIGO =FUN.UFUCODIGO 
	 INNER JOIN CTE_ESTANCIA_MAYOR C with (nolock) ON A.CODICAMAS=C.CODICAMAS AND C.REGESTADO = 1 
     INNER JOIN dbo.CHTIPESTA G with (nolock) ON G.CODTIPEST=C.CODTIPEST 
	 INNER JOIN DBO.ADCENATEN AS CEN with (nolock) ON CEN.CODCENATE =A.CODCENATE 
),

CTE_HISTORIAS_AMBULATORIAS
AS
(
  SELECT HIS.NUMINGRES ,HIS.IPCODPACI ,MAX(FECHISPAC) AS 'FECHA ALTA'    FROM  DBO.HCHISPACA HIS with (nolock)
  INNER JOIN CTE_INGRESOS_CON_PENDIENTES AS PEN with (nolock) ON PEN.NUMINGRES =HIS.NUMINGRES 
  WHERE HIS.GENCONEXT =1
  GROUP BY HIS.NUMINGRES ,HIS.IPCODPACI
),

CTE_PARACLINICOS as (
SELECT img.*,ing.IESTADOIN 'ESTADO INGRESO' ,f.InvoiceNumber 'NRO FACTURA' ,C.RadicatedConsecutive 'NRO RADICADO',ALT.[FECHA ALTA] ,CAM.CAMA 
FROM CTE_IMAGENES  as img with (nolock) 
inner join dbo.ADINGRESO as ing with (nolock) ON img.INGRESO =ing.NUMINGRES 
left join Billing .Invoice as f with (nolock) ON f.AdmissionNumber =ing.NUMINGRES and f.Status =1
LEFT JOIN Portfolio.RadicateInvoiceD AS RAD with (nolock) ON RAD.InvoiceNumber =F.InvoiceNumber 
LEFT JOIN Portfolio .RadicateInvoiceC AS C with (nolock) ON C.Id =RAD.RadicateInvoiceCId 
LEFT JOIN CTE_ALTA_MEDICA AS ALT with (nolock) ON ALT.NUMINGRES =IMG.INGRESO 
LEFT JOIN CTE_CAMAS AS CAM with (nolock) ON  CAM.INGRESO =IMG.INGRESO
UNION ALL
SELECT img.*,ing.IESTADOIN 'ESTADO INGRESO' ,f.InvoiceNumber 'NRO FACTURA' ,C.RadicatedConsecutive 'NRO RADICADO',ALT.[FECHA ALTA] ,CAM.CAMA
FROM CTE_LABORATORIOS as img with (nolock)
inner join dbo.ADINGRESO as ing with (nolock) ON img.INGRESO =ing.NUMINGRES 
left join Billing .Invoice as f with (nolock) ON f.AdmissionNumber =ing.NUMINGRES and f.Status =1
LEFT JOIN Portfolio.RadicateInvoiceD AS RAD with (nolock) ON RAD.InvoiceNumber =F.InvoiceNumber 
LEFT JOIN Portfolio .RadicateInvoiceC AS C with (nolock) ON C.Id =RAD.RadicateInvoiceCId 
LEFT JOIN CTE_ALTA_MEDICA AS ALT with (nolock) ON ALT.NUMINGRES =IMG.INGRESO
LEFT JOIN CTE_CAMAS AS CAM with (nolock) ON  CAM.INGRESO =IMG.INGRESO
UNION ALL
SELECT img.*,ing.IESTADOIN 'ESTADO INGRESO' ,f.InvoiceNumber 'NRO FACTURA' ,C.RadicatedConsecutive 'NRO RADICADO',ALT.[FECHA ALTA]  ,CAM.CAMA
FROM CTE_PATOLOGIAS as img
inner join dbo.ADINGRESO as ing with (nolock) ON img.INGRESO =ing.NUMINGRES 
left join Billing .Invoice as f with (nolock) ON f.AdmissionNumber =ing.NUMINGRES and f.Status =1
LEFT JOIN Portfolio.RadicateInvoiceD AS RAD with (nolock) ON RAD.InvoiceNumber =F.InvoiceNumber 
LEFT JOIN Portfolio .RadicateInvoiceC AS C with (nolock) ON C.Id =RAD.RadicateInvoiceCId 
LEFT JOIN CTE_ALTA_MEDICA AS ALT with (nolock) ON ALT.NUMINGRES =IMG.INGRESO
LEFT JOIN CTE_CAMAS AS CAM with (nolock) ON  CAM.INGRESO =IMG.INGRESO
)

SELECT 
 CAST(DB_NAME() AS VARCHAR(9)) AS ID_COMPANY, 
 *,
 CONVERT(DATETIME,GETDATE() AT TIME ZONE 'Pakistan Standard Time',1) AS ULT_ACTUAL
FROM CTE_PARACLINICOS

-- Workspace: HOMI
-- Item: DataWareHouse_Clinical [Warehouse]
-- ItemId: 9e4ad354-8031-4a13-8643-33b3234761ff
-- Schema: Report
-- Object: VW_VIEWEXTRAMURALES
-- Extracted by Fabric SQL Extractor SPN v3.9.0


CREATE VIEW [Report].[ViewExtramurales] AS

WITH CTE_ORDENES
AS
(
SELECT DISTINCT * FROM (
SELECT 
	H.IPCODPACI 
	,H.NUMINGRES 
	,H.CODPROSAL
	,H.FECORDMED 
	,H.CODSERIPS
	,H.IDDESCRIPCIONRELACIONADA 
	,H.CANSERIPS 'CANTIDAD'
	,H.CODDIAGNO
	,CASE ESTSERIPS WHEN 1 THEN 'Ordenado' 
				   WHEN 2 THEN 'Completado' 
				   WHEN 3 THEN 'Interpretado' 
				   WHEN 4 THEN 'Completado' 
				   WHEN 5 THEN 'Anulado'
				   WHEN 6 THEN 'Sala programada' END ESTADO
	,UF.UFUDESCRI AS [UNIDAD FUNCIONAL]
FROM [INDIGO036].[dbo].[HCORDPRON] AS H
	INNER JOIN [INDIGO036].[dbo].[INUNIFUNC] AS UF 
		ON H.UFUCODIGO=UF.UFUCODIGO
WHERE CODSERIPS IN ('601T01','601T02','602T01','602T02','O201','O202','O204','O205','O207','O211','O212','O213','O214','O220','O222','O223',
'O224','O226','O227','O229','O653','O733','920105','920106','920202','920203','920204','920208','920301','920304','920410','920501','920502',
'920503','920505','920510','920601','920602','920604','920605','920606','920607','920608','920701','920702','920707','920708','920802','920804',
'920805','920806','920807','920808','920809','920811','920812','920901','920902','920903','921100','921200','921301','921302','920215','920310',
'920609','920703','920705','920706','920904','921303','921700','921800','873305','871062','883321','883322','883324',
'922506','890287','922441','922441','922441','922441','922442','922443','922444','922445','922504','922504','922505','922201','922321','922322',
'922446','950505','951302','951303','951304','951903','951903','952101','952102','952001','903606','903607',
'954105','954301','954302','954304','954307','893201','893202','592402','H00028','890102','890283','890476','890283','332209',
'879114','879431','879903','879904','879905','879911','879920','951903') 
--AND H.NUMEFOLIO=(SELECT MAX(O.NUMEFOLIO) FROM [INDIGO036].[dbo].[dbo_HCORDPRON] O WHERE H.IPCODPACI=O.IPCODPACI)

UNION ALL

SELECT 
	H.IPCODPACI 
	,H.NUMINGRES 
	,H.CODPROSAL 
	,H.FECORDMED 
	,H.CODSERIPS 
	,H.IDDESCRIPCIONRELACIONADA
	,H.CANSERIPS 'CANTIDAD'
	,H.CODDIAGNO
	,CASE ESTSERIPS WHEN 1 THEN 'Solicitado' 
				   WHEN 2 THEN 'Sala Programada' 
				   WHEN 3 THEN 'Cancelado' 
				   WHEN 4 THEN 'Resultado Revisado' END ESTADO
	,UF.UFUDESCRI AS [UNIDAD FUNCIONAL]
FROM [INDIGO036].[dbo].[HCORDPROQ] AS H
	INNER JOIN [INDIGO036].[dbo].[INUNIFUNC] AS UF 
		ON H.UFUCODIGO=UF.UFUCODIGO
WHERE H.CODSERIPS IN ('601T01','601T02','602T01','602T02','O201','O202','O204','O205','O207','O211','O212','O213','O214','O220','O222','O223','O224',
'O226','O227','O229','O653','O733','920105','920106','920202','920203','920204','920208','920301','920304','920410','920501','920502','920503',
'920505','920510','920601','920602','920604','920605','920606','920607','920608','920701','920702','920707','920708','920802','920804','920805',
'920806','920807','920808','920809','920811','920812','920901','920902','920903','921100','921200','921301','921302','920215','920310','920609',
'920703','920705','920706','920904','921303','921700','921800','873305','871062','883321','883322','883324','922506',
'890287','922441','922441','922441','922441','922442','922443','922444','922445','922504','922504','922505','922201','922321','922322','922446',
'950505','951302','951303','951304','951903','951903','952101','952102','952001','903606','903607','954105',
'954301','954302','954304','954307','893201','893202','592402','H00028','890102','890283','332209','879114',
'879431','879903','879904','879905','879911','879920','951903')
--AND H.NUMEFOLIO=(SELECT MAX(O.NUMEFOLIO) FROM HCORDPROQ O WHERE H.IPCODPACI=O.IPCODPACI)

UNION ALL

SELECT 
	H.IPCODPACI 
	,H.NUMINGRES 
	,H.CODPROSAL 
	,H.FECORDMED 
	,LTRIM(RTRIM(H.CODSERIPS))
	,H.IDDESCRIPCIONRELACIONADA 
	,H.CANSERIPS 'CANTIDAD'
	,H.CODDIAGNO
	,CASE H.ESTSERIPS WHEN 1 THEN 'Solicitado' 
					 WHEN 2 THEN 'Estudio Realizado' 
					 WHEN 3 THEN 'Imagen Procesada' 
					 WHEN 4 THEN 'Estudio Interpretado' 
					 WHEN 5 THEN 'Remitido'
					 WHEN 6 THEN 'Anulado' 
					 WHEN 7 THEN 'Extramural' END ESTADO
	,UF.UFUDESCRI AS [UNIDAD FUNCIONAL]
FROM [INDIGO036].[dbo].[HCORDIMAG] AS H
	INNER JOIN [INDIGO036].[dbo].[INUNIFUNC] AS UF 
		ON H.UFUCODIGO=UF.UFUCODIGO
WHERE H.CODSERIPS IN ('601T01','601T02','602T01','602T02','O201','O202','O204','O205','O207','O211','O212','O213','O214','O220','O222','O223','O224',
'O226','O227','O229','O653','O733','920105','920106','920202','920203','920204','920208','920301','920304','920410','920501','920502','920503 ',
'920505','920510','920601','920602','920604','920605','920606','920607','920608','920701','920702','920707','920708','920802','920804','920805',
'920806','920807','920808','920809','920811','920812','920901','920902','920903','921100','921200','921301','921302','920215','920310','920609',
'920703','920705','920706','920904','921303','921700','921800','873305','871062','883321','883322','883324','922506',
'890287','922441','922441','922441','922441','922442','922443','922444','922445','922504','922504','922505','922201','922321','922322','922446',
'950505','951302','951303','951304','951903','951903','952101','952102','952001','903606','903607','954105',
'954301','954302','954304','954307','893201','893202','592402','H00028','890102','890283','332209','879114',
'879431','879903','879904','879905','879911','879920','951903')) as a
--AND H.NUMEFOLIO=(SELECT MAX(O.NUMEFOLIO) FROM HCORDIMAG O WHERE H.IPCODPACI=O.IPCODPACI)

UNION ALL 

SELECT 
	I.IPCODPACI 
	,I.NUMINGRES 
	,I.CODPROSAL 
	,I.FECORDMED 
	,I.CODSERIPS 
	,I.IDDESCRIPCIONRELACIONADA
	,I.CANSERIPS 'CANTIDAD'
	,I.CODDIAGNO
	,CASE ESTSERIPS WHEN 1 THEN 'Solicitado' 
				   WHEN 2 THEN 'Solicitud Enviada' 
				   WHEN 3 THEN 'Interconsulta Realizada' 
				   WHEN 4 THEN 'Extramural' 
				   WHEN 5 THEN 'Anulado' END ESTADO
	,UF.UFUDESCRI AS [UNIDAD FUNCIONAL]
	
FROM [INDIGO036].[dbo].[HCORDINTE] AS I
	INNER JOIN [INDIGO036].[dbo].[INUNIFUNC] AS UF 
		ON I.UFUCODIGO=UF.UFUCODIGO
WHERE I.CODSERIPS IN ('890476','890487')

)
,
CTE_NOTA
AS
(

SELECT  
	FECHACREACION
	,NOMBRE
	,IPCODPACI
	,CASE WHEN NUMINGRES IS NULL THEN TRIM([116]) ELSE NUMINGRES END AS NUMINGRES
	,[14] 'FECHA REGISTRO'
	,[73]'OBSERVACION'
	,CODUSUARI
	,CASE WHEN [79]='SI' THEN 'SOLICITADO'
		 WHEN [80]='SI' THEN 'EN PROCESO'
		 WHEN [81]='SI' THEN 'COMPLETADO'
		 WHEN [82]='SI' THEN 'CANCELADO' END 'ESTADO'
	,[118]'FECHA ORDEN MEDICA'
	,CASE WHEN LEN(TRIM(SUBSTRING (REPLACE([118],'/',''),0,9))) <8 THEN '0'+TRIM(SUBSTRING (REPLACE([118],'/',''),2,2)) ELSE TRIM(SUBSTRING (REPLACE([118],'/',''),3,2)) END 'MES'
	,SUBSTRING(LTRIM(RTRIM(CAST([117] AS CHAR (20)))),0,7) 'CUPS' 
FROM (
	SELECT REG.FECHACREACION FECHACREACION
	,NT.NOMBRE
	, REG.IPCODPACI
	, REG.NUMINGRES
	,IDNTVARIABLE
	, DET1.VALOR
	,REG.CODUSUARI
FROM [INDIGO036].[dbo].[NTXVARIABLES] AS VARI 
	LEFT JOIN [INDIGO036].[dbo].[NTADMINISTRATIVAS] AS NT 
		ON NT.ID=VARI.IDNTADMINISTRATIVAS
	LEFT JOIN [INDIGO036].[dbo].[NTNOTASADMINISTRATIVASC] AS REG 
		ON REG.IDNOTAADMINISTRATIVA=VARI.IDNTADMINISTRATIVAS
	LEFT JOIN [INDIGO036].[dbo].[NTNOTASADMINISTRATIVASD] AS DET1 
		ON DET1.IDNTNOTASADMINISTRATIVASC=REG.ID 
WHERE NT.ID=9 AND VARI.IDNTADMINISTRATIVAS=9  ) AS EXTRA
PIVOT 
(MAX(VALOR) 
	FOR IDNTVARIABLE IN ([14],[73],[79],[80],[81],[82],[116],[117],[118]) 
	)AS CONSULTA

--AND REG.IPCODPACI='1074828820'
),

CTE_ESTANCIAS
AS
(
SELECT ROW_NUMBER () OVER(PARTITION BY EST.IPCODPACI ORDER BY EST.FECREGSIS DESC) NUMES
	,EST.IPCODPACI
	, EST.NUMINGRES
	,EST.FECINIEST
	,FECFINEST
	, EST.CODICAMAS
	, CAM.DESCCAMAS
	,EST.FECREGSIS
	, EST.REGESTADO  
FROM [INDIGO036].[dbo].[CHREGESTA] AS EST
	INNER JOIN [INDIGO036].[dbo].[CHCAMASHO] AS CAM 
		ON CAM.CODICAMAS=EST.CODICAMAS 
		AND EST.REGESTADO=1
)

SELECT 
	CAST(DB_NAME() AS VARCHAR(9)) AS ID_COMPANY   
	,HA.Code 'COD. EAPB'
	,HA.Name 'ENTIDAD'
	,ISNULL(EXT.NUMINGRES,'NO REGISTRA') 'INGRESO'
	,ORD.IPCODPACI 'ID PACIENTE'
	,PAC.IPNOMCOMP 'NOMBRE PACIENTE'
	,DATEDIFF(YEAR,PAC.IPFECNACI,GETDATE()) 'EDAD (AÑOS)'
	,ORD.NUMINGRES 'INGRESO ORDEN'
	,ISNULL(EST.DESCCAMAS,'NA/EXTRAMURAL') 'CAMA ACTUAL'
	,ORD.[UNIDAD FUNCIONAL]
	,ORD.CODPROSAL 'COD. PROFESIONAL'
	,ORD.FECORDMED 'FECHA ORDEN'
	,ORD.CODSERIPS 'COD. CUPS'
	,CUPS.DESCODCUPS 'NOMBRE SERVICIO'
	,RELA.Name 'DESCRIPCION RELACIONADA'
	,ORD.CODDIAGNO 'COD. CIE-10' 
	,DIA.NOMDIAGNO 'NOMBRE DX'
	,ORD.CANTIDAD 'CANTIDAD'
	,ORD.ESTADO 'ESTADO ORDEN'
	,CASE WHEN EXT.FECHACREACION IS NOT NULL THEN CAST(EXT.FECHACREACION AS datetime) 
			ELSE '' END 'FECHA REGISTRO NOTA'
	,ISNULL(EXT.OBSERVACION,'NO REGISTRA') [OBSERVACIONES NOTA]
	,ISNULL(EXT.ESTADO,'NO REGISTRA') 'ESTADO NOTA'
	,ISNULL(USU.NOMUSUARI,'NO REGISTRA') 'USUARIO REGISTRA NOTA'
	,CAST(ORD.FECORDMED  AS date) AS 'FECHA BUSQUEDA'
	,YEAR(ORD.FECORDMED) AS 'AÑO BUSQUEDA'
	,MONTH(ORD.FECORDMED) AS 'MES BUSQUEDA'
	,CONCAT(FORMAT(MONTH(ORD.FECORDMED), '00') ,' - ' 
	,CASE MONTH(ORD.FECORDMED) 
		    WHEN 1 THEN 'ENERO'
	   	    WHEN 2 THEN 'FEBRERO'
		    WHEN 3 THEN 'MARZO'
		    WHEN 4 THEN 'ABRIL'
		    WHEN 5 THEN 'MAYO'
		    WHEN 6 THEN 'JUNIO'
		    WHEN 7 THEN 'JULIO'
		    WHEN 8 THEN 'AGOSTO'
		    WHEN 9 THEN 'SEPTIEMBRE'
		    WHEN 10 THEN 'OCTUBRE'
		    WHEN 11 THEN 'NOVIEMBRE'
		    WHEN 12 THEN 'DICIEMBRE' END) 'MES NOMBRE BUSQUEDA'
	,CONVERT(DATETIME,GETDATE() AT TIME ZONE 'Pakistan Standard Time',1) AS ULT_ACTUAL
FROM 
	CTE_ORDENES AS ORD 
	LEFT JOIN [INDIGO036].[dbo].[INCUPSIPS] AS CUPS 
		ON CUPS.CODSERIPS=ORD.CODSERIPS
	LEFT JOIN [INDIGO036].[dbo].[INPACIENT] AS PAC 
		ON PAC.IPCODPACI=ORD.IPCODPACI
	LEFT JOIN [INDIGO036].[Contract].[HealthAdministrator] AS HA 
		ON HA.Id=PAC.GENCONENTITY
	LEFT JOIN [INDIGO036].[Contract].[ContractDescriptions] AS RELA 
		ON RELA.Id=ORD.IDDESCRIPCIONRELACIONADA
	LEFT JOIN CTE_ESTANCIAS AS EST 
		ON  EST.IPCODPACI=ORD.IPCODPACI 
		AND EST.NUMINGRES=ORD.NUMINGRES
	LEFT JOIN [INDIGO036].[dbo].[INDIAGNOS] AS DIA 
		ON DIA.CODDIAGNO=ORD.CODDIAGNO
	LEFT JOIN CTE_NOTA AS EXT 
		ON EXT.NUMINGRES=ORD.NUMINGRES 
		AND EXT.[MES]=MONTH(ORD.FECORDMED)   
		AND EXT.[FECHACREACION]> ORD.FECORDMED 
		AND EXT.[CUPS]=ORD.CODSERIPS
	LEFT JOIN [INDIGO036].[dbo].[SEGusuaru] AS USU 
		ON USU.CODUSUARI=EXT.CODUSUARI
--WHERE CAST(ORD.FECORDMED AS date) BETWEEN '2024-09-26' AND '2024-09-26'

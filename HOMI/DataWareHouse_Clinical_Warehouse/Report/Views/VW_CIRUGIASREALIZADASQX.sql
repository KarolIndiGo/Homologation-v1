-- Workspace: HOMI
-- Item: DataWareHouse_Clinical [Warehouse]
-- ItemId: 9e4ad354-8031-4a13-8643-33b3234761ff
-- Schema: Report
-- Object: VW_CIRUGIASREALIZADASQX
-- Extracted by Fabric SQL Extractor SPN v3.9.0

CREATE VIEW Report.VW_CIRUGIASREALIZADASQX AS

WITH CTE_ANESTESIA AS (
    SELECT 
        ANE.NUMINGRES,
        RCX.CODCIRUGI AS CUPS,
        ANE.HORINIANES,
        ANE.HORFINANES,
        ANE.OBSERVACIO,
        RTRIM(PRO.CODPROSAL) + '-' + PRO.NOMMEDICO AS MEDICO
    FROM INDIGO036.dbo.HCREGANES ANE
    INNER JOIN INDIGO036.dbo.HCREGICIR RCX ON ANE.IDANESTES = RCX.IDREGIANES
    INNER JOIN INDIGO036.dbo.INPROFSAL PRO ON PRO.CODPROSAL = ANE.CODPROSAL
    WHERE
        ANE.NUMEFOLIO IS NOT NULL
    GROUP BY 
        ANE.NUMINGRES,
        RCX.CODCIRUGI,
        ANE.HORINIANES,
        ANE.OBSERVACIO,
        RTRIM(PRO.CODPROSAL) + '-' + PRO.NOMMEDICO,
        ANE.HORFINANES
)
SELECT
    CAST(DB_NAME() AS VARCHAR(9)) AS ID_COMPANY,
    CASE
        PAC.IPTIPODOC
        WHEN '1' THEN 'CC'
        WHEN '2' THEN 'CE'
        WHEN '3' THEN 'TI'
        WHEN '4' THEN 'RC'
        WHEN '5' THEN 'PA'
        WHEN '6' THEN 'AS'
        WHEN '7' THEN 'MS'
        WHEN '8' THEN 'NU'
        WHEN '9' THEN 'NV'
        WHEN '10' THEN 'CD'
        WHEN '11' THEN 'SC'
        WHEN '12' THEN 'PE'
    END AS [TIPO IDENTIFICACION],
    PR.IPCODPACI AS [NUMERO_IDENTIFICACION],
    CASE
        IPSEXOPAC
        WHEN 1 THEN 'MASCULINO'
        WHEN 2 THEN 'FEMENINO'
    END AS SEXO,
    PAC.IPPRIAPEL AS 'PRIMER APELLIDO',
    PAC.IPSEGAPEL AS 'SEGUNDO APELLIDO',
    PAC.IPPRINOMB AS 'PRIMER NOMBRE',
    PAC.IPSEGNOMB AS 'SEGUNDO NOMBRE',
    PAC.IPNOMCOMP AS [NOMBRE PACIENTE],
    DEP.depcodigo AS [CODIGO DEPARTAMENTO],
    DEP.nomdepart AS [NOMBRE DEPARTAMENTO RESIDENCIA],
    PAC.IPDIRECCI AS [DIRECCION],
    MUN.MUNCODIGO [CODIGO MUNICIPIO RESIDENCIA],
    MUN.MUNNOMBRE AS [NOMBRE MUNICIPIO RESIDENCIA],
    CAST(PAC.IPFECNACI AS DATE) AS [FECHA NACIMIENTO],
    PAC.IPTELEFON AS [TELEFONO FIJO],
    PAC.IPTELMOVI AS [TELEFONO MOVIL],
    RTRIM(EA.Code) [COD. ADMINISTRADORA],
    EA.Name AS [ENTIDAD ADMINISTRADORA],
    CASE
        EA.EntityType
        WHEN 1 THEN 'EPS Contributivo'
        WHEN 2 THEN 'EPS Subsidiado'
        WHEN 3 THEN 'ET Vinculados Municipios'
        WHEN 4 THEN 'ET Vinculados Departamentos'
        WHEN 5 THEN 'ARL Riesgos Laborales'
        WHEN 6 THEN 'MP Medicina Prepagada'
        WHEN 7 THEN 'IPS Privada'
        WHEN 8 THEN 'IPS Publica'
        WHEN 9 THEN 'Regimen Especial'
        WHEN 10 THEN 'Accidentes de transito'
        WHEN 11 THEN 'Fosyga'
        WHEN 12 THEN 'Otros'
    END AS [REGIMEN],
    CASE
        GA.LiquidationType
        WHEN 1 THEN 'PAGO POR SERVICIOS'
        WHEN 2 THEN 'PGP'
        WHEN 3 THEN 'FACTURA GLOBAL'
        WHEN 4 THEN 'CAPITACION GLOBAL'
        WHEN 5 THEN 'CONTROL'
    END [TIPO CONTRATO],
    CASE
        PR.ORIGENQX
        WHEN 1 THEN 'ORIGEN AMBULATORIO'
        ELSE 'ORIGEN HOSPITALARIO'
    END AS AMBITO,
    CASE
        ORD.PRISERIPS
        WHEN 1 THEN 'Emergencia'
        WHEN 2 THEN 'Urgencia'
        WHEN 3 THEN 'Normal'
        WHEN 4 THEN 'Definir Conducta'
        ELSE 'Normal'
    END [PRIORIDAD],
    QX.NUMINGRES AS NUMERO_INGRESO,
    QX.NUMEFOLIO AS [NUMERO DE FOLIO],
    PR.IDAGENDA AS [ID AGENDA],
    PR.CODSERIPS CODIGO_CUPS_PROGRAMADO,
    C.Description [CUPS PROCEDIMIENTO_PROGRAMADO],
    PR.PRINCIPAL,
    QX.DESPROCED AS [DESCRIPCION DEL PROCEDIMIENTO],
    GRU.Grupoqx AS [GRUPO QX],
    ORD.FECORDMED [FECHA ORDEN],
    PR.FECREGSIS [FECHA SOLICITADA],
    PR.FECHORAIN AS [FECHA_DE_PROGRAMACIÓN],
    E_P.DESESPECI [ESPECIALIDAD PROGRAMADA],
    P_P.NOMMEDICO [PROFESIONAL PROGRAMADO],
    QX.SALACIRUG SALA_INFORMEQX,
    CASE
        WHEN QX.CODSERIPS IS NULL THEN 'NO REALIZADA'
        WHEN QX.CODSERIPS IS NOT NULL THEN 'REALIZADA'
        WHEN CODESTPQX = 6 THEN 'ANULADA'
    END [ESTADO PROGRAMACION],
    QX.FECHORINI AS [FECHA INICIO CIRUGIA],
    QX.FECHORFIN AS [FECHA FINAL CIRUGIA],
    DATEDIFF(HOUR, PR.FECHORAIN, QX.FECHORINI) RETRASO_EN_HORAS,
    DATEDIFF(MINUTE, QX.FECHORINI, QX.FECHORFIN) AS [DURACION EN MINUTOS],
    ISNULL(
        SAL.DESCRIPSAL,
        CONVERT(VARCHAR(MAX), QX.SALACIRUG)
    ) AS [NUMERO DE SALA],
    DIG1.NOMDIAGNO AS [DIAGNOSTICO PRE OPERATORIO],
    DIG2.NOMDIAGNO AS [DIAGNOSTICO POS OPERATORIO],
    RTRIM(LTRIM(PRO.CODPROSAL)) + ' - ' + RTRIM(PRO.NOMMEDICO) AS [CIRUJANO_PRINCIPAL_REALIZA],
    INE.CODESPECI AS [CODIGO ESPECIALIDAD REALIZA],
    INE.DESESPECI AS [ESPECIALIDAD CIRUJANO REALIZA],
    CASE
        QX.TIPHERCIR
        WHEN 1 THEN 'LIMPIA'
        WHEN 2 THEN 'LIMPIA CONTAMINADA'
        WHEN 3 THEN 'CONTAMINADA'
        WHEN 4 THEN 'SUCIA E INFECTADA'
        WHEN 5 THEN 'SUCIA'
        WHEN 6 THEN 'INFECTADA'
        WHEN 7 THEN 'NO APLICA'
    END AS TIPO_HERIDA,
    CASE
        QX.TIPOANEST
        WHEN 1 THEN 'LOCAL'
        WHEN 2 THEN 'REGIONAL'
        WHEN 3 THEN 'GENERAL'
        WHEN 4 THEN 'COMBINADA'
        WHEN 5 THEN 'NO APLICA'
        WHEN 6 THEN 'RAQUIDEA'
        WHEN 7 THEN 'PERIDUDRAL'
        WHEN 8 THEN 'CAUDAL'
        WHEN 9 THEN 'SEDACION'
    END as [TIPO DE ANESTECIA],
    ANE.HORINIANES AS [FECHA INICIO ANESTESIA],
    ANE.HORFINANES AS [FECHA FIN ANESTESIA],
    DATEDIFF(MINUTE, ANE.HORINIANES, ANE.HORFINANES) AS [DURACION MINUTOS ANESTESIA],
    ANE.MEDICO AS ANESTESIOLOGO,
    PR.FECHACAN as [FECHA CANCELACION],
    CAN.DESCAUCAN AS [CAUSA DE CANCELACION],
    PR.OBSERCAN AS [DESCRIPCION DE CANCELACION],
    DATEDIFF(DAY, PR.FECREGSIS, PR.FECHORAIN) AS [SOLICITUD VS PROGRAMACION DIAS],
    1 as 'CANTIDAD',
    CONVERT(date, PR.FECHORAIN, 34) AS 'FECHA BUSQUEDA',
    YEAR(PR.FECHORAIN) AS 'AÑO BUSQUEDA',
    MONTH(PR.FECHORAIN) AS 'MES BUSQUEDA',
    CONCAT(
        FORMAT(MONTH(QX.FECHORINI), '00'),
        ' - ',
        CASE
            MONTH(QX.FECHORINI)
            WHEN 1 THEN 'ENERO'
            WHEN 2 THEN 'FEBRERO'
            WHEN 3 THEN 'MARZO'
            WHEN 4 THEN 'ABRIL'
            WHEN 5 THEN 'MAYO'
            WHEN 6 THEN 'JUNIO'
            WHEN 7 THEN 'JULIO'
            WHEN 8 THEN 'AGOSTO'
            WHEN 9 THEN 'SEPTIEMBRE'
            WHEN 10 THEN 'OCTUBRE'
            WHEN 11 THEN 'NOVIEMBRE'
            WHEN 12 THEN 'DICIEMBRE'
        END
    ) 'MES NOMBRE BUSQUEDA',
    CONVERT(
        DATETIME,
        GETDATE() AT TIME ZONE 'Pakistan Standard Time',
        1
    ) AS ULT_ACTUAL
FROM INDIGO036.dbo.AGEPROGQX PR
    LEFT JOIN INDIGO036.dbo.HCQXINFOR QX ON QX.IPCODPACI = PR.IPCODPACI
        AND CONVERT(DATE, QX.FECHORINI, 34) = CONVERT(DATE, PR.FECHORAIN, 34)
    LEFT JOIN INDIGO036.dbo.INPACIENT PAC ON PR.IPCODPACI = PAC.IPCODPACI
    LEFT JOIN INDIGO036.dbo.INUBICACI AS UBI ON PAC.AUUBICACI = UBI.AUUBICACI
    LEFT JOIN INDIGO036.dbo.INMUNICIP AS MUN ON UBI.DEPMUNCOD = MUN.DEPMUNCOD
    LEFT JOIN INDIGO036.dbo.INDEPARTA AS DEP ON DEP.depcodigo = MUN.DEPCODIGO
    LEFT JOIN INDIGO036.Contract.CareGroup AS GA ON GA.Id = PAC.GENCAREGROUP
    LEFT JOIN INDIGO036.Contract.HealthAdministrator EA ON PAC.CODENTIDA = EA.Code
    LEFT JOIN INDIGO036.dbo.INDIAGNOS DIG1 ON DIG1.CODDIAGNO = QX.CODDIAPRE
    LEFT JOIN INDIGO036.dbo.INDIAGNOS DIG2 ON DIG2.CODDIAGNO = QX.CODDIAPOS
    LEFT JOIN INDIGO036.dbo.INPROFSAL PRO ON PRO.CODPROSAL = QX.CODPROSAL
    LEFT JOIN INDIGO036.dbo.INESPECIA INE ON PRO.CODESPEC1 = INE.CODESPECI
    LEFT JOIN CTE_ANESTESIA ANE ON QX.NUMINGRES = ANE.NUMINGRES
        AND CONVERT(DATE, QX.FECHORINI, 34) = CONVERT(DATE, ANE.HORINIANES, 34)
    LEFT JOIN INDIGO036.dbo.AGCACANQX CAN ON PR.CODCAUCAN = CAN.CODCACANQ
    LEFT JOIN INDIGO036.Report.GruposQX GRU ON QX.CODSERIPS = GRU.Code
    LEFT JOIN INDIGO036.dbo.AGENSALAC SAL ON PR.AGENSALAC = SAL.CODCONCEC
    LEFT JOIN INDIGO036.Contract.CUPSEntity C ON PR.CODSERIPS = C.Code
    LEFT JOIN INDIGO036.dbo.INPROFSAL P_P ON PR.CODPROSAL = P_P.CODPROSAL
    LEFT JOIN INDIGO036.dbo.INESPECIA E_P ON PR.CODESPECI = E_P.CODESPECI
    LEFT JOIN INDIGO036.dbo.HCORDPROQ ORD ON PR.AUTOHCORDPROQ = ORD.AUTO
    LEFT JOIN INDIGO036.dbo.INUNIFUNC UFN ON ORD.UFUCODIGO = UFN.UFUCODIGO
GROUP BY
    PAC.IPTIPODOC,
    PR.IPCODPACI,
    IPSEXOPAC,
    PAC.IPPRIAPEL,
    PAC.IPSEGAPEL,
    PAC.IPPRINOMB,
    PAC.IPSEGNOMB,
    PAC.IPNOMCOMP,
    DEP.depcodigo,
    DEP.nomdepart,
    PAC.IPDIRECCI,
    MUN.MUNCODIGO,
    MUN.MUNNOMBRE,
    PAC.IPFECNACI,
    PAC.IPTELEFON,
    PAC.IPTELMOVI,
    EA.Code,
    EA.Name,
    EA.EntityType,
    GA.LiquidationType,
    PR.ORIGENQX,
    QX.NUMINGRES,
    QX.NUMEFOLIO,
    PR.IDAGENDA,
    QX.DESPROCED,
    GRU.Grupoqx,
    PR.FECREGSIS,
    PR.FECHORAIN,
    SAL.DESCRIPSAL,
    QX.SALACIRUG,
    PR.CODESTPQX,
    QX.FECHORINI,
    QX.FECHORFIN,
    SAL.DESCRIPSAL,
    QX.SALACIRUG,
    DIG1.NOMDIAGNO,
    DIG2.NOMDIAGNO,
    PRO.CODPROSAL,
    INE.DESESPECI,
    QX.TIPHERCIR,
    QX.TIPOANEST,
    ANE.HORINIANES,
    ANE.HORFINANES,
    ANE.MEDICO,
    PR.FECHACAN,
    CAN.DESCAUCAN,
    PR.OBSERCAN,
    PR.FECREGSIS,
    PR.FECHORAIN,
    PR.CODSERIPS,
    C.Description,
    PR.FECHORAFI,
    PRO.NOMMEDICO,
    INE.CODESPECI,
    UFN.UFUDESCRI,
    PR.PRINCIPAL,
    QX.CODSERIPS,
    E_P.DESESPECI,
    P_P.NOMMEDICO,
    ORD.PRISERIPS,
    ORD.NUMINGRES,
    ORD.FECORDMED
-- Workspace: HOMI
-- Item: DataWareHouse_Clinical [Warehouse]
-- ItemId: 9e4ad354-8031-4a13-8643-33b3234761ff
-- Schema: Report
-- Object: SP_INV_GESTION_MIPRES_ACTIVOS
-- Extracted by Fabric SQL Extractor SPN v3.9.0

CREATE PROCEDURE Report.SP_INV_GESTION_MIPRES_ACTIVOS 
AS

WITH 
CTE_MEDICAMENTOS AS
(
  SELECT 
     IHL.CODPRODUC,
     IHL.DESPRODUC,
     CASE IHL.NOPOSPROD WHEN 0 THEN 'SI' ELSE 'NO' END AS PBS,
     CASE ATC.UNIRS WHEN 1 THEN 'SI' ELSE 'NO' END AS UNIRS
  FROM [INDIGO036].[dbo].[IHLISTPRO] AS IHL
    INNER JOIN [INDIGO036].[Inventory].[ATC] AS ATC
       ON ATC.Code = IHL.CODPRODUC
  WHERE IHL.CODPRODUC IN (
    '1102010018','1103060008','1103230010','1103230014','1103230017','1103230018','1103230022','1103230024','1103230025',
    '1103230027','1103230028','1103230029','1103230030','1103230031','1103230032','1103230033','1103230034','1103240020','1103240030','1103250010',
    '1105030002','1105030003','1105030004','1105030006','1105030007','1105120012','1105120013','1105120030','1105120031','1105120032','1105120033',
    '1105120036','1105120038','1105120053','1105120055','1105120056','1105120066','1105120071','1105120073','1105120075','1105120077','1105120082',
    '1105120083','1105120090','1105120107','1105120111','1109020007','1112010105','1112010135','1112010168','1112010170','1115010019','1115020002',
    '1115020004','1115020007','1115020010','1115020012','1115040007','1117010003','1118040020','1118080088','1118080095','1118080112','1118090003',
    '1118090014','1119010024','1120020010','1120020017','1120020018','1120020023','1120020024','1120020037','1120030002','1120030005','1120030007',
    '1120050011','1120050021','1120050023','1120050025','1121140050','1121140051','1121140057','2601020007','2601040002','2601040003','2602010006',
    '2602010010','2602010013','2602010014','2602010015','2602010017','2602010019','2602020005','2602020007','2602020009','2602020013','2602020014',
    '2602020018','2602020019','2602020022','2602020025','2602020026','2602020031','2602020028-1','2602020035','1119010014','1119060023','1118040009',
    '1105120056','1105120027','1120020038','1120020005-1','1120050014','1120050029', '1120020005', '2602020034','2602020037','1105120064','1105120045',
    '2602020039','1105120075','2602010021','2602010020'
  )
),
CTE_INGRESOS_UNICOS AS
(
  SELECT
     ING.IPCODPACI,
     ING.NUMINGRES,
     ING.GENCONENTITY,
     ING.IESTADOIN,
     ING.IFECHAING,
     ING.FECHEGRESO
  FROM [INDIGO036].[dbo].[ADINGRESO] AS ING
  WHERE ING.TIPOINGRE = 2 AND ING.IESTADOIN NOT IN ('F','A','C')
), 
CTE_AUTORIZACIONES AS
(
  SELECT
    AU.NUMINGRES,
    AU.CODSERIPS,
    SUM(AU.CANSERAUT) AS CANSERAUT
  FROM
    [INDIGO036].[dbo].[ADAUTSERD] AU
    INNER JOIN CTE_MEDICAMENTOS MED ON AU.CODSERIPS = MED.CODPRODUC
  WHERE AU.ESTATUSER = 1
  GROUP BY AU.NUMINGRES, AU.CODSERIPS
),
CTE_DISPENSACION AS
(
  SELECT
    D.CODPRODUC,
    D.NUMINGRES,
    SUM(DISD.Quantity) AS CANTIDAD
  FROM
    [INDIGO036].[dbo].[HCFARMEPD] D
    INNER JOIN [INDIGO036].[Inventory].[PharmaceuticalDispensingDetail] DISD ON D.ID = DISD.EntityId AND DISD.EntityName = 'HCFARMEPD'
    INNER JOIN CTE_MEDICAMENTOS MED ON D.CODPRODUC = MED.CODPRODUC
  WHERE D.SourceTable = 'HCPRESCRA'
  GROUP BY D.CODPRODUC, D.NUMINGRES
),
CTE_ORDENAMIENTO AS
(
  SELECT 
    PRES.NUMINGRES,
    PRES.CODPRODUC,
    MED.PBS,
    MED.UNIRS,
    MED.DESPRODUC,
    MAX(PRES.NUMEFOLIO) AS NUMEFOLIO,
    SUM(PRES.CANPEDPRO) AS CANPEDPRO
  FROM
    [INDIGO036].[dbo].[HCPRESCRA] PRES
    INNER JOIN CTE_MEDICAMENTOS MED ON PRES.CODPRODUC = MED.CODPRODUC
  GROUP BY PRES.NUMINGRES, PRES.CODPRODUC, MED.PBS, MED.UNIRS, MED.DESPRODUC
),
CTE_JUSTIFICACION AS
(
  SELECT
    PB.NUMINGRES,
    PB.CODPRODUC,
    JUS.CODMINSALUD,
    SUM(PB.CANPEDPRO) AS CANPEDPRO
  FROM
    CTE_MEDICAMENTOS MED
    INNER JOIN [INDIGO036].[dbo].[HCJUNOPOM] PB ON MED.CODPRODUC = PB.CODPRODUC
    INNER JOIN CTE_INGRESOS_UNICOS ING ON PB.NUMINGRES = ING.NUMINGRES
    LEFT JOIN (
      SELECT MAX(B.NUMEFOLIO) AS NUMEFOLIO, B.NUMINGRES, B.CODPRODUC, B.CODMINSALUD
      FROM [INDIGO036].[dbo].[HCJUNOPOM] B
        INNER JOIN (
          SELECT A.NUMINGRES, A.CODPRODUC, MAX(A.CODCONCEC) AS CODCONCEC
          FROM [INDIGO036].[dbo].[HCJUNOPOM] A
          GROUP BY A.NUMINGRES, A.CODPRODUC
        ) C ON B.CODCONCEC = C.CODCONCEC
      GROUP BY B.NUMINGRES, B.CODPRODUC, B.CODMINSALUD
    ) JUS ON PB.NUMINGRES = JUS.NUMINGRES AND PB.CODPRODUC = JUS.CODPRODUC
  GROUP BY PB.NUMINGRES, PB.CODPRODUC, JUS.CODMINSALUD
)

SELECT 
  HA.Name AS [ENTIDAD],
  TDOC.SIGLA,
  PAC.IPCODPACI AS [IDENTIFICACION],
  PAC.IPNOMCOMP AS [NOMBRE PACIENTE],
  PRES.NUMINGRES AS INGRESO,
  PRES.NUMEFOLIO AS [FOLIO ORDEN],
  HC.FECHISPAC AS [FECHA ORDEN],
  PRES.CODPRODUC AS [CODIGO MEDICAMENTO SOLICITADO],
  PRES.DESPRODUC AS [MEDICAMENTO SOLICITADO],
  PRES.CANPEDPRO AS [CANTIDAD SOLICITADO],
  PB.CANPEDPRO AS [CANTIDAD NO PBS],
  PB.CODMINSALUD AS [CODIGO MIPRES],
  AU.CANSERAUT AS [CANTIDAD AUTORIZADO],
  CASE WHEN AU.CANSERAUT IS NULL THEN NULL ELSE 'AUTORIZADO' END AS [ESTADO AUTORIZADO],
  ISNULL(DIS.CANTIDAD,0) AS [CANTIDAD DISPENSADA],
  ING.IESTADOIN AS [ESTADO INGRESO],
  ISNULL(AU.CANSERAUT,0) - ISNULL(DIS.CANTIDAD,0) AS [CANTIDAD AUTORIZADA VS DISPENSADA],
  ISNULL(PRES.CANPEDPRO,0) - ISNULL(DIS.CANTIDAD,0) AS [CANTIDAD SOICITADA VS DISPENSADA],
  PRES.PBS,
  PRES.UNIRS,
  FUN.UFUDESCRI AS [UNIDAD FUNCIONAL],
  ING.IFECHAING AS [FECHA INGRESO],
  ING.FECHEGRESO AS [FECHA EGRESO]
FROM
  CTE_ORDENAMIENTO PRES
  INNER JOIN CTE_INGRESOS_UNICOS ING ON PRES.NUMINGRES = ING.NUMINGRES
  INNER JOIN INDIGO036.Contract.HealthAdministrator HA ON ING.GENCONENTITY = HA.Id
  INNER JOIN [INDIGO036].[dbo].[INPACIENT] PAC ON ING.IPCODPACI = PAC.IPCODPACI
  INNER JOIN [INDIGO036].[dbo].[ADTIPOIDENTIFICA] TDOC ON PAC.IPTIPODOC = TDOC.CODIGO
  INNER JOIN [INDIGO036].[dbo].[HCHISPACA] HC ON PRES.NUMINGRES = HC.NUMINGRES AND PRES.NUMEFOLIO = HC.NUMEFOLIO
  INNER JOIN [INDIGO036].[dbo].[INUNIFUNC] FUN ON HC.UFUCODIGO = FUN.UFUCODIGO
  LEFT JOIN CTE_AUTORIZACIONES AU ON PRES.NUMINGRES = AU.NUMINGRES AND PRES.CODPRODUC = AU.CODSERIPS
  LEFT JOIN CTE_JUSTIFICACION PB ON PRES.NUMINGRES = PB.NUMINGRES AND PRES.CODPRODUC = PB.CODPRODUC
  LEFT JOIN CTE_DISPENSACION DIS ON PRES.NUMINGRES = DIS.NUMINGRES AND DIS.CODPRODUC = PRES.CODPRODUC